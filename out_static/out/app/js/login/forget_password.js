"use strict";define(function(require){var app=require("app");require("common/services/server");app.controller("GetPasswordCtrl",["$scope","$state","http","utils","config","$timeout",function($scope,$state,http,utils,config,$timeout){var vm=$scope.vm={};angular.extend(vm,{init:function(){vm.sendcode=!0,vm.time=!1,vm.repeatsend=!1,vm.count=60},validateMobile:function(){if(vm.mobile){var reg=/^1[34578]\d{9}$/;reg.test(vm.mobile)?vm.error_mobile="":vm.error_mobile="手机号码有误!"}else vm.error_mobile="请输入手机号"},changeType:function(){vm.numType=!vm.numType},validateCode:function(){if(console.log("vm.verifycode",vm.verifycode),console.log("vm.mobile",vm.mobile),vm.verifycode){var reg=/^\d{6}$/;if(reg.test(vm.verifycode)){var url=config.getAdminAPI("validatecode");http(url,{method:"post",data:{code:vm.verifycode,type:"reset_password",mobile:vm.mobile}}).then(function(resp){0==resp.error_code&&(console.log("resp.result",resp.result),1==resp.result.valid?(vm.verifysuccess=!0,vm.error_verifycode="",vm.sendcode=!1,vm.repeatsend=!1,vm.time=!1):(vm.error_verifycode="无效验证码",vm.verifysuccess=!1,vm.time||(vm.sendcode=!0)))})}else vm.error_verifycode="验证码错误",vm.verifysuccess=!1,vm.time||(vm.sendcode=!0)}else vm.error_verifycode="请输入验证码",vm.verifysuccess=!1,vm.time||(vm.sendcode=!0)},validatePassword:function(){if(vm.password){var reg=/(?![^a-zA-Z]+$)(?!\D+$).[^\s]{5,17}$/;reg.test(vm.password)?vm.error_password="":vm.error_password="密码由6-18位英文和数字组成"}else vm.error_password="请输入密码"},validateRepeatPsd:function(){vm.repeatpassword?vm.repeatpassword!=vm.password?vm.error_repeatpassword="两次输入密码不一致":vm.error_repeatpassword="":vm.error_repeatpassword="请输入确认密码"},sendVerifyCode:function(){if(!vm.mobile)return void(vm.error_mobile="请输入手机号");var reg=/^1[34578]\d{9}$/;if(!reg.test(vm.mobile))return void(vm.error_mobile="手机号码有误!");vm.sendcode=!1,vm.time=!0,vm.repeatsend=!1;var url=config.getAdminAPI("sendverifycode");http(url,{method:"post",data:{target_type:"mobile",verify_type:"reset_password",target:vm.mobile}}).then(function(resp){"0"===resp.error_code?(vm.countDown(),utils.success("验证码已发送到您的手机",{posId:".login-form",position:"top center"}).then(function(){})):(vm.time=!1,vm.sendcode=!0)})},countDown:function(){0==vm.count?(vm.count=60,vm.sendcode=!1,vm.time=!1,vm.repeatsend=!0):(vm.count--,vm.count<0&&(vm.count=0),$timeout(function(){vm.countDown()},1e3))},validateForm:function(){vm.validateMobile(),vm.validatePassword(),vm.validateRepeatPsd()},resetPassword:function(){vm.validateForm();var bool=!(vm.error_mobile||vm.error_verifycode||vm.error_password||vm.error_repeatpassword);if(bool){vm.loading=!1;var url=config.getAdminAPI("setnewpassword");http(url,{method:"put",data:{source_type:"mobile",source:vm.mobile,verify_code:vm.verifycode,password:vm.password}}).then(function(resp){"0"===resp.error_code&&utils.success("密码设置成功，请重新登录",{posId:".login-form",position:"top center"}).then(function(){vm.loading="complete"})})["catch"](function(reject){vm.loading="complete"})}}}),vm.init()}])});