"use strict";define(function(require){require("common/directives/pager-redirect");var app=require("app");app.controller("QuoteModelModalCtrl",["$scope","$mdDialog","config","http","params","utils",function($scope,$mdDialog,config,http,params,utils){var vm=$scope.vm={};angular.extend(vm,{utils:utils,categoryCache:[],isQuoteEshop:params.isQuoteEshop||!1,init:function(){console.log("引用模态框打开的数据",params);var current_modelId=params.modelId;vm.selectRecordlList=params.selectRecordlList,vm.widget=params.widget,this.getContentcategoryData(),this.initListdata(current_modelId),this.watchCategoryCache(),this.watchCurrentPage()},initListdata:function(current_modelId){this.setModelId(current_modelId),this.initParams(current_modelId),this.getListData()},initParams:function(){vm.node_id="",vm.keywords="",vm.pagination&&(vm.pagination.currentPage=1),vm.currentid=vm.currentmodelId},setModelId:function(modelId){vm.currentmodelId=modelId||0,vm.currentModel=vm.currentmodelId},_getCurrentModel:function(modelid){angular.forEach(vm.modelList,function(model,i){model.id===modelid&&(vm.currentModelModel=model)})},_getEshopModel:function(){var tempArr=[];angular.forEach(vm.modelList,function(model,i){tempArr.push(model)}),vm.categoryCache.push(tempArr)},getContentcategoryData:function(current_modelId){var diymodel_url=config.getAPI("diymodel");vm.isQuoteEshop&&(diymodel_url=config.getAPI("pagedesign.getmodellist"),diymodel_url+="?scope=ecommerce"),console.log("获取分类数据url",diymodel_url),http(diymodel_url).then(function(data){console.log("获取分类数据",data),data.error?utils.error(data.error.message):(vm.modelList=vm.isQuoteEshop?data.result:data.user_models,vm.isQuoteEshop?vm._getEshopModel():(vm._getCurrentModel(vm.currentModel),console.log(vm.currentModel,vm.currentModelModel,"+++++"),vm.categoryCache.push([vm.currentModelModel]))),vm.categoryloading="complete"})["catch"](function(reject){vm.categoryloading="complete"})},showNextCategory:function(index,model){var _this=this;vm.categoryloading=!1,this.getModelId(model);var url=config.getAPI("nodechildren"),parent_id=model.model_id?model.id:0;url=url.replace("{model_id}",vm.currentmodelId).replace("{parent_id}",parent_id),http(url).then(function(data){data.error?utils.error(data.error.message):(vm.categoryCache.push(data.nodes),data.nodes.length&&_this.selectnode(data.nodes[0])),vm.categoryloading="complete"})["catch"](function(reject){vm.categoryloading="complete"})},getModelId:function(node){vm.currentmodelId=node.model_id?node.model_id:node.id,vm.currentModel=vm.currentmodelId,this._getCurrentModel(vm.currentModel)},selectnode:function(node){vm.currentid=node.id,vm.node_id=node.model_id?node.id:0,vm.currentNode=node,this.getModelId(node),this.getListData()},getListData:function(){var _this=this;this.initlistnav(function(navdata){_this.ajaxListData(navdata)})},initlistnav:function(callback){var url=config.getAPI("listnav");return url=url.replace("{model_id}",vm.currentmodelId),http(url).then(function(data){angular.isFunction(callback)&&callback(data)})},watchCategoryCache:function(){$scope.$watch("vm.categoryCache",function(newVal){var length=vm.categoryCache.length,margin=(110*vm.categoryCache.length+10,length>1?-110*(vm.categoryCache.length-1):0);vm.sortStyle={"margin-left":margin+"px"}},!0)},delCache:function(node){vm.categoryCache.pop();var parent_node=this.findParent(node[0]);this.selectnode(parent_node)},findParent:function(options){var len=vm.categoryCache.length,parent_arr=vm.categoryCache[len-1],origin_obj={};return angular.forEach(parent_arr,function(value){options.parent_id&&options.parent_id==value.id?origin_obj=value:options.model_id==value.id&&(origin_obj=value)}),origin_obj},ajaxListData:function(navdata){var _this=this,url=config.getAPI("contentlist"),params=this.collectListParam();config.picConfig.list_indexpic;vm.loading=!1,http(url,{params:params}).then(function(data){vm.listdata=data.data,vm.filterSelectedData(),data.meta&&_this.initPagination(data.meta.pagination),vm.loading="complete",vm.categoryloading="complete"})["catch"](function(reject){vm.loading="complete"})},filterSelectedData:function(){var ids=[];ids=D.pluck(vm.selectRecordlList,"id"),vm.listdata=D.map(vm.listdata,function(v){return D.contains(ids,v.id)&&(v.isCheck=!0),v})},collectListParam:function(){var params={model_id:vm.currentmodelId,node_id:vm.node_id,keywords:vm.keywords,count:10};return vm.pagination&&vm.pagination.currentPage&&(params.page=vm.pagination.currentPage,params.count=10),params},initPagination:function(options){vm.pagination=vm.pagination||{},vm.paginationLoading="complete",angular.extend(vm.pagination,{totalItems:options.total,numPages:options.total_pages,itemsPerPage:options.per_page,maxSize:options.total_pages,currentPage:options.current_page,countconfig:config.listcount,pagecount:options.per_page})},watchCurrentPage:function(){var _this=this;$scope.$watch("vm.pagination.currentPage",function(currentpage,old){currentpage&&old&&(vm.paginationLoading=!1,_this.getListData())}),$scope.$watch("vm.pagination.pagecount",function(currentpagecount,old){currentpagecount&&old&&(vm.paginationLoading=!1,_this.getListData())})},check:function(index){return"refer_model"==vm.widget&&vm.selectRecordlList.length>=1&&!vm.listdata[index].isCheck?void utils.error("该模型只能引用一条内容!"):(vm.listdata[index].isCheck=!vm.listdata[index].isCheck,void(vm.listdata[index].isCheck?this.addItem(vm.listdata[index]):this.delItem(vm.listdata[index])))},addItem:function(item){var bool=!1;angular.forEach(vm.selectRecordlList,function(record,key){record.id==item.id&&(bool=!0)}),bool||vm.selectRecordlList.push(item)},delItem:function(item){var index=-1;angular.forEach(vm.selectRecordlList,function(record,key){record.id==item.id&&(index=key)}),index!=-1&&vm.selectRecordlList.splice(index,1)},isEnter:function(event){13==event.keyCode&&this.searchListData()},searchListData:function(){this.getListData()},save:function(){$mdDialog.hide({selectRecordlList:vm.selectRecordlList})}}),vm.init()}])});
