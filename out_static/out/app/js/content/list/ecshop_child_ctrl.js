"use strict";define(function(require){var app=require("app");require("common/directives/datetimepicker");var moment=require("moment");app.controller("EcshopChildCtrl",["$scope","$state","http","config","utils","$stateParams","$q","$timeout",function($scope,$state,http,config,utils,$stateParams,$q,$timeout){var vm=$scope.vm={};angular.extend(vm,{init:function(params){this.ecshopFields=params.fields,this.ecshopData=params.data,this.isInit=!0,this.is_virtual=params.is_virtual,$q.all([vm.getDeliveryTemplate()]).then(function(){$stateParams.id?vm.initEdit(vm.ecshopData):(vm.ecshopData.is_listing=!0,vm.ecshopData.buy_quota=0,vm.ecshopData.unit_price={now:"",origin:""},vm.is_virtual?vm.auto_send=!0:(vm.ecshopData.post_fee=0,vm.ecshopData.post_type=1,vm.initTemplate(vm.ecshopData)),vm.initListing(vm.ecshopData))})},moneytypeList:["¥"],templateListCache:{},initEdit:function(data){this.initTemplate(data),this.initListing(data),this.is_virtual&&(vm.auto_send=!!data.auto_send)},initTemplate:function(data){1==data.post_type&&0==data.post_fee?vm.posttype=0:1==data.post_type&&0!=data.post_fee?(vm.posttype=1,vm.current_template_price=1*data.post_fee):vm.posttype=2},initListing:function(data){Date.parse(new Date);data.is_listing?vm.listingtype=0:data.auto_listing_time?(vm.listingtype=1,vm.auto_listing_time=vm.timestamp_trans(data.auto_listing_time)):vm.listingtype=2},getDeliveryTemplate:function(){var defer=$q.defer(),url=config.getAPI("templateslist");return http(url).then(function(data){vm.templateList=data.data,angular.forEach(vm.templateList,function(temp){vm.templateListCache[temp.id]=temp}),defer.resolve(data.data)})["catch"](function(){defer.resolve([])}),defer.promise},changePostType:function(flag){vm.posttype=flag,vm.changeTemplate()},changeListType:function(flag){vm.listingtype=flag,vm.changeListing()},changeFreight:function(post){vm.changeTemplate(post.id)},changeTemplate:function(tempId){vm.ecshopData&&(vm.ecshopData.post_type="",vm.ecshopData.delivery_template_id=tempId,0===vm.posttype?(vm.ecshopData.post_type=1,vm.ecshopData.post_fee=0):1===vm.posttype?vm.ecshopData.post_type=1:2===vm.posttype&&(vm.ecshopData.post_type=2,vm.ecshopData.post_fee=0))},changeListing:function(){vm.ecshopData&&(vm.ecshopData.is_listing="",0===vm.listingtype?(vm.ecshopData.is_listing=!0,vm.ecshopData.auto_listing_time=vm.timestamp_trans(vm.Date_trans(new Date))):1===vm.listingtype?(vm.ecshopData.is_listing=!1,vm.ecshopData.auto_listing_time=vm.ecshopData.auto_listing_time):(vm.ecshopData.is_listing=!1,vm.ecshopData.auto_listing_time=""),console.log("监听定时开售选项",vm.ecshopData.is_listing,vm.ecshopData.auto_listing_time))},timestamp_trans:function(timestamp){return moment.unix(timestamp).format("YYYY-MM-DD HH:mm:ss")},Date_trans:function(data){return moment(data).unix()},check:function(data,fields){if(vm.isCheck=!0,data.buy_quota=data.buy_quota?+data.buy_quota:0,data.unit_price?"":data.unit_price={},data.unit_price.origin=data.unit_price.origin?+data.unit_price.origin:"",data.unit_price.now=data.unit_price.now?+data.unit_price.now:"",data.is_listing=!!data.is_listing,vm.is_virtual)data.auto_send=vm.auto_send;else{if(data.post_fee=+data.post_fee,2==data.post_type&&!data.delivery_template_id)return utils.error("请选择运费模版！"),void(vm.isCheck=!1);if(data.delivery_template_id=data.delivery_template_id,null==data.post_type)return utils.error("请选择运费类型！"),void(vm.isCheck=!1)}return data.unit_price.now?(data.num=data.num?+data.num:0,data.skus=vm.formatSku(data,fields),void(data.sold_num=data.sold_num?+data.sold_num:0)):(utils.error("请填写一口价！"),void(vm.isCheck=!1))},formatSku:function(data,fields){var skus=[];return angular.forEach(data.skus,function(val){if(val.properties_name_list.length&&(angular.forEach(val.properties_name_list,function(properties,key){""===properties.v&&val.properties_name_list.splice(key,1)}),val.image||angular.forEach(fields,function(field,i){"indexpic"===field.key&&(val.image=field.value.material?field.value.material:field.value,val.image.url&&delete val.image.url)}),skus.push(val),!val.price))return utils.error("请填写sku价格！"),void(vm.isCheck=!1)}),skus.length?skus:null}}),$scope.$on("InitEcshopChild",function(event,params){vm.init(params)}),$scope.$on("getEcshopData",function(event,params){vm.check(vm.ecshopData,params.fields),angular.extend(params.data.field,vm.ecshopData),vm.isCheck&&$timeout(function(){$scope.$emit(params.flag,params)},0)})}])});
