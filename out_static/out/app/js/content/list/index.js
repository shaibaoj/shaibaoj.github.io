"use strict";define(function(require){var app=require("app"),server=require("common/services/server");require("common/directives/pager-redirect"),require("common/directives/weight"),require("common/directives/status"),require("common/directives/form-select"),require("common/directives/pagination/page1"),require("common/directives/dingdone-sort-select"),require("common/directives/move-category"),require("common/directives/doc-click"),require("common/directives/dingdone-uploadify"),require("../../appmake/services/appMakeService"),require("../../content_copy/modal/contentCopyUnbindModal"),require("../../content_copy/modal/contentCopyBindModal"),require("./services/recordService"),require("common/filters/filters");var Clipboard=require("clipboard");app.controller("ContentlistCtrl",["$rootScope","$scope","$state","$stateParams","http","utils","config","navconfig","record","modelService","appMakeService","$modal","$timeout","RecordService",function($rootScope,$scope,$state,$stateParams,http,utils,config,navconfig,record,modelService,appMakeService,$modal,$timeout,RecordService){var vm=$scope.vm={},clipboard=new Clipboard(".clipbtn");angular.extend(vm,{model_id:$stateParams.model_id||"",node_id:$stateParams.node_id||"",tplSlug:"",createContent:function(model){$rootScope.create_model_table=null,$state.go("secondLayout.contentform",{model_id:model.id})},go_contentform:function(model_id,id){$rootScope.create_model_table=null,$state.go("secondLayout.contentform",{model_id:model_id,id:id})},uploadifyConfig:{auto:!0,buttonText:"视频上传",fileObjName:"media_file"},getCurrnetTpl:function(){var url=config.getAPI("contentModel.bindTplSlug").replace("{model_id}",this.model_id).replace("{node_id}",this.node_id),_this=this;http(url).then(function(json){_this.tplSlug=json.result.tpl_model})},init:function(modellist){vm.modellist=modellist,vm.uploadifyConfig.uploader=config.getAPI("uploadmedia");var _this=this,current_modelId=vm.currentmodelId=$stateParams.model_id;_.pluck($rootScope.contentMenuList.shopmodel,"id").indexOf(current_modelId)!=-1?vm.contentforeshop=!0:vm.contentforeshop=!1,console.log("当前电商模型的ID数组",_.pluck($rootScope.contentMenuList.shopmodel,"id"),vm.contentforeshop),current_modelId?this.initAll(current_modelId):this.initDefaultModel(function(modelid){_this.initAll(modelid)}),this.getCurrentModel(current_modelId),this.getIsSupportSort(current_modelId),modelService.setnavConfig(modellist,function(){}),vm.uploadifyConfig.model_id=current_modelId,vm.getBindList(),vm.checkVersion()},getIsSupportSort:function(currentModelId){var url=config.getAPI("contentModelV3.issupportsort").replace("{model_id}",currentModelId);http(url).then(function(json){vm.issupport=json.result.enable})},getCurrentModel:function(current_modelId){angular.forEach(vm.modellist,function(model,key){model.id==current_modelId&&(vm.currentModel=model)})},initAll:function(current_modelId){this.getContentcategory(current_modelId),this.watchCurrentPage(),this.watchCategoryCache(),this.initListdata(current_modelId),this.getHaveDemo()},initDefaultModel:function(callback){vm.modellist.length&&(vm.currentmodelId=vm.modellist[0].id,callback(vm.currentmodelId))},initParams:function(current_modelId){vm.node_id="",vm.keywords="",vm.pagination&&(vm.pagination.currentPage=1),vm.currentid=vm.currentmodelId},initListdata:function(current_modelId){$rootScope.notAll=!1,this.setModelId(current_modelId),this.initParams(current_modelId),this.getListData()},getListData:function(){var _this=this;this.initlistnav(function(navdata){navdata=navdata.result,_this.ajaxListData(navdata)})},initlistnav:function(callback){var url=config.getAPI("eshoplistnav");return url=url.replace("{model_id}",vm.currentmodelId),http(url).then(function(data){angular.isFunction(callback)&&callback(data)})},handlelistnavdata:function(data){var tmp={},first_key="";angular.forEach(data,function(value,key){first_key=key,"nodes"!=key&&"indexpic"!=key&&"iscomment"!=key&&"pic_num"!=key&&"publish_time"!=key&&(tmp[key]=value)}),tmp.title||(tmp.title==tmp[first_key],delete tmp[first_key]),vm.listnav=tmp},getTpList:function(){vm.getModelTemplate(vm.currentmodelId,function(tplist){vm.tplist=tplist})},ajaxListData:function(navdata){var _this=this,params=this.collectListParam(),config_indexpic=config.picConfig.list_indexpic;vm.loading=!1,RecordService.getRecordList(params).then(function(data){_this.handlelistnavdata(navdata),vm.listdata=data.result.data,_this.cancelAll(),angular.forEach(vm.listdata,function(value,key){value.data&&value.data.indexpic&&(value.data.indexpic=utils.getImgUrl(value.data.indexpic,config_indexpic.width,config_indexpic.height))}),vm.nodata=!vm.listdata.length,data.result.pagemeta&&_this.initPagination(data.result.pagemeta),console.log("data.result.pagemeta ",data.result.pagemeta),vm.loading="complete",vm.categoryloading="complete"})},createLink:function(list){var modelId=list.model_id,recordId=list.id,_this=this;this.getModelData(modelId,recordId,function(record){record.node&&record.node.length>0?_this.getNodeTemplate(modelId,record.node[0].id,function(tplist){var tplid=_this.getTplId(tplist);tplid==-1?_this.getModelTemplate(modelId,function(_tplist){list.url=_this.pingUrl(_tplist,recordId,record.model.slug)}):list.url=_this.pingUrl(tplist,recordId,record.model.slug)}):list.url=_this.pingUrl(vm.tplist,recordId,record.model.slug)})},pingUrl:function(tplist,recordId,slug){var url="dingdone://";if(url+=slug.indexOf("tuji")!=-1?"tuji":slug.indexOf("livmedia")!=-1?"livmedia":slug.indexOf("channel")!=-1?"channel":slug.indexOf("radio")!=-1?"radio":slug.indexOf("vod")!=-1?"vod":slug.indexOf("audio")!=-1?"audio":"news/newsUI1?tpl_model="+this.tplSlug,"ecshop"==server.version)url="dingdone://youzan_product_detail/module?content_id="+recordId;else{var flag=url.indexOf("?")==-1?"?":"&";url=url+flag+"content_id="+recordId}return url},youzanPowers:function(model_id){angular.forEach(vm.modellist,function(modelcontent){"youzan_product"==modelcontent.slug&&modelcontent.id==model_id&&(vm.noadd=!0,vm.nomove=!0,vm.nodelete=!0)})},youzanTipsModel:function(){$modal.open({animateanimation:!0,templateUrl:"content/model/youzanTipsModel.html",size:500})},currentSelected:0,categoryCache:[],check:function(index,id){var isCheck=vm.listdata[index].isCheck;vm.listdata[index].isCheck=!isCheck,vm.currentSelected=isCheck?vm.currentSelected-1:vm.currentSelected+1,vm.currentSelected==vm.listdata.length?vm.isCheckAll=!0:vm.isCheckAll=!1},checkAll:function(){vm.isCheckAll=!vm.isCheckAll,this._select()},cancelAll:function(){vm.isCheckAll=!1,this._select()},_select:function(){angular.forEach(vm.listdata,function(val,key){val.isCheck=vm.isCheckAll}),vm.currentSelected=vm.isCheckAll?vm.listdata.length:0},delList:function(){var ids=[],listIndex=[];vm.isCheckAll?angular.forEach(vm.listdata,function(val){ids.push(val.id)}):(angular.forEach(vm.listdata,function(val,key){val.isCheck&&(ids.push(val.id),listIndex.push(key))}),ids.length||utils.error("请选择要删除的内容"));var idsStr=ids.join();utils.confirm({headTitle:"删除提醒",msg:"确定删除选中的数据吗?"},function(sure){sure&&(vm.loading=!1,RecordService.deleteRecord({id:idsStr,model_id:vm.model_id}).then(function(data){if(data.error)utils.error(data.error.message);else{if(vm.isCheckAll){var current_page=Number(vm.pagination.currentPage),last_page=Number(vm.pagination.numPages);if("number"!=typeof current_page||isNaN(current_page)||current_page<=0)throw new Error("当面分页页数为 非number类型 或NaN 或小于等于0");if("number"!=typeof last_page||isNaN(last_page)||last_page<=0)throw new Error("最大分页页数为 非number类型 或NaN 或小于等于0");current_page===last_page&&(vm.pagination.currentPage=1)}vm.getListData()}vm.loading="complete"})["catch"](function(reject){vm.loading="complete"}))})},initPagination:function(options){vm.pagination=vm.pagination||{},vm.paginationLoading="complete",angular.extend(vm.pagination,{totalItems:options.total,numPages:options.lastPage,itemsPerPage:options.perPage,maxSize:options.total,currentPage:options.currentPage,countconfig:config.listcount,pagecount:options.perPage})},watchCurrentPage:function(){var _this=this;$scope.$watch("vm.pagination.currentPage",function(currentpage,old){currentpage&&old&&(vm.paginationLoading=!1,_this.getListData())}),$scope.$watch("vm.pagination.pagecount",function(currentpagecount,old){currentpagecount&&old&&(vm.paginationLoading=!1,_this.getListData())})},isEnter:function(event){13==event.keyCode&&this.searchListData()},searchListData:function(){this.getListData()},collectListParam:function(){var params={model_id:vm.currentmodelId,node_id:vm.node_id,keywords:vm.keywords};return vm.pagination&&vm.pagination.currentPage&&(params.page=vm.pagination.currentPage,params.count=vm.pagination.pagecount),params},getContentcategoryData:function(current_modelId){config.getAPI("diymodel");vm.modelList=vm.modellist,vm.categoryCache.push(vm.modelList)},getContentcategory:function(current_modelId){var _this=this;config.getAPI("diymodel");vm.modelList=vm.modellist,_this._getCurrentModel(current_modelId),_this.showNextCategory(0,vm.currentModelModel),vm.categoryloading="complete";var version=server.version;"ecshop"==version&&this.youzanPowers(current_modelId)},checkVersion:function(){"normal"==server.version&&(vm.normal=!0)},selectnode:function(node,index){vm.categoryCache.splice(index+1,vm.categoryCache.length-index-1),vm.currentid=node.id,vm.node_id=node.model_id?node.id:0,vm.currentNode=node,this.getModelId(node),this.getListData(),vm.categoryloading=!1,$rootScope.notAll=!0},setModelId:function(modelId){vm.currentmodelId=modelId||0,vm.currentModel=vm.currentmodelId,this._getCurrentModel(vm.currentModel)},getModelId:function(node){vm.currentmodelId=node.model_id?node.model_id:node.id,vm.currentModel=vm.currentmodelId,this._getCurrentModel(vm.currentModel)},_getCurrentModel:function(modelid){angular.forEach(vm.modelList,function(model,i){model.id===modelid&&(vm.currentModelModel=model)})},watchCategoryCache:function(){$scope.$watch("vm.categoryCache",function(newVal){var length=vm.categoryCache.length;length>1?-110*(vm.categoryCache.length-1):0;vm.sortStyle={width:153*vm.categoryCache.length}},!0)},currentLevel:0,maxCol:4,tapNode:function(flag){flag?vm.currentLevel=vm.currentLevel+vm.maxCol<vm.categoryCache.length?vm.currentLevel+1:vm.currentLevel:vm.currentLevel=vm.currentLevel>0?vm.currentLevel-1:vm.currentLevel,event&&event.stopPropagation()},showNextCategory:function(index,model,_index,event){vm.categoryloading=!1,this.getModelId(model);var url=config.getAPI("nodechildren"),parent_id=model.model_id?model.id:0;url=url.replace("{model_id}",vm.currentmodelId).replace("{parent_id}",parent_id),http(url).then(function(data){data.error?utils.error(data.error.message):(vm.categoryCache.splice(_index+1,vm.categoryCache.length-_index-1),vm.categoryCache.push(data.nodes),data.nodes.length,vm.tapNode(!0)),vm.categoryloading="complete"})["catch"](function(reject){vm.categoryloading="complete"}),event&&event.stopPropagation()},delCache:function(node){vm.categoryCache.pop();var parent_node=this.findParent(node[0]);this.selectnode(parent_node)},findParent:function(options){var len=vm.categoryCache.length,parent_arr=vm.categoryCache[len-1],origin_obj={};return angular.forEach(parent_arr,function(value){options.parent_id&&options.parent_id==value.id?origin_obj=value:options.model_id==value.id&&(origin_obj=value)}),origin_obj},sortable:{options:{disabled:!0,axis:"y",stop:function(){angular.equals(vm.sortable.oldlist,vm.listdata)||(vm.sortable.isChange=!0)}},open:function(){vm.listdata.length&&(this.toggleSort(!0),vm.sortable.oldlist=vm.sortable.oldlist||angular.copy(vm.listdata))},exit:function(){var _this=this;angular.equals(vm.listdata,vm.sortable.oldlist)?this.toggleSort(!1):utils.confirm({msg:"有排序改动,确定退出吗?",headTitle:"排序提醒"},function(){_this.toggleSort(!1),vm.listdata=angular.copy(vm.sortable.oldlist)})},toggleSort:function(bools){this.isopenSort=bools,this.options.disabled=!bools},save:function(){vm.sortable.isChange&&(vm.sortable.oldlist=angular.copy(vm.listdata),this.toggleSort(!1),this.ajaxsort())},ajaxsort:function(){var url=config.getAPI("contentModelV3.recordsort"),ids=this.getIds();http(url,{method:"post",data:{id:ids,model_id:vm.currentmodelId}}).then(function(data){data.error?utils.error(data.error.message):utils.success("列表排序成功!")})},getIds:function(){var ids=[];return angular.forEach(vm.listdata,function(value){ids.push(value.id)}),ids.join()}},move:{isShow:!1,showMoveSelect:function(){this.isShow=!this.isShow}},moveCate:{groupList:[],getData:function(params){var node=params.currentCate,url=config.getAPI("nodechildren"),parent_id=node.id;vm.modifyLoading=null,url=url.replace("{model_id}",vm.currentmodelId).replace("{parent_id}",parent_id),http(url).then(function(data){var cache=vm.moveCate.groupList,length=cache.length;vm.moveCate.groupList.splice(params.index+1,length-params.index),data.nodes&&data.nodes.length>0&&vm.moveCate.groupList.push(data.nodes),params.callback&&params.callback(),vm.modifyLoading="complete"})["catch"](function(reject){vm.modifyLoading="error"})},modifyNode:function(nodeParams){var node=nodeParams.node,ids=this._getIds().join(",");if(!ids)return void utils.error("请选择要移动的数据!");var url=config.getAPI("modifynode");vm.modifyLoading=null,http(url,{method:"POST",data:{id:ids,to_node_id:node.id}}).then(function(data){data.error||(utils.success("移动分类成功!"),vm.initListdata(vm.currentmodelId),nodeParams.success&&nodeParams.success()),vm.modifyLoading="complete"})["catch"](function(reject){vm.modifyLoading="error"})},_getIds:function(){var ids=[];return vm.isCheckAll?angular.forEach(vm.listdata,function(val){ids.push(val.id)}):angular.forEach(vm.listdata,function(val,key){val.isCheck&&ids.push(val.id)}),ids}},clearDemodata:function(){var url=config.getAPI("cleardemodata");vm.clearloading=!1,http(url).then(function(){vm.clearloading="complete",utils.success("清除演示数据成功!").then(function(){vm.initListdata(vm.currentmodelId),vm.havedemo=!1})})["catch"](function(reject){vm.clearloading="error"})},getHaveDemo:function(){var url=config.getAPI("havedemo");http(url).then(function(data){vm.havedemo=data.result.has_demo_data})},batPush:function(status){var str=null;str=3===status?"发布":"撤销",utils.confirm({headTitle:str+"提醒",msg:"确定批量"+str+"数据吗?"},function(sure){sure&&vm._batPush(status,str)})},_batPush:function(status,str){var ids=[];angular.forEach(vm.listdata,function(val,key){val.isCheck&&ids.push(val.id)});var params={id:ids.join(","),model_id:vm.currentmodelId};record.updateRecordField(status,"status",params).then(function(data){vm.batPushLoading="complete",angular.forEach(vm.listdata,function(list,i){angular.forEach(data.data,function(item,j){item.id===list.id&&(vm.listdata[i].data.status=item.data.status)})}),utils.success("批量"+str+"成功!")})["catch"](function(data){utils.success("批量"+str+"成功!"),vm.batPushLoading="error"})},copyUrl:function(list){clipboard.on("error",function(e){list.isshowurl=!0}),clipboard.on("success",function(e){e.clearSelection(),utils.success("复制成功")})},getBindList:function(){var url=config.getAPI("getModelBindList").replace("{model_id}",vm.currentmodelId);http(url).then(function(data){data&&0==data.error_code&&(vm.modelBindDetails=data.result,vm.modelBindDetails&&(vm.hasContentBind=!0))})["catch"](function(){})},copyTo:function(){if(vm.hasContentBind){var ids=[];vm.isCheckAll?angular.forEach(vm.listdata,function(val){ids.push(val.id)}):(angular.forEach(vm.listdata,function(val,key){val.isCheck&&ids.push(val.id)}),ids.length||utils.error("请选择要复制的内容")),vm.openModelBindModal(ids)}else vm.openModelUnbindModal()},openModelUnbindModal:function(){$modal.open({animateanimation:!0,size:500,templateUrl:"content_copy/modal/contentCopyUnbindModal.html",controller:"ContentUnbindCtrl",resolve:{data:{id:vm.currentmodelId}}})},openModelBindModal:function(ids){$modal.open({animateanimation:!0,size:700,templateUrl:"content_copy/modal/contentCopyBindModal.html",controller:"ContentBindCtrl",resolve:{data:{id:vm.currentmodelId,details:vm.modelBindDetails,record_ids:ids}}})},getTplId:function(tplist){var id=-1;return angular.forEach(tplist,function(tpl,key){_.isEmpty(tpl.mapping)||(id=tpl.id)}),id},getModelData:function(modelId,recordId,callback){var dataurl=config.getAPI("modeldatadetail");dataurl=dataurl&&dataurl.replace("{model_id}",modelId).replace("{id}",recordId||0),http(dataurl).then(function(resp){callback&&callback(resp.data[0])})},getModelTemplate:function(model_id,callback){this.sendHttpForTpl(model_id,"",function(tplist){callback&&callback(tplist)})},getNodeTemplate:function(model_id,node_id,callback){this.sendHttpForTpl(model_id,node_id,function(tplist){callback&&callback(tplist)})},sendHttpForTpl:function(model_id,node_id,callback){var node_id_place=node_id?""+node_id:"",tplurl=config.getAPI("applantlayout").replace("{model_id}",model_id).replace("{node_id}",node_id_place);http(tplurl).then(function(data){callback&&callback(data.layout)})}}),$scope.$on("model_broadcast",function(event,modellist){angular.isArray(modellist)&&modellist.length&&vm.init(modellist)}),$scope.$on("toggleWeight",function(event,currentWeightScopeId){$scope.$broadcast("hideWeight",currentWeightScopeId)})}])});