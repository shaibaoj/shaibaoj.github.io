"use strict";define(function(require){var app=require("app");require("daterangepicker");require("http://api.map.baidu.com/getscript?v=2.0&ak=0245c1de2e0325d4874d3a84efb308bd&services=&t=20160304191045"),require("common/directives/angular.ueditor"),require("common/directives/gotop"),require("form.utils"),require("common/directives/dingdone-fixed"),require("common/directives/dingdone-number"),require("common/filters/filters"),require("./formRichModel"),require("./formPicModel"),require("common/services/verifyService"),require("../model/quoteModelModal"),require("../model/memberModal"),require("common/directives/sku-model"),require("common/directives/content-player"),require("common/directives/datetimepicker"),require("common/directives/uri-set"),require("./services/recordService"),require("common/services/addressServ"),require("../../appmake/page_design/child_ctrl/select_page"),require("appmake/services/pageManagerService"),require("../model/contentSaveGuide"),require("common/directives/stringtonumber"),require("content/list/ecshop_child_ctrl"),app.controller("ContentFormCtrl",["$rootScope","$mdDialog","$sce","$scope","$stateParams","$state","$timeout","$modal","config","navconfig","http","utils","upload","verifyService","modelService","RecordService","addressServ","pageManagerService",function($rootScope,$mdDialog,$sce,$scope,$stateParams,$state,$timeout,$modal,config,navconfig,http,utils,upload,verifyService,modelService,RecordService,addressServ,pageManagerService){var vm=$scope.vm={};console.log($stateParams),vm.breadcrumb=navconfig.breadcrumb,vm.navmenus=navconfig.navmenus;var breadcrumbKey=$stateParams.id?"editcontentform":"addcontentform",breadcrumbGroup="content";$stateParams.is_contribute&&(breadcrumbKey="editcontribute",breadcrumbGroup="interactive"),$stateParams.is_media&&(breadcrumbGroup="medium"),$stateParams.id?vm.isadd=!1:vm.isadd=!0,angular.extend(vm,{index:+new Date,model_id:$stateParams.model_id,ueconfig:{initialFrameHeight:400,initialFrameWidth:"100%",autoFloatEnabled:!0,topOffset:0,toolbars:[["fullscreen","undo","redo","|","bold","h1label","h2label","h3label","|","removetag","blockquote","insertunorderedlist","|","imgmanage","refer","referinfo","imglocal","extranetvideo","extranetinfo"]]},nativeconfig:{initialFrameHeight:400,initialFrameWidth:"100%",autoFloatEnabled:!0,topOffset:0},richtextconfig:{initialFrameHeight:400,initialFrameWidth:"100%",autoFloatEnabled:!0,topOffset:0,toolbars:[["fullscreen","undo","redo","|","bold","h1label","h2label","h3label","|","removetag","blockquote","insertunorderedlist","|","imgmanage","refer","referinfo","imglocal","extranetvideo","extranetinfo"]]},pics:[],tpl:{},timeSelect:[],utils:utils,isnotm3u8:!1,pattern:{},init:function(){vm.is_media=!!$stateParams.is_media,vm.iscontribute=$stateParams.is_contribute;vm._initTimeSelect(),pageManagerService.getUriList("content"),vm.multipleSort={data:{},cache:[],selected:$stateParams.model_id,getData:function(params){var id=$stateParams.model_id,index=params&&params.index?params.index:0,parentId=params&&params.id?params.id:0,url=config.getAPI("nodechildren").replace("{model_id}",id).replace("{parent_id}",parentId);vm.categoryLoading=null,http(url).then(function(data){var cache=vm.multipleSort.cache;data=data.user_models||data.nodes,cache.length&&cache.splice(index+1,cache.length-1),cache.push(data),vm.categoryLoading="complete"})["catch"](function(reject){vm.categoryLoading="complete"})},callback:function(node_id){vm.isToggleTpl=!0,vm.previewLoading=null},confirm:function(nodes){vm.node_id=nodes.ids,vm.categoryName=nodes.name}},vm.multipleSort.getData(),this._getModelData(function(){vm.isInitPre=!1}),vm.address={onMapClick:function(params,field){$scope.$apply(function(){var lonlat=[params.point.lng,params.point.lat];field.lng=params.point.lng,field.lat=params.point.lat,field.lonlat=lonlat.join(),field.isShow=!1,field.address=params.address})},baiduMap:function(field){field.isShow=!0;var middle=($(document).height()-$(window).height())/2;$(document).scrollTop(middle)}},vm.dt={openStart:function(field){field.startOpened=!field.startOpened},dateOptions:{formatYear:"yy",startingDay:1,showWeeks:!1},openEnd:function(field){field.endOpened=!field.endOpened},openDate:function(field){field.isOpened=!field.isOpened}},this._initLoading(),$rootScope.modelId=$stateParams.model_id},_initTimeSelect:function(){for(var i=0;i<=59;i++){var j=i+"";1==j.length&&(j="0"+j),vm.timeSelect.push(j+"")}},_getModelData:function(callback){var _this=this,modelId=$stateParams.model_id,dataId=$stateParams.id||0;vm.formloading=!1,RecordService.getRecordDetail(dataId,modelId).then(function(data){if(!data.error){vm.modelData=data.result,dataId?_this._initData():_this._initDefault();vm.node_id&&vm.node_id.length>0?vm.node_id.join():"";_this._initQuoteModel(),$scope.$watch("vm.modelData.model.fields",function(_new,_old,scope){angular.forEach(_new,function(field,i){"multi_upload"===field.widget&&(_this._checkMulti(field.value)?field.showBat=!0:field.showBat=!1)})},!0)}vm.formloading="complete"}).then(function(){_this._getStyleList().then(function(){_this._initStyleData()})})["catch"](function(reject){vm.formloading="complete"})},_getStyleList:function(){var url=config.getAPI("stylelist");return http(url).then(function(data){vm.styleList=data.style})["catch"](function(reject){})},_initQuoteModel:function(){var quoteModel=[],copymodellist=angular.copy(vm.modelData.model.fields);angular.forEach(copymodellist,function(field,key){if(field.sub_data_model_id){var model=vm.getModel(field.sub_data_model_id);model.widget=field.widget,model.uniqueid=field.key+model.id,model.fieldName=field.name,model.fieldKey=field.key,quoteModel.push(model)}}),vm.quoteModel=angular.copy(quoteModel),angular.forEach(vm.quoteModel,function(model,key){model.options={disabled:!0,axis:"y"}})},_checkMulti:function(multi){var res=!1;return angular.forEach(multi,function(v,key){v.isSelect&&(res=!0)}),res},ecshopFields:{},ecshopData:{},ecshopTeshuFieldConfig:["post_fee","post_type","delivery_template_id","auto_listing_time","is_listing","buy_quota","outer_id","num","unit_price","skus","auto_send","sold_num","coin_unit_price"],_initDefault:function(){var _this=this,fields=[],bool=_.find(vm.modelData.model.function_fields,function(funfield){return"unit_price_virtual_func"==funfield.key||"unit_price_real_func"==funfield.key});bool&&(console.log(bool,"bool"),vm.hasEcshopField=!0),angular.forEach(vm.modelData.model.fields,function(field,i){"is_content_native"==field.key&&("0"===field.default_value&&(field.value=0),"1"===field.default_value&&(field.value=1)),field.value=field.default_value,"is_virtual"==field.key?(console.log(bool,"boolde的key"),field.value=!(!bool||"unit_price_virtual_func"!=bool.key),vm.is_virtual=field.value,fields.push(field)):_this.ecshopTeshuFieldConfig.indexOf(field.key)>-1?(vm.ecshopFields[field.key]=field,vm.ecshopData[field.key]=vm.modelData.data[field.key]):(_this.__init[field.widget]&&_this.__init[field.widget](field,i),fields.push(field))}),console.log(vm.ecshopFields,vm.hasEcshopField,"vm.hasEcshopField 广播22",vm.is_virtual),vm.hasEcshopField&&$scope.$broadcast("InitEcshopChild",{fields:vm.ecshopFields,data:vm.ecshopData,is_virtual:vm.is_virtual}),vm.modelData.model.fields=fields,_this._toLast()},_initData:function(){this._initCategoryData(),this._initModelData()},_initCategoryData:function(){if(vm.modelData&&vm.modelData.node&&vm.modelData.node.length>0){var categoryNames=[],ids=[];angular.forEach(vm.modelData.node,function(node,key){categoryNames.push(node.name),ids.push(node.id)}),vm.categoryName=categoryNames,vm.node_id=ids}else vm.categoryName=[],vm.node_id=[]},_initStyleData:function(){vm.styleList&&angular.isArray(vm.styleList)&&vm.styleList.length&&(vm.currentStyle=null!=vm.modelData.style?vm.modelData.style:vm.styleList[0].id)},_initModelData:function(){var _this=this,fields=[];vm.youzanPowers(),vm.modelData&&vm.modelData.model&&vm.modelData.model.fields&&vm.modelData.model.fields.length>0&&!function(){var bool=_.find(vm.modelData.model.function_fields,function(funfield){return"unit_price_virtual_func"==funfield.key||"unit_price_real_func"==funfield.key});bool&&(vm.hasEcshopField=!0),angular.forEach(vm.modelData.model.fields,function(field,i){"is_virtual"==field.key?(field.value=!(!bool||"unit_price_virtual_func"!=bool.key),vm.is_virtual=field.value,fields.push(field)):_this.ecshopTeshuFieldConfig.indexOf(field.key)>-1?(vm.ecshopFields[field.key]=field,vm.ecshopData[field.key]=vm.modelData.data[field.key]):(angular.isFunction(_this.__init[field.widget])&&_this.__init[field.widget](field,i),fields.push(field))}),vm.modelData.model.fields=fields,console.log("广播编辑",vm.hasEcshopField,vm.ecshopData,vm.is_virtual),vm.hasEcshopField&&$scope.$broadcast("InitEcshopChild",{fields:vm.ecshopFields,data:vm.ecshopData,is_virtual:vm.is_virtual}),_this._toLast()}()},_toLast:function(){var fieldVector=[],indexVector=[];angular.forEach(vm.modelData.model.fields,function(field,i){"editor"===field.widget&&(indexVector.push(i),fieldVector.push(angular.copy(field)))}),angular.forEach(indexVector,function(index){delete vm.modelData.model.fields[index]}),vm.modelData.model.fields=_.compact(vm.modelData.model.fields),vm.modelData.model.fields=vm.modelData.model.fields.concat(fieldVector),console.log(vm.modelData.model.fields)},togglePattern:function(flag,v,weight){A.forEach(vm.modelData.model.fields,function(value){if(value.key==flag)switch(weight){case"calculator":vm.higecopy(v);break;case"point":vm.higecopy(v);break;case"location":vm.higecopy(v);break;case"media":vm.higecopy(v);break;case"unit_price":vm.higecopy(v);break;default:vm.oldValue=v}}),vm.pattern[flag]||(vm.pattern[flag]=!0)},higecopy:function(v){vm.oldValue={};for(var k in v)vm.oldValue[k]=v[k];return vm.oldValue},editSure:function(flag,value){return console.log(value,flag),value&&"m3u8"==flag?void(value.includes("http")?vm.pattern[flag]=!1:(utils.error("m3u8格式错误！"),vm.isnotm3u8=!0)):(vm.isnotm3u8=!1,value&&value.m3u8?void(value.m3u8.includes("http")?vm.pattern[flag]=!1:(utils.error("m3u8格式错误！"),vm.isnotm3u8=!0)):(vm.isnotm3u8=!1,void(vm.pattern[flag]=!1)))},checkm3u8:function(value){value&&(value.includes("http")?vm.isnotm3u8=!1:(utils.error("m3u8格式错误！"),vm.isnotm3u8=!0))},editCancel:function(flag,weight,initTitle,initPic){"title_indexpic"==flag&&A.forEach(vm.modelData.model.fields,function(field){"title"==field.key?field.value=initTitle:"indexpic"==field.key&&(field.value=initPic)}),A.forEach(vm.modelData.model.fields,function(value){if(value.key==flag)switch(console.log(value),weight){case"calculator":value.price=vm.oldValue;break;case"point":value.address=vm.oldValue.address,value.lat=vm.oldValue.lat,value.lng=vm.oldValue.lng;break;case"location":value.cityName=vm.oldValue.cityName,value.provinceName=vm.oldValue.provinceName,value.raionName=vm.oldValue.raionName,value.details=vm.oldValue.details;break;case"unit_price":vm.deliverProductLocal.unit_price.now=vm.oldValue.now,vm.deliverProductLocal.origin=vm.oldValue.origin;break;case"coin_unit_price":break;case"refer_model":vm._initQuoteRecord(vm.oldValue);break;case"refer_models":vm._initQuoteRecord(vm.oldValue);break;default:value.value=vm.oldValue}}),vm.pattern[flag]=!1},getWidgetUrl:function(widget){return"content/list/child_widget/base_widget/"+widget+".html"},setRich:function(field){var modalInstance=$modal.open({animateanimation:!0,size:800,templateUrl:"content/list/richtpl.html",controller:"SetRichCtrl",resolve:{field:field}});modalInstance.result.then(function(_field){field.richtitle=_field.richtitle,field.richcontent=_field.richcontent})},uploadSinglePic:function(file,field){this.uploadPic(file,field,"single")},uploadMedia:function(file,field){field.loading=null;var url=config.getAPI("upload");upload(url,file[0],null,null,"bodyPic").then(function(data){field.loading="complete",field.value||(field.value={}),field.value.indexpic=data.material},function(reason){field.loading="complete"})},delVideo:function(id,index){utils.confirm({msg:"确定要删除该视频么?"},function(sure){sure&&vm.videoList.splice(index,1)})},linkPic:function(field){var modalInstance=utils.mdDialog({templateUrl:"content/list/linkpictpl.html",controller:"PicCtrl"});modalInstance.then(function(imgs){field.value||(field.value=[]),angular.forEach(imgs,function(img,key){field.value.push(img)})})},uploadPic:function(file,field,isSingle){field.loading=null;var count=0,url=config.getAPI("upload"),picConfig=null;picConfig=isSingle?this._getPicConfig("single"):picConfig=this._getPicConfig("multi");for(var i=0;i<file.length;i++)upload(url,file[i],picConfig.width,picConfig.height,"bodyPic").then(function(data){field.value||isSingle||(field.value=[]),data.loading="complete",isSingle?field.value=data:field.value.push(data),count++,count===file.length&&(field.loading="complete")},function(reason){count++,field.loading="complete"})},reloadPic:function(file,field,index){field.value[index].loading=null;var url=config.getAPI("upload");upload(url,file[0],null,null,"bodyPic").then(function(data){data.loading="complete",field.value[index]=data},function(reason){data.loading="complete"})},delPic:function(id,index,field){utils.confirm({msg:"确定要删除该图片么?"},function(sure){sure&&field.value.splice(index,1)})},editPic:function(pic,$event){pic.isEdit=!pic.isEdit,pic.isEdit||(pic.brief=pic._title,pic.material&&(pic.material.brief=pic._title))},setIndexPic:function(pic){angular.forEach(vm.modelData.model.fields,function(field,i){"indexpic"===field.key&&(field.value=pic)})},selectForBat:function(pic){if(pic.isSelect=!pic.isSelect,pic.isSelect)vm.pics.push(pic);else{var start=this._getPicIndex(pic);vm.pics.splice(start,1)}},stopSelectForBat:function($event){$event.stopPropagation()},delBatPic:function(field){var _this=this;utils.confirm({msg:"确定要删除选中的图片么？",headTitle:"批量删除"},function(sure){sure&&_this._traversePics(vm.pics,field,function(img,pic,index){img.url===pic.url&&field.value.splice(index,1)})})},editBatPic:function(field,$event){field.iseditBat=!field.iseditBat},saveBatPic:function(field){var _this=this;this._traversePics(vm.pics,field,function(img,pic,index){img.url===pic.url&&(img.material&&(img.material.brief=field._brief),img.brief=field._brief,img._title=field._brief)}),setTimeout(function(){_this._traversePics(vm.pics,field,function(img,pic,index){img.url===pic.url&&$scope.$apply(function(){delete img.isSelect,delete img.isEdit})})},1e3),field.iseditBat=!1},cancelBatPic:function(field){vm.iseditBat=!1},_traversePics:function(pics,field,callback){angular.forEach(vm.pics,function(pic,key){angular.forEach(field.value,function(img,index){callback&&callback(img,pic,index)})})},_getPicIndex:function(pic){var index=-1;return angular.forEach(vm.pics,function(p,key){p.url===pic.url&&(index=key)}),index},scoreCheck:function(){vm.score.checked=!vm.score.checked},commentCheck:function(){vm.comment.checked=!vm.comment.checked},videoParse:function(field){if(field.value){var reg=new RegExp("(http[s]{0,1}|ftp)://[a-zA-Z0-9\\.\\-]+\\.([a-zA-Z]{2,4})(:\\d+)?(/[a-zA-Z0-9\\.\\-~!@#$%^&*+?:_/=<>]*)?");return reg.test(field.value)?void this._sendHttpForParesVideo(field):(utils.error("输入的视频地址格式不对哦!"),vm.is,!1)}},outlink:function(field){if(field.value){var reg=new RegExp("(http[s]{0,1}|ftp)://[a-zA-Z0-9\\.\\-]+\\.([a-zA-Z]{2,4})(:\\d+)?(/[a-zA-Z0-9\\.\\-~!@#$%^&*+?:_/=<>]*)?");if(!reg.test(field.value))return void utils.error("输入的外链地址不对!");vm.outlinkUrl=field.value}else vm.outlinkUrl=""},functionbutton:function(field){vm.__fun[field.extra_data.widget_type_setting.type](field)},__fun:{sms:function(field){},url:function(field){verifyService.isWebUrl(field.value)||(field.value="",utils.error("输入的url地址不正确!"))},tel:function(field){verifyService.isPhoneOrMobileNum(field.value)||(field.value="",utils.error("输入的号码不正确!"))},email:function(field){verifyService.isEmail(field.value)||(field.value="",utils.error("输入的邮箱地址不正确!"))}},inputBlur:function(field){"outlink"===field.key&&vm.outlink(field),"button"===field.widget&&vm.functionbutton(field)},toggleRadio:function(_field,key){var temp=_field.radios[key];_field.radios=[],_field&&_field.extra_data&&_field.extra_data.widget_type_setting&&_field.extra_data.widget_type_setting.collection&&_field.extra_data.widget_type_setting.collection.length>0&&angular.forEach(_field.extra_data.widget_type_setting.collection,function(t,i){key===i?_field.radios[i]=!temp:_field.radios[i]=!1}),this.__format.radio(_field)},_formatRadio:function(_field){_field.radios=[],_field&&_field.extra_data&&_field.extra_data.widget_type_setting&&_field.extra_data.widget_type_setting.collection&&_field.extra_data.widget_type_setting.collection.length>0&&angular.forEach(_field.extra_data.widget_type_setting.collection,function(t,i){_field.radios[i]=!1,_field.value===t&&(_field.radios[i]=!0),"proportion"==_field.key&&"4:3"==_field.default_value&&"4:3"==t&&(_field.radios[i]=!0)})},_sendHttpForParesVideo:function(field){vm.parseVideo=!1,vm.parseLoading=null;var url=config.getAPI("videoparse")+"?url="+field.value;http(url).then(function(data){vm.parseVideo=!0,vm.isVideoParse=!1,vm.pattern[field.key]=!1,vm.parseLoading="complete"},function(){vm.parseVideo=!0,vm.isVideoParse=!0,vm.parseLoading="error"})},goBack:function(){var _state="mainLayout.contentlist";$state.go(_state,{model_id:$stateParams.model_id})},submitModelData:function(isgoOnAdd){if(isgoOnAdd&&vm.iscontribute)$state.go("mainLayout.contribute",{model_id:$stateParams.model_id});else{var id=$stateParams.id||0;vm.isgoOnAdd=isgoOnAdd||!1;var model_id=$stateParams.model_id;0===id?this._saveAdd(model_id):this._saveEdit(id,model_id)}},_saveAdd:function(model_id,node_id){var id=vm.node_id?vm.node_id:[],obj={model_id:model_id,node_id:id.join(),style:vm.currentStyle,field:this._formatSubData().data};vm.hasEcshopField?$scope.$broadcast("getEcshopData",{flag:"sendHttp",data:obj,fields:vm.modelData.model.fields,isEdit:0}):this._sendHttp(obj,0)},_saveEdit:function(id,model_id,node_id){var obj={model_id:model_id,id:id,node_id:vm.node_id.join(),style:vm.currentStyle,field:this._formatSubData().data};vm.hasEcshopField?$scope.$broadcast("getEcshopData",{flag:"sendHttp",data:obj,fields:vm.modelData.model.fields,isEdit:1}):this._sendHttp(obj,1)},is_contribute:function(){return!!$stateParams.is_contribute},is_media_fun:function(){return!!$stateParams.is_media},_sendHttp:function(obj,bool){var _this=this,is_contribute=_this.is_contribute(),_state="mainLayout.contentlist";if(is_contribute&&(obj.visible=!0,_state="mainLayout.contribute"),vm.isgoOnAdd&&(_state="secondLayout.contentformAdd"),vm.is_media_fun()&&(_state="mainLayout.audio"),this._check(this._formatSubData().fields)){if(vm.isVideoParse)return void utils.error("输入的视频地址格式不对哦！");if(vm.isnotm3u8)return void utils.error("m3u8流格式不对哦！");vm.submitLoading=!1,bool?!function(){var str="编辑";RecordService.updateRecord(obj).then(function(data){vm.submitLoading="complete",!data.error&&_this.callBackRecord(str,obj,_state)})["catch"](function(){vm.submitLoading="fail"})}():!function(){var str="新增";RecordService.createRecord(obj).then(function(data){vm.submitLoading="complete",!data.error&&_this.callBackRecord(str,obj,_state)})["catch"](function(){vm.submitLoading="fail"})}()}},callBackRecord:function(str,obj,_state){utils.success(str+"数据成功!").then(function(){if(!$stateParams.id&&vm.isgoOnAdd)$state.reload();else if("create"===$stateParams.handle_type){utils.mdDialog({templateUrl:"content/model/contentSaveGuideModal.html",controller:"content.form.guide"})}else $stateParams.handle_type||$state.go(_state,{model_id:obj.model_id})})},_getPicConfig:function(mode){var picConfig=config.picConfig.form_singlepic;return"single"==mode&&(picConfig=config.picConfig.form_singlepic),"multi"==mode&&(picConfig=config.picConfig.form_multipic),picConfig},__init:{handlePicData:function(_field,picConfig){angular.forEach(_field.value,function(value,key){value.url=utils.getImgUrl(value,picConfig.width,picConfig.height),_field.value[key]=value})},multi_upload:function(_field){var picConfig=vm._getPicConfig("multi");this.handlePicData(_field,picConfig)},single_upload:function(_field){if(_field.value&&!angular.equals(_field.value,[])){var picConfig=vm._getPicConfig("single");_field.value.url=utils.getImgUrl(_field.value,picConfig.width,picConfig.height)}},checkbox:function(_field,_key){_field.items=[],_field&&_field.extra_data&&_field.extra_data.widget_type_setting&&_field.extra_data.widget_type_setting.collection&&_field.extra_data.widget_type_setting.collection.length>0&&angular.forEach(_field.extra_data.widget_type_setting.collection,function(t,i){_field.items[i]=!1,angular.forEach(_field.value,function(v,k){v===t&&(_field.items[i]=!0)})})},radio:function(_field,key){vm._formatRadio(_field)},calculator:function(_field,key){_field.price={},console.log(_field.value),_field.price.newPrice=_field.value&&"number"==typeof _field.value.now?_field.value.now:void 0,_field.price.oldPrice=_field.value&&"number"==typeof _field.value.origin?_field.value.origin:void 0},unit_price:function(_field,key){this.calculator(_field,key),vm.deliverProductLocal||(vm.deliverProductLocal={}),vm.deliverProductLocal.unit_price={},vm.deliverProductLocal.unit_price=_field.value,vm.deliverProductLocal.origin=_field.value&&"number"==typeof _field.value.origin?+_field.value.origin:void 0},datepicker:function(_field,key){_field.value=_field.value?utils.formatDate(_field.value,"YYYY-MM-DD hh:mm:ss"):""},begin_end_time:function(_field,key){var json=_field.value;_field.startDate=json&&json.start?utils.formatDate(json.start,"YYYY-MM-DD hh:mm:ss"):"",_field.endDate=json&&json.end?utils.formatDate(json.end,"YYYY-MM-DD hh:mm:ss"):""},point:function(_field,key){_field.lng=_field.value&&_field.value.lng?_field.value.lng:"",_field.lat=_field.value&&_field.value.lat?_field.value.lat:"",_field.address=_field.value&&_field.value.address?_field.value.address:"",_field.lonlat=_field.lng&&_field.lat?_field.lng+","+_field.lat:""},location:function(field,key){var _this=this;_this.p_c_r=field.value&&field.value.address?field.value.address.split(","):[],addressServ.getProvince().then(function(json){vm.provinceList=json.result.province,_this.p_c_r[0]&&(field.province=_.filter(vm.provinceList,function(province){return _this.p_c_r[0]==province.name})[0].code,field.provinceName=_.filter(vm.provinceList,function(province){return _this.p_c_r[0]==province.name})[0].name.replace(/\s/g,""),addressServ.getCity(field.province).then(function(jsonCity){vm.cityList=jsonCity.result.city,_this.p_c_r[1]&&(field.city=_.filter(vm.cityList,function(city){return _this.p_c_r[1]==city.name})[0].code,field.cityName=_.filter(vm.cityList,function(city){return _this.p_c_r[1]==city.name})[0].name.replace(/\s/g,""),addressServ.getRaion(field.city).then(function(jsonRaion){vm.raionList=jsonRaion.result,_this.p_c_r[2]&&(field.raion=_.filter(vm.raionList,function(raion){return _this.p_c_r[2]==raion.name})[0].code,field.raionName=_.filter(vm.raionList,function(raion){return _this.p_c_r[2]==raion.name})[0].name.replace(/\s/g,""))}))}))}),field.details=_this.p_c_r[3]},richtext:function(_field){_field.richtitle=_field.value&&_field.value.title?_field.value.title:"",_field.richcontent=_field.value&&_field.value.content?_field.value.content:""},textunit:function(_field){_field.text=_field.value&&_field.value.text?_field.value.text:"",_field.unit=_field.value&&_field.value.unit?_field.value.unit:""},video_parse:function(_field){vm.haveParse=!0,$stateParams.model_id?vm.parseVideo=!0:vm.parseVideo=!1},"switch":function(_field){_field.value=!!_field.value},favor:function(_field){_field.value=!!_field.value},praise:function(_field){_field.value=!!_field.value},text:function(_field){"outlink"===_field.key&&(vm.outlinkUrl=_field.value)},skus:function(_field){vm.deliverProductLocal||(vm.deliverProductLocal={}),vm.deliverProductLocal.skus=_field.value},num:function(_field){vm.deliverProductLocal||(vm.deliverProductLocal={}),vm.deliverProductLocal.num=_field.value},outer_id:function(_field){vm.deliverProductLocal||(vm.deliverProductLocal={}),vm.deliverProductLocal.outer_id=_field.value},refer_models:function(_field){vm._initQuoteRecord(_field)},refer_model:function(_field){vm._initQuoteRecord(_field)},refer_users:function(_field){vm.initMemberList(_field)},refer_user:function(_field){vm.initMemberList(_field)},event_selector:function(_field){vm.open_page=_field.value},media:function(_field){_field.value=_field.value?_field.value:{},_field.value.duiation&&(_field.value.hour=_field.value.duiation.substring(0,_field.value.duiation.indexOf(":")),_field.value.minutes=_field.value.duiation.substr(-2,2),_field.value.second=_field.value.duiation.substr(-5,2))},weight:function(_field){_field.value=_field.value?+_field.value:0}},_initQuoteRecord:function(_field){vm.selectRecordlList[_field.key+_field.sub_data_model_id]=[],"string"==typeof _field.value?vm.getRecord(_field,_field.value,_field.sub_data_model_id):angular.forEach(_field.value,function(v,key){v&&vm.getRecord(_field,v,_field.sub_data_model_id)}),console.log(vm.selectRecordlList[_field.key+_field.sub_data_model_id])},getRecord:function(_field,recordId,modelId){var url=config.getAPI("modeldatadetail").replace("{id}",recordId).replace("{model_id}",modelId);http(url).then(function(resp){var record=resp.data[0];vm.selectRecordlList[_field.key+_field.sub_data_model_id].push(record)})},_formatSubData:function(){var newfield={},newfields=[],copy_model_fields=angular.copy(vm.modelData.model.fields),_this=this;return angular.forEach(copy_model_fields,function(field,key){field="unit_price"===field.widget?_this.__format[field.widget]?_this.__format[field.widget](field):field:"skus"===field.widget?_this.__format[field.widget]?_this.__format[field.widget](field):field:_this.__format[field.widget]?_this.__format[field.widget](field):field,"weight"==field.key&&(field.value=parseInt(field.value)),"is_content_native"===field.key&&(field.value?field.value=1:field.value=0),(!field.value&&field.value!==!1||0==field.value.length)&&(0===field.value||field.value===!1?field.value=field.value:field.value=null),newfields.push(field),field&&field.key&&(newfield[field.key]=field.value)}),{fields:newfields,data:newfield}},formatHour:function(hour,type){A.forEach(vm.modelData.model.fields,function(val){"media"==val.widget&&val.data_type==type&&(val.value.hour&&"null"!=val.value.hour?val.value.hour=Math.floor(hour):(val.value.hour="0",console.log(val.value.hour)))})},__format:{text:function(field){return null!==field.value?(field.value=field.value+"",field):(field.value=null,field)},textarea:function(field){return null!==field.value?(field.value=field.value+"",field):(field.value=null,field)},multi_upload:function(field){return vm._formatPicData(field)},single_upload:function(field){return vm._formatPicData(field)},checkbox:function(field){return field.value=[],field&&angular.isArray(field.items)&&field.items.length>0&&angular.forEach(field.items,function(value,key){value===!0&&field.value.push(field.extra_data.widget_type_setting.collection[key])}),field},radio:function(field){return field.value=[],field&&angular.isArray(field.radios)&&field.radios.length>0&&angular.forEach(field.radios,function(value,key){value===!0&&(field.value=field.extra_data.widget_type_setting.collection[key])}),field},calculator:function(field){var obj={},newPrice=field.price&&"number"==typeof field.price.newPrice?field.price.newPrice:null,oldPrice=field.price&&"number"==typeof field.price.oldPrice?field.price.oldPrice:null;return obj.origin=1*parseFloat(oldPrice).toFixed(2),obj.now=1*parseFloat(newPrice).toFixed(2),console.log(newPrice,oldPrice),null===newPrice||null===oldPrice?field.value=null:field.value=obj,field},unit_price:function(field){return vm.deliverProductLocal&&vm.deliverProductLocal.unit_price?(console.log(vm.deliverProductLocal.origin,vm.deliverProductLocal.unit_price.now),null!=vm.deliverProductLocal.origin&&""!==vm.deliverProductLocal.origin&&null!=vm.deliverProductLocal.unit_price.now&&""!==vm.deliverProductLocal.unit_price.now?field.value={origin:1*parseFloat(vm.deliverProductLocal.origin).toFixed(2),now:1*parseFloat(vm.deliverProductLocal.unit_price.now).toFixed(2),division:vm.deliverProductLocal.division}:field.value=null):field.value=null,field},datepicker:function(field){return console.log(field),field.value=field.value?utils.toUTC(field.value):"",field},begin_end_time:function(field){var obj={},start=new Date(field.startDate),end=new Date(field.endDate);if(start>end)return void utils.error("结束时间小于开始时间");var startDate=field.startDate?utils.toUTC(field.startDate):"",endDate=field.endDate?utils.toUTC(field.endDate):"";return obj.start=startDate,obj.end=endDate,field.value=obj,""===startDate&&""===endDate&&(field.value=null),field},point:function(field){var obj={};return obj.lat=field.lat,obj.lng=field.lng,obj.address=field.address,field.value=obj,""===obj.lat&&""===obj.lng&&""===obj.address&&(field.value=null),field},location:function(field){var obj={},name=[];return obj.lat=null,obj.lng=null,vm.provinceList&&vm.cityList&&vm.raionList&&field.details?(name.push(_.filter(vm.provinceList,function(province){return province.code==field.province})[0].name),name.push(_.filter(vm.cityList,function(city){return city.code==field.city})[0].name),name.push(_.filter(vm.raionList,function(raion){return raion.code==field.raion})[0].name),name.push(field.details),obj.address=name.join(","),field.value=obj,field):field},richtext:function(field){if(field.value&&field.value.title)console.log("this is richtext!");else{var obj={};obj.title=field.richtitle,obj.content=field.richcontent,field.value=obj}return field},textunit:function(field){var obj={};return obj.text=field.text,obj.unit=field.unit,field.value=obj,field},"switch":function(field){return field.value=!!field.value,field},favor:function(field){return this["switch"](field)},skus:function(field){var obj=vm.deliverProductLocal.skus,data=[];return angular.forEach(obj,function(val){val.properties_name_list.length&&(angular.forEach(val.properties_name_list,function(properties,key){""===properties.v&&val.properties_name_list.splice(key,1)}),val.image||(console.log("加图片咯"),angular.forEach(vm.modelData.model.fields,function(field,i){"indexpic"===field.key&&(console.log("家咯",field.value),val.image=field.value.material)})),data.push(val))}),field.value=data&&data.length?data:null,field},num:function(field){var obj=vm.deliverProductLocal.num;return field.value=obj,field},refer_models:function(field){return field.value=[],angular.forEach(vm.selectRecordlList[field.key+field.sub_data_model_id],function(item,key){field.value.push(item.id)}),field},refer_model:function(field){return 0==vm.selectRecordlList[field.key+field.sub_data_model_id].length?(field.value=null,field):(angular.forEach(vm.selectRecordlList[field.key+field.sub_data_model_id],function(item,key){field.value=item.id}),field)},refer_users:function(field){return field.value=[],angular.forEach(vm["listData"+field.widget],function(item,key){field.value.push(item.id)}),field},refer_user:function(field){return console.log(vm["listData"+field.widget]),vm["listData"+field.widget]=vm["listData"+field.widget]?vm["listData"+field.widget]:[],0==vm["listData"+field.widget].length?(field.value=null,field):(angular.forEach(vm["listData"+field.widget],function(item,key){field.value=item.id}),field)},media:function(field){return 0!==Object.keys(field.value).length?(field.value.minutes&&field.value.second?field.value.duiation=[field.value.hour,field.value.minutes,field.value.second].join(":"):field.value.duiation="",delete field.value.hour,delete field.value.minutes,delete field.value.second,field):(field.value=null,field)},weight:function(field){return field.value=+field.value,field}},_formatModels:function(field){},_formatModel:function(field){},_formatPicData:function(field){if(field&&angular.isArray(field.value)&&field.value.length>0&&angular.forEach(field.value,function(value,key){value=value.material?value.material:value,delete value.url,delete value.loading,delete value.isSelect,
delete value.isEdit,field.value[key]=value}),angular.isObject(field.value)){var value=field.value.material?field.value.material:field.value;delete value.url,delete value.loading,delete value.isSelect,delete value.isEdit,field.value=value}return field},_initLoading:function(){vm.loading="init",vm.indexLoading="init",vm.categoryLoading="init",vm.parseLoading="init",vm.previewLoading="init"},youzanPowers:function(){vm.modelData&&vm.modelData.model&&"youzan_product"===vm.modelData.model.slug&&(vm.nosave=!0)},_check:function(fields){for(var success=!0,i=0;i<fields.length;i++)fields[i]&&fields[i].required&&(""===fields[i].value&&(fields[i].value=null),void 0===fields[i].value&&(fields[i].value=null),null===fields[i].value&&(success=this._checkErrorMessage(fields[i])));return success},_checkFieldValue:function(field){return!!field.value},_checkErrorMessage:function(field){return utils.error(field.name+"为必填项!"),!1},__check:{favor:function(field){return!1},"switch":function(feild){return!1},textunit:function(field){return!field.value||!field.value.text}},selectRecordlList:{},openQuoteModelModal:function(model){var modalInstance=utils.mdDialog({templateUrl:"content/model/quoteModelModal.html",controller:"QuoteModelModalCtrl",locals:{params:{modelId:model.id,widget:model.widget,selectRecordlList:vm.selectRecordlList[model.uniqueid]||[]}}});modalInstance.then(function(res){vm.selectRecordlList[model.uniqueid]=res.selectRecordlList})},delSelectRecord:function(index,modelId){vm.selectRecordlList[modelId].splice(index,1)},sortRecord:function(model){console.log(model),model.canSort=!model.canSort,model.canSort?model.options.disabled=!1:model.options.disabled=!0},getModel:function(modelId){var _modelList=angular.copy(vm.modelList);return _.filter(_modelList,function(model){if(modelId==model.id)return model})[0]},changeProvince:function(field,value,name){addressServ.getCity(value).then(function(json){field.city="",field.raion="",Object.assign(field,{provinceName:name}),vm.cityList=json.result.city,field.province=value})},changeCity:function(field,value,name){addressServ.getRaion(value).then(function(json){field.raion="",Object.assign(field,{cityName:name}),vm.raionList=json.result,field.city=value})},changeRaion:function(field,value,name){Object.assign(field,{raionName:name}),field.code=value},hasProperty:function(key,field){return field.value&&field.value.hasOwnProperty(key)},openEventSelectorPop:function(field){var modalData={url:vm.open_page,model:{id:vm.model_id},uriflag:"content",showDelete:!0};pageManagerService.showPageDialog(modalData).then(function(data){field.value=data.url,vm.open_page=data.url})},getEditPageId:function(openpage){return pageManagerService.getPageName(openpage)},selectMemberList:{},openUserModal:function(field){var modalInstance=utils.mdDialog({templateUrl:"content/model/memberModal.html",controller:"MemberModalCtrl",locals:{params:{widget:field.widget,selectRecordlList:vm["listData"+field.widget]||[]}}});modalInstance.then(function(res){vm["isShowUserList"+field.widget]=!0,vm["listData"+field.widget]=res.selectRecordlList?res.selectRecordlList:[]})},initMemberList:function(_field){vm["listData"+_field.widget]=[],vm.getDataList(_field)},getDataList:function(_field){var url=config.getAdminAPI("allmemberlist");http(url,{method:"get",params:vm.searchParams}).then(function(data){0==data.error_code&&(vm.loading="complete",vm.handleGroup(data),"string"==typeof _field.value?A.forEach(vm.copyListData,function(data){data.id==_field.value&&vm["listData"+_field.widget].push(data)}):angular.forEach(_field.value,function(v,key){A.forEach(vm.copyListData,function(data){data.id==v&&vm["listData"+_field.widget].push(data)})})),console.log(vm["listData"+_field.widget],_field.widget)})},handleGroup:function(data){data.result.data&&data.result.data.length&&angular.forEach(data.result.data,function(vv){null==vv.last_login?vv.time="--:--:--":vv.time=utils.formatDate(vv.last_login,"YYYY-MM-DD hh:mm:ss"),"admin_end"==vv.source?vv.source="制作端":"client_end"==vv.source&&(vv.source="客户端"),vv.member_groups.length||(vv.member_groups=[{name:"普通会员"}])}),vm.copyListData=data.result.data}}),$scope.$on("sendHttp",function($event,params){vm._sendHttp(params.data,params.isEdit)}),$scope.$on("model_broadcast",function(event,modellist){vm.modelList=modellist,modelService.setnavConfig(modellist,function(){modelService.setContentformConfig($stateParams.model_id,breadcrumbGroup,breadcrumbKey)}),vm.breadcrumbarr=utils.dealBreadcrumb(vm.navmenus,vm.breadcrumb),vm.init()})}])});