"use strict";define(function(require){var app=require("app");require("member/modal/editSubscibeModal"),require("member/modal/addSubscibeModal"),require("common/directives/pager-redirect"),require("common/directives/pagination/page1"),app.controller("MemberSubscibeCtrl",["$rootScope","$scope","config","http","utils","navconfig",function($rootScope,$scope,config,http,utils,navconfig){var vm=$scope.vm={};angular.extend(vm,{init:function(){vm.getGroup(!0),vm.watchCurrentPage()},getGroup:function(flag){var url=config.getAdminAPI("membergroup"),params=vm.collectParams(flag);http(url,{method:"get",params:params}).then(function(data){vm.loading="complete",data&&0==data.error_code&&vm.handleGroup(data,flag)})},handleGroup:function(data,flag){if(flag){var options={per_page:20,current_page:1,total:data.result.total,total_pages:Math.ceil(data.result.total/20)};vm.initPagination(options)}data.result.data&&data.result.data[0]&&angular.forEach(data.result.data,function(vv){vv.time=utils.formatDate(vv.create_time,"YYYY-MM-DD hh:mm:ss")}),vm.groupList=data.result.data},collectParams:function(flag){var params={"api.size":20,name:vm.seachKey,type:"associate"};return vm.pagination=vm.pagination||{},vm.pagination.currentPage&&(params["api.page"]=vm.pagination.currentPage),flag&&(vm.pagination.currentPage=1),params},isEnter:function(event){13==event.keyCode&&vm.searchListData()},searchListData:function(){vm.getGroup()},initPagination:function(options){vm.pagination={totalItems:options.total,numPages:options.total_pages,itemsPerPage:options.per_page,maxSize:options.total_pages,currentPage:options.current_page}},watchCurrentPage:function(){var _this=this;$scope.$watch("vm.pagination.currentPage",function(currentpage,old){currentpage&&old&&_this.getGroup()})},create:function(){utils.mdDialog({controller:"CreateSubscibe",templateUrl:"member/modal/addSubscibeModal.html",multiple:!1}).then(function(data){var options={per_page:vm.pagination.itemsPerPage,current_page:1,total:vm.pagination.totalItems,total_pages:vm.pagination.numPages};console.log(data),data.result.time=utils.formatDate(data.result.create_time,"YYYY-MM-DD hh:mm:ss"),options.total=options.total+1,vm.groupList.length<options.per_page?vm.groupList.unshift(data.result):(options.total_pages=Math.ceil(options.total/options.per_page),vm.groupList.splice(vm.groupList.length-1,1),vm.groupList.unshift(data.result)),vm.initPagination(options)},function(){console.log("1111")})},edit:function(item){utils.mdDialog({controller:"EditSubscibe",templateUrl:"member/modal/editSubscibeModal.html",multiple:!1,locals:{data:item}}).then(function(data){data.result.time=utils.formatDate(data.result.create_time,"YYYY-MM-DD hh:mm:ss"),angular.forEach(vm.groupList,function(vv){vv.id==data.id&&(vv=data.result)})})},del:function(item,index){utils.confirm({headTitle:"删除提示",msg:"您确定要删除该订阅组?"},function(data){data&&vm.delItem(item,index)})},delItem:function(item,index){var url=config.getAdminAPI("deletegroup").replace("{id}",item.id);http(url,{method:"delete"}).then(function(data){data&&0==data.error_code&&vm.handleList(index)})},handleList:function(index){vm.pagination.totalItems<vm.pagination.itemsPerPage?vm.groupList.splice(index,1):vm.getGroup(!0)}}),$scope.$on("checkApp",function(event,first_appinfo){vm.init()})}])});