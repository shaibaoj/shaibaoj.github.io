"use strict";define(function(require){var app=require("app");require("common/directives/pager-redirect"),require("member/modal/addMemberGroups"),require("member/modal/editMemberGroups"),require("common/directives/pagination/page1"),app.controller("MemberGroupCtrl",["$rootScope","$scope","$state","$stateParams","utils","$modal","http","config","$log",function($rootScope,$scope,$state,$stateParams,utils,$modal,http,config,$log){var vm=$scope.vm={};angular.extend(vm,{utils:utils,init:function(){vm.guid=$stateParams.guid,vm.getMemberGroup(!0),vm.watchCurrentPage()},initPagination:function(options){vm.pagination={totalItems:options.total,numPages:options.total_pages,itemsPerPage:options.per_page,maxSize:options.total_pages,currentPage:options.current_page}},watchCurrentPage:function(){$scope.$watch("vm.pagination.currentPage",function(currentpage,old){currentpage&&old&&(vm.getMemberGroup(),console.log("currentpage",currentpage))})},getMemberGroup:function(flag){var params=vm.collectParams(flag),url=config.getAdminAPI("membergroup");http(url,{method:"get",params:params}).then(function(data){data&&0==data.error_code&&(vm.loading="complete",vm.handleGroup(data,flag))})},handleGroup:function(data,flag){if(flag){var options={per_page:20,current_page:1,total:data.result.total,total_pages:Math.ceil(data.result.total/20)};console.log("options",options),vm.initPagination(options)}data.result.data&&data.result.data[0]&&angular.forEach(data.result.data,function(vv){vv.time=utils.formatDate(vv.create_time,"YYYY-MM-DD hh:mm:ss")}),console.log("data",data),vm.groupList=data.result.data},collectParams:function(flag){var params={"api.size":20,name:vm.seachKey,type:"system"};return vm.pagination=vm.pagination||{},vm.pagination.currentPage&&(params["api.page"]=vm.pagination.currentPage),flag&&(vm.pagination.currentPage=1),params},isEnter:function(event){13==event.keyCode&&vm.searchListData()},searchListData:function(){vm.getMemberGroup()},addGroup:function(){utils.mdDialog({controller:"AddGroups",templateUrl:"member/modal/addMemberGroups.html",multiple:!1}).then(function(data){var options={per_page:vm.pagination.itemsPerPage,current_page:1,total:vm.pagination.totalItems,total_pages:vm.pagination.numPages};data.result.time=utils.formatDate(data.result.create_time,"YYYY-MM-DD hh:mm:ss"),options.total=options.total+1,vm.groupList.length<options.per_page?vm.groupList.unshift(data.result):vm.groupList.unshift(data.result),console.log("addGroup",options),vm.initPagination(options)})},editGroup:function(item){$log.log("编辑的对象数据：",item),utils.mdDialog({controller:"EditGroups",templateUrl:"member/modal/editMemberGroups.html",multiple:!1,locals:{data:item}}).then(function(){vm.getMemberGroup()})},deleteGroup:function(item,index){utils.confirm({headTitle:"删除提示",msg:"您确定要删除该会员组?"},function(data){data&&vm.delItem(item,index)})},delItem:function(item,index){var url=config.getAdminAPI("deletegroup").replace("{id}",item.id);http(url,{method:"delete"}).then(function(data){data&&0==data.error_code&&vm.handleList(index)})},handleList:function(index){vm.pagination.totalItems<vm.pagination.itemsPerPage?vm.groupList.splice(index,1):vm.getMemberGroup(!0)}}),$scope.$on("checkApp",function(event,first_appinfo){vm.init()})}])});