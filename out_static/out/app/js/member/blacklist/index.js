"use strict";define(function(require){var app=require("app");require("common/directives/pager-redirect"),require("common/directives/pagination/page1"),app.controller("MemberBlacklistCtrl",["$scope","utils","config","http","navconfig",function($scope,utils,config,http,navconfig){var vm=$scope.vm={};angular.extend(vm,{init:function(){vm.initParams(),vm.watchCurrentPage(),vm.getBlackList(!0)},initParams:function(){vm.creatDown=!1,vm.isCheckAll=!1,vm.currentSelected=0},btnDown:function(){vm.creatDown=!vm.creatDown},checkAll:function(){vm.isCheckAll=!vm.isCheckAll,vm.isCheckAll?vm.currentSelected=1:vm.currentSelected=0,vm.isCheckAll?angular.forEach(vm.listData,function(vv){vv.checked=!0}):angular.forEach(vm.listData,function(vv){vv.checked=!1})},getBlackList:function(flag){var url=config.getAdminAPI("blacklist"),params=vm.collectParam(flag);console.log("请求列表的参数为: ",params),http(url,{method:"get",params:params}).then(function(data){console.log("请求到的黑名单列表参数为: ",data),vm.loading="complete",data&&0==data.error_code&&vm.handleBlack(data,flag)})},handleBlack:function(data,flag){if(flag){var options={per_page:20,current_page:1,total:data.result.total,total_pages:Math.ceil(data.result.total/20)};vm.initPagination(options)}data.result.data&&data.result.data[0]&&(console.log("获取到的数据 >>>",data.result.data),angular.forEach(data.result.data,function(vv){vv.last_login?vv.time=utils.formatDate(vv.last_login,"YYYY-MM-DD hh:mm:ss"):vv.time="--:--:--",0===vv.member_groups.length&&(vv.member_groups=[{name:"普通会员"}])})),vm.listData=data.result.data,console.log("列表数据 >>>",vm.listData)},collectParam:function(flag){var params={"api.size":20,q:vm.seachKey};return vm.pagination=vm.pagination||{},vm.pagination.currentPage&&(params["api.page"]=vm.pagination.currentPage),flag&&(vm.pagination.currentPage=1),params},isEnter:function(event){13==event.keyCode&&(console.log("回车搜索!"),vm.searchListData())},searchListData:function(){vm.getBlackList(!0)},check:function(item){item.checked?vm.currentSelected=0:vm.currentSelected=1},removeBlackList:function(){var newList=[];if(angular.forEach(vm.listData,function(vv){if(vv.checked){var param={identifier:vv.identifier,device_token:vv.device_token,ip:vv.ip,type:1,duration:0};newList.push(param)}}),newList[0]){var url=config.getAdminAPI("optblacklist");http(url,{method:"post",data:newList}).then(function(data){data&&0==data.error_code&&(vm.getBlackList(),utils.success("移出成功"))})}},initPagination:function(options){vm.pagination={totalItems:options.total,numPages:options.total_pages,itemsPerPage:options.per_page,maxSize:options.total_pages,currentPage:options.current_page}},watchCurrentPage:function(){var _this=this;$scope.$watch("vm.pagination.currentPage",function(currentpage,old){currentpage&&old&&_this.getBlackList()})}}),$scope.$on("checkApp",function(event,first_appinfo){vm.init()})}])});