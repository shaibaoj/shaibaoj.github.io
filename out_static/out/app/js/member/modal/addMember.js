"use strict";define(function(require){var app=require("app");require("common/services/modelService"),require("common/modal/modal-header"),require("common/modal/modal-footer"),app.controller("AddMember",["$scope","$mdDialog","config","http","utils",function($scope,$mdDialog,config,http,utils){var vm=$scope.vm={};angular.extend(vm,{init:function(){this.initParams(),this.getMemberGroup()},initParams:function(){vm.username="",vm.register_type="",vm.password="",vm.system_member_groups="",vm.membergroupList="",vm.memberlimit="",vm.datelimit="天",vm.datetype="day",vm.selected="period",vm.newdate="",vm.expire_date="",vm.checked=!1,vm.days="",vm.date="",vm.dateList=[{slug:"day",name:"天"},{slug:"mouth",name:"月"},{slug:"year",name:"年"}]},memberSelect:function(val){vm.memberlimit=val.name,vm.invite_type=val.slug,vm.id=val.id},dateSelect:function(val){vm.datelimit=val.name,vm.datetype=val.slug},check:function(){vm.checked=!vm.checked,vm.date="",vm.expire_date=""},choose:function(cycle){vm.expire_date="",vm.selected=cycle},getMemberGroup:function(){var params={};params.type="system";var url=config.getAdminAPI("membergroup").replace("{guid}",vm.guid);http(url,{method:"get",params:params}).then(function(data){vm.membergroupList=data.result.data})},close:function(){$mdDialog.cancel()},save:function(){vm.expire_date=vm.newdate.substr(0,10),vm.date="";var params={username:vm.username,password:vm.password},phoneVerifyRegex=/^[0-9]{11}$/,emailVerifyRegex=/^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$/;if(!params.username)return void utils.error("请输入用户名!");if(phoneVerifyRegex.test(params.username))params.register_type="mobile";else{if(!emailVerifyRegex.test(params.username))return void utils.error("请重新输入正确格式的电话或者邮箱地址!");params.register_type="email"}return params.password?vm.id?(params.system_member_groups=[],params.system_member_groups.push(vm.id),vm.checked===!0?(params.expire_date=null,params.is_perpetual=!0,params.days=null):(params.is_perpetual=!1,"period"==vm.selected?(params.expire_date=null,"day"==vm.datetype?params.days=vm.days:"mouth"==vm.datetype?params.days=30*vm.days:"year"==vm.datetype&&(params.days=365*vm.days)):"times"==vm.selected&&(params.days=null,params.expire_date=vm.newdate.substr(0,10)+"T"+vm.newdate.substr(12,16)+"Z")),params.is_perpetual===!1&&("period"===vm.selected&&!params.days||"times"===vm.selected&&!params.expire_date)?void utils.error("请选择到期时间!"):(console.log("saveParams",params),void this.addmember(params))):void utils.error("请选择会员组!"):void utils.error("请输入密码!")},addmember:function(params){var url=config.getAdminAPI("addmember").replace("{guid}",vm.guid);http(url,{method:"post",data:params}).then(function(data){data&&0==data.error_code&&utils.success("新建成功").then(function(){$mdDialog.hide(data)})})}}),vm.init()}])});
