"use strict";define(function(require){var app=require("app");require("common/services/modelService"),require("common/modal/modal-header"),require("common/modal/dialog-foot"),require("common/directives/pagination/page1"),app.controller("EditeMemberGroups",["$rootScope","$scope","$mdDialog","config","http","utils","$stateParams","data",function($rootScope,$scope,$mdDialog,config,http,utils,$stateParams,data){var vm=$scope.vm={};angular.extend(vm,{init:function(){this.initParams(),this.getMemberGroup(),this.getAllMemberGroup()},initParams:function(){vm.selected=[],vm.mId=data.id,vm.membergroupList=[],vm.userMemberGroups=[],vm.firstcheck="",vm.checked=data.member_groups},getAllMemberGroup:function(){var params={type:"system"},url=config.getAdminAPI("membergroup");http(url,{method:"get",params:params}).then(function(data){data&&0==data.error_code&&(vm.loading="complete",angular.forEach(data.result.data,function(vv){angular.forEach(vm.checked,function(key){vv.id===key.id&&(vv.check=!0,vv.firstcheck=!0)}),vm.membergroupList.push(vv)}))})},getMemberGroup:function(){var url=config.getAdminAPI("getMemberGroups").replace("{guid}",vm.guid).replace("{identifier}",vm.mId);http(url,{method:"get"}).then(function(data){console.log("该用户所有会员组数据数据: ",data.result),vm.userMemberGroups=data.result,angular.forEach(vm.userMemberGroups,function(vv){if("date"===vv.display_method)vv.usedTime="到期时间："+utils.formatDate(vv.expire_date,"YYYY-MM-DD hh:mm:ss");else if("days"===vv.display_method){var now=new Date,end=new Date(vv.expire_date),range=(end-now)/1e3;range<0?vv.days=0:vv.days=Math.floor(range/86400),vv.usedTime="剩余"+vv.days+"天"}else"perpetual"===vv.display_method&&(vv.usedTime="永久")})})},selectTime:function(list,index){utils.mdDialog({controller:"EditeExpireTime",templateUrl:"member/modal/EditeExpireTime.html",multiple:!1,locals:{data:{expire_date:null,is_perpetual:!0,days:null,group_id:null}}}).then(function(params){params&&!_.isEmpty(params)&&(vm.time=params,void 0!=params.expire_date?(params.expire_date=params.expire_date.replace("Z","+0800"),list.usedTime="到期时间："+utils.formatDate(params.expire_date,"YYYY-MM-DD hh:mm:ss")):void 0!=params.days?list.usedTime="剩余"+params.days+"天":list.usedTime="永久"),list.expire_date=params.expire_date,vm.userMemberGroups[index].days=params.days,vm.userMemberGroups[index].is_perpetual=params.is_perpetual,vm.loading="complete"})},controllData:function(item){if(void 0==item.check||item.check===!1){item.check=!0;var newGroup={group_id:item.id,type:item.type,name:item.name,check:item.check,expire_date:void 0,days:void 0,is_perpetual:!1};vm.userMemberGroups.push(newGroup)}else{item.check=!1;for(var i=0;i<vm.userMemberGroups.length;i++)vm.userMemberGroups[i].group_id==item.id&&vm.userMemberGroups.splice(i,1);vm.removeOneGroup()}},chooseMember:function(item){item.firstcheck===!0?utils.mdDialog({controller:"removeMember",templateUrl:"member/modal/removeMember.html",multiple:!1}).then(function(){item.check=!0,item.firstcheck=!1,vm.controllData(item)}):vm.controllData(item)},tidyGroupSaveParam:function(){var _groupParam=[];return angular.forEach(vm.userMemberGroups,function(item,index){Number(item.days)>0?_groupParam.push({group_id:item.group_id,days:Number(item.days)+1,is_perpetual:!1}):item.expire_date?_groupParam.push({group_id:item.group_id,expire_date:item.expire_date,is_perpetual:!1}):_groupParam.push({group_id:item.group_id,is_perpetual:!0})}),_groupParam},close:function(){$mdDialog.hide()},save:function(){var userMemberGroupsParams,len=vm.userMemberGroups.length;if(!len)return void utils.error("请至少选择一个分组");userMemberGroupsParams=vm.tidyGroupSaveParam();var url=config.getAdminAPI("getMemberGroups").replace("{guid}",vm.guid).replace("{identifier}",vm.mId);http(url,{method:"post",data:userMemberGroupsParams}).then(function(data){data&&0==data.error_code&&utils.success("保存成功").then(function(){$mdDialog.hide()})})},removeOneGroup:function(){var requestUrl=config.getAdminAPI("getMemberGroups").replace("{guid}",vm.guid).replace("{identifier}",vm.mId),groupParam=vm.tidyGroupSaveParam();http(requestUrl,{method:"post",data:groupParam}).then(function(resData){resData&&"0"===resData.error_code&&vm.getMemberGroup()})}}),vm.init()}])});
