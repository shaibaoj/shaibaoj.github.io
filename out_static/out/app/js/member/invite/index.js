"use strict";define(function(require){var app=require("app"),Clipboard=require("clipboard");require("common/directives/pagination/page4"),app.controller("MembernviteCtrl",["$rootScope","$scope","$state","utils","$stateParams","http","config","navconfig",function($rootScope,$scope,$state,utils,$stateParams,http,config,navconfig){var vm=$scope.vm={},clipboard=new Clipboard(".clipbtn");angular.extend(vm,{init:function(){vm.curMark="url",vm.guid=$stateParams.guid,vm.loading=!0,vm.registry(),vm.methodstatus={email:"邮箱",mobile:"手机",hyperlink:"链接"},vm.statusStatus={pass:"通过",nopass:"不通过",ready:"未处理"},vm.inviteList=[],vm.phonelist={invite_method:"mobile",mobile:[]},vm.emaillist={invite_method:"email",email:[]}},registry:function(){var url=config.getAdminAPI("memberinvited_config");http(url).then(function(data){data&&0==data.error_code&&(vm.disposeRegistry(data),vm.loading="complete")})},disposeRegistry:function(data){vm.openRegistry=data.result.registry_enable,vm.openAudit=data.result.member_approval,vm.invite_url=data.result.invite_url,1==vm.openAudit&&(vm.showinvitedlist(!0),vm.watchCurrentPage())},closeDirectRegister:function(){"false"==vm.openRegistry?"true"==vm.openRegistry:"false"==vm.openRegistry;var param={registry_enable:vm.openRegistry},url=config.getAdminAPI("memberinvited");http(url,{method:"post",data:param}).then(function(data){data&&0==data.error_code&&utils.success("修改成功!")})},closeAudit:function(){"false"==vm.openAudit?"true"==vm.openAudit:"false"==vm.openAudit;var param={member_approval:vm.openAudit},url=config.getAdminAPI("memberinvited");http(url,{method:"post",data:param}).then(function(data){data&&0==data.error_code&&(utils.success("修改成功!"),vm.showinvitedlist())})},navChange:function(mark){vm.curMark=mark},copyLink:function(){clipboard.on("error",function(e){vm.showtip=!0}),clipboard.on("success",function(e){e.clearSelection(),utils.success("复制成功")})},addInvite:function(addContent){var _phoneVerify=/^\d{11}$/,_emailVerify=/^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$/;addContent=(addContent||"").trim();for(var i=0;i<vm.inviteList.length;i++)if(vm.inviteList[i].value===addContent)return void utils.error("请勿重复输入邀请的用户!");_phoneVerify.test(addContent)?(vm.inviteList.push({inviteType:"phone",value:addContent}),vm.newContent=""):_emailVerify.test(addContent)?(vm.inviteList.push({inviteType:"email",value:addContent}),vm.newContent=""):utils.error("请输入合法的 手机/邮箱 后再添加!")},deleteInvite:function(index){vm.inviteList.splice(index,1)},classifyInviteData:function(){vm.inviteList.length?angular.forEach(vm.inviteList,function(value){"phone"===value.inviteType?vm.phonelist.mobile.push(value.value):"email"===value.inviteType&&vm.emaillist.email.push(value.value)}):utils.error("请至少输入一个有效用户再邀请")},sendInvite_messages:function(){vm.newContent&&vm.addInvite(vm.newContent),vm.classifyInviteData();var url=config.getAdminAPI("sendmessages");vm.phonelist.mobile.length&&http(url,{method:"post",data:vm.phonelist}).then(function(data){return data&&"0"===data.error_code?(vm.emaillist.email.length||(utils.success("邀请发送成功!"),vm.inviteList=[]),void(vm.phonelist.mobile=[])):void utils.error(data.error_message)}),vm.emaillist.email.length&&http(url,{method:"post",data:vm.emaillist}).then(function(data){data&&"0"===data.error_code?(utils.success("邀请发送成功!"),vm.inviteList=[],vm.emaillist.email=[]):utils.error(data.error_message)})},initPagination:function(response){vm.pagination={totalItems:response.total,maxSize:response.total_pages,currentPage:response.current_page,forceEllipses:!0,itemsPerPage:5}},watchCurrentPage:function(){$scope.$watch("vm.pagination.currentPage",function(currentpage,old){currentpage&&old&&vm.showinvitedlist()})},showinvitedlist:function(flag){vm.nodata=!1;var params=vm.collectParams(flag),url=config.getAdminAPI("invitedlist");http(url,{method:"get",params:params}).then(function(data){data&&0==data.error_code&&(vm.totalPage=data.result.data.total,0==data.result.data.length?1==vm.nodata:0==vm.nodata,vm.handle(data,flag))})},handle:function(data,flag){if(flag){var response={per_page:5,current_page:1,total:data.result.total,total_pages:Math.ceil(data.result.total/5)};vm.initPagination(response),console.log("分页对象 >>>",vm.pagination)}data.result.data&&data.result.data[0]&&angular.forEach(data.result.data,function(vv){vv.time=utils.formatDate(vv.create_time,"YYYY-MM-DD hh:mm:ss")}),vm.invitedList=data.result.data},collectParams:function(flag){var params={"api.size":5,"api.page":1};return vm.pagination=vm.pagination||{},vm.pagination.currentPage&&(params["api.page"]=vm.pagination.currentPage),flag&&(vm.pagination.currentPage=1),params},select:function(val,item){vm.invitedList.status=val.toString();var param={status:vm.invitedList.status},url=config.getAdminAPI("approval").replace("{id}",item.id);http(url,{method:"post",data:param}).then(function(data){data&&0==data.error_code&&utils.success("修改成功!")}),vm.registry()}}),$scope.$on("checkApp",function(event,first_appinfo){vm.init()})}])});