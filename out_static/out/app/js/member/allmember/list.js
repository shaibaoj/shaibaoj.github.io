"use strict";define(function(require){var app=require("app");require("common/directives/pager-redirect"),require("common/directives/pagination/page1"),require("member/modal/addSeniorSearch"),require("member/modal/addMember"),require("member/modal/EditeExpireTime"),require("member/modal/removeMember"),require("member/modal/tempEditMemberGroups"),require("common/directives/datetimepicker"),app.controller("MembersListCtrl",["$rootScope","$scope","$state","$stateParams","utils","$modal","http","config","navconfig",function($rootScope,$scope,$state,$stateParams,utils,$modal,http,config,navconfig){var vm=$scope.vm={};angular.extend(vm,{utils:utils,init:function(){vm.guid=$stateParams.guid,this.initParams(),vm.getDataList(!0),this.getMemberGroup(),this.getGroup(),vm.watchCurrentPage(),vm.groupflag="all",vm.seniorlimit="高级搜索"},initParams:function(){vm.search="",vm.creatDown=!1,vm.listData=[],vm.membergroupList=[],vm.blackList=[],vm.searchList=[]},getDataList:function(flag,searchParams){var url=config.getAdminAPI("allmemberlist").replace("{guid}",vm.guid);vm.searchParams=vm.collectParams(searchParams),console.log("请求参数:",vm.searchParams),http(url,{method:"get",params:vm.searchParams}).then(function(data){console.log("请求到的列表数据:",data),0==data.error_code&&(console.log("是否为全列表搜索",vm.isSearchAllList()),vm.isSearchAllList()&&(vm.allMemberTotalNumber=data.result.total),vm.loading="complete",vm.handleGroup(data,flag))})},collectParams:function(searchParams){searchParams&&!_.isEmpty(searchParams)||(searchParams={name:vm.seach});var originParams={"api.size":20,"api.page":1,type:"system"},params=angular.extend(originParams,searchParams);return vm.pagination=vm.pagination||{},vm.pagination.currentPage?params["api.page"]=vm.pagination.currentPage:vm.pagination.currentPage=1,params},isEnter:function(event){13==event.keyCode&&this.searchListData()},handleGroup:function(data,flag){if(flag){var options={per_page:20,current_page:1,total:data.result.total,total_pages:Math.ceil(data.result.total/20)};vm.initPagination(options)}data.result.data&&data.result.data.length&&angular.forEach(data.result.data,function(vv){null==vv.last_login?vv.time="--:--:--":vv.time=utils.formatDate(vv.last_login,"YYYY-MM-DD hh:mm:ss"),"admin_end"==vv.source?vv.source="制作端":"client_end"==vv.source&&(vv.source="客户端"),vv.member_groups.length||(vv.member_groups=[{name:"普通会员"}])}),vm.listData=data.result.data},initPagination:function(options){vm.pagination={totalItems:options.total,numPages:options.total_pages,itemsPerPage:options.per_page,maxSize:options.total_pages,currentPage:options.current_page}},watchCurrentPage:function(){$scope.$watch("vm.pagination.currentPage",function(currentpage,old){currentpage&&old&&vm.getDataList(!1,vm.searchParams)})},isSearchAllList:function(){for(var key in vm.searchParams)if("api.size"!==key&&"api.page"!==key&&"type"!==key&&vm.searchParams[key])return!1;return!0},searchTagList:function(){this.getSearchList()},getSearchList:function(){var url=config.getAdminAPI("searchlist").replace("{guid}",vm.guid);http(url,{method:"get"}).then(function(data){0==data.error_code&&(vm.searchList=data.result)})},deleteSearch:function(item,index){utils.confirm({headTitle:"删除提示",msg:"您确定要删除该搜索标签?"},function(data){data&&vm.deleteSearchTags(item,index)})},deleteSearchTags:function(item,index){var url=config.getAdminAPI("deleteSearchTag").replace("{id}",item.id);http(url,{method:"delete"}).then(function(data){data&&0==data.error_code&&(vm.getSearchList(index),vm.seniorlimit="高级搜索")})},getMemberGroup:function(){var params={};params.type="system";var url=config.getAdminAPI("membergroup").replace("{guid}",vm.guid);http(url,{method:"get",params:params}).then(function(data){vm.membergroupList=data.result.data})},getGroup:function(){var url=config.getAdminAPI("membergroup"),params={};params.type="associate",http(url,{method:"get",params:params}).then(function(data){data&&0==data.error_code&&(vm.subscribegruopList=data.result.data)})},searchAll:function(){vm.getDataList(!0,{name:""}),vm.groupflag="all"},btnDown:function(){vm.creatDown=!vm.creatDown},currentSelected:0,check:function(index,item){var isCheck=vm.listData[index].isCheck;vm.listData[index].isCheck=!vm.listData[index].isCheck,vm.currentSelected=isCheck?vm.currentSelected-1:vm.currentSelected+1,vm.currentSelected==vm.listData.length?vm.isCheckAll=!0:vm.isCheckAll=!1;var id=item.identifier,blackList=vm.blackList;if(1==item.isCheck){var vv={identifier:id,device_token:"683a5d5ab3043e37bad7f82f638bec1e",ip:"120.12.142.184",type:1,duration:-1};vm.blackList.push(vv)}else for(var i=0;i<vm.blackList.length;i++)blackList[i].identifier==id&&vm.blackList.splice(i,1)},searchSenior:function(item){vm.loading="";var params=item.params;vm.listData=[],vm.seniorlimit=item.name;var url=config.getAdminAPI("allmemberlist");http(url,{method:"get",params:params}).then(function(data){vm.loading="complete",0==data.error_code&&data.result.data[0]?(angular.forEach(data.result.data,function(val){null!=val.last_login?val.time=utils.formatDate(val.last_login,"YYYY-MM-DD hh:mm:ss"):val.time="--:--:--","admin_end"==val.source?val.source="制作端":"client_end"==val.source&&(val.source="客户端"),val.member_groups.length||(val.member_groups=[{name:"普通会员"}])}),vm.listData=data.result.data,vm.handleGroup(data,!0)):vm.listData=[]})},searchListData:function(){vm.loading="",vm.listData=[];var params={};vm.search&&(params.q=vm.search);var url=config.getAdminAPI("allmemberlist");http(url,{method:"get",params:params}).then(function(data){vm.loading="complete",data.result.data&&data.result.data.length?(angular.forEach(data.result.data,function(val){null!=val.last_login?val.time=utils.formatDate(val.last_login,"YYYY-MM-DD hh:mm:ss"):val.time="--:--:--","admin_end"==val.source?val.source="制作端":"client_end"==val.source&&(val.source="客户端"),val.member_groups.length||(val.member_groups=[{name:"普通会员"}]),vm.listData.push(val)}),vm.handleGroup(data,!0)):vm.listData=[]})},checkAll:function(){vm.isCheckAll=!vm.isCheckAll,this._select(),vm.isCheckAll?angular.forEach(vm.listData,function(val){var vv={identifier:val.identifier,device_token:"683a5d5ab3043e37bad7f82f638bec1e",ip:"120.12.142.184",type:1,duration:-1};vm.blackList.push(vv)}):vm.blackList=[]},_select:function(){angular.forEach(vm.listData,function(val,key){val.isCheck=vm.isCheckAll}),vm.currentSelected=vm.isCheckAll?vm.listData.length:0},addBlackList:function(){var url=config.getAdminAPI("optblacklist");http(url,{method:"post",data:vm.blackList}).then(function(data){data&&0==data.error_code&&utils.success("已移入黑名单").then(function(){vm.getDataList(),vm.isCheckAll=!1})})},groupdown:function(){vm.membergroup=!vm.membergroup},subscribedown:function(){vm.subscribegruop=!vm.subscribegruop},seniorSearch:function(){utils.mdDialog({controller:"seniorSearch",templateUrl:"member/modal/seniorSearch.html",multiple:!0}).then(function(searchParams){console.log("高级搜索的params",searchParams),vm.searchParams=searchParams,vm.getDataList(!0,searchParams)})},addmember:function(){utils.mdDialog({controller:"AddMember",templateUrl:"member/modal/addmember.html",multiple:!1}).then(function(data){vm.loading="complete",vm.getDataList()})},getmemberList:function(id){var url=config.getAdminAPI("allmemberlist"),params={system_member_group:id};vm.loading="",http(url,{method:"get",params:params}).then(function(data){vm.loading="complete",data&&"0"===data.error_code&&(angular.forEach(data.result.data,function(val){null!==val.last_login?val.time=utils.formatDate(val.last_login,"YYYY-MM-DD hh:mm:ss"):val.time="--:--:--","admin_end"===val.source?val.source="制作端":"client_end"===val.source&&(val.source="客户端"),val.member_groups.length||(val.member_groups=[{name:"普通会员"}])}),vm.listData=data.result.data)})},getSubscribeList:function(id){var url=config.getAdminAPI("allmemberlist"),params={associate_member_group:id};vm.loading="",http(url,{method:"get",params:params}).then(function(data){vm.loading="complete",data&&"0"==data.error_code&&(angular.forEach(data.result.data,function(val){null!=val.last_login?val.time=utils.formatDate(val.last_login,"YYYY-MM-DD hh:mm:ss"):val.time="--:--:--","admin_end"==val.source?val.source="制作端":"client_end"==val.source&&(val.source="客户端"),val.member_groups.length||(val.member_groups=[{name:"普通会员"}])}),vm.listData=data.result.data)})},changeMemberGroup:function(item){var id=item.id;this.getmemberList(id),vm.groupflag=item.id},changeSubscribeGroup:function(item){var id=item.id;this.getSubscribeList(id),vm.groupflag=item.id},groupsEdite:function(item){utils.mdDialog({controller:"EditeMemberGroups",templateUrl:"member/modal/EditeMemberGroups.html",multiple:!0,locals:{data:item}}).then(function(data){vm.loading="complete",vm.getDataList()})}}),$scope.$on("checkApp",function(event,first_appinfo){vm.init()})}])});