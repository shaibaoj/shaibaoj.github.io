"use strict";define(function(require){var app=require("app");require("appmake/services/appMakeService");require("heightchart");app.controller("MemberIntegralCtrl",["$rootScope","$scope","$state","$stateParams","utils","http","config","navconfig","$q","appMakeService",function($rootScope,$scope,$state,$stateParams,utils,http,config,navconfig,$q,appMakeService){var vm=$scope.vm={};angular.extend(vm,{init:function(guid){vm.currentFlag="recharge",vm.getIntegralInfo(),vm.getRechargeRecord(),vm.getRechargeCount(),vm.watchCurrentPage()},getIntegralInfo:function(){var url=config.getAdminAPI("integral.planslist"),defer=$q.defer();return http(url).then(function(json){vm.integralInfo={},+json.error_code||(angular.forEach(json.result,function(item){vm.integralInfo[item.platform]?"":vm.integralInfo[item.platform]=[],vm.integralInfo[item.platform].push(item)}),vm.initCreat(),vm.watchIntegralInfo(),defer.resolve(json))}),defer.promise},initIntegralInfo:function(flag){var url=config.getAdminAPI("integral.addplans"),data=angular.copy(config.integralInfo);"ios"==flag&&angular.forEach(data,function(item){item.platform=flag,item.apple_product_id=""}),http(url,{method:"post",data:data}).then(function(json){+json.error_code||(vm.integralInfo[flag]=json.result,vm.isChange=!1)})},deleteIntegralInfo:function(list,index){utils.confirm({headTitle:"删除提醒",msg:"确定删除该套餐吗?"},function(sure){if(sure){if(!list[index].id)return list.splice(index,1),void utils.success("删除成功！");var url=config.getAdminAPI("integral.deleteplans");return 1==list.length?void utils.error("至少保留一条套餐！"):void http(url,{method:"post",data:[list[index].id]}).then(function(json){json&&!+json.error_code&&(utils.success("删除成功！"),list.splice(index,1))})}})},changeItem:function(item,index){if(console.log("item",item),vm.isChange){var url=void 0,data=item;if(data.price=+parseFloat(data.price?+data.price:0).toFixed(2),data.value=+parseFloat(data.value?+data.value:0).toFixed(2),url=item.id?config.getAdminAPI("integral.updateplans").replace("{plan_id}",item.id):config.getAdminAPI("integral.addplan"),vm.check(item)){var defer=$q.defer();return http(url,{method:item.id?"put":"post",data:data}).then(function(json){+json.error_code||(utils.success(item.id?"修改成功！":"添加成功！"),vm.integralInfo[item.platform][index]=json.result,defer.resolve(json.result)),vm.isChange=!1}),defer.promise}}},check:function(data){return"ios"==data.platform?data.name&&data.value:data.name&&data.price&&data.value},add:function(flag){vm.integralInfo[flag]?"":vm.integralInfo[flag]=[],vm.integralInfo[flag].push({type:"coin",name:null,apple_product_id:"",price:0,value:null,platform:flag})},initCreat:function(){vm.integralInfo.android||vm.initIntegralInfo("android"),vm.integralInfo.ios||vm.initIntegralInfo("ios")},watchIntegralInfo:function(){$scope.$watch("vm.integralInfo",function(newVal,oldVal){angular.equals(newVal,oldVal)||(vm.isChange=!0)},!0)},getRechargeRecord:function(){var url=config.getAdminAPI("integral.getrechargerecord"),params=vm.collectListParam(),defer=$q.defer();return vm.loading=!1,vm.paginationLoading=!1,http(url,{method:"get",params:params}).then(function(json){if(!+json.error_code){if(angular.forEach(json.result.data,function(item){item.create_time=utils.formatDate(item.create_time,"YYYY-MM-DD hh:mm:ss")}),vm.recordlist=json.result.data,!vm.pagination||!vm.pagination.currentPage){var options={per_page:20,current_page:1,total:json.result.total,total_pages:Math.ceil(json.result.total/20)};vm.initPagination(options)}vm.recordlist.length||(vm.nodata=!0),defer.resolve(json)}vm.paginationLoading="complete",vm.loading="complete"})["catch"](function(){vm.paginationLoading="complete",vm.loading="complete"}),defer.promise},initPagination:function(options){vm.pagination={totalItems:options.total,numPages:options.total_pages,itemsPerPage:options.per_page,maxSize:options.total_pages,currentPage:options.current_page}},watchCurrentPage:function(){var _this=this;$scope.$watch("vm.pagination.currentPage",function(currentpage,old){currentpage&&old&&_this.getRechargeRecord()}),$scope.$watch("vm.pagination.pagecount",function(currentpagecount,old){currentpagecount&&old&&(vm.paginationLoading=!1,_this.getRechargeRecord())})},collectListParam:function(){var params={};return vm.pagination&&vm.pagination.currentPage&&(params["api.page"]=vm.pagination.currentPage,params["api.size"]=vm.pagination.itemsPerPage),params},getRechargeCount:function(){var url=config.getAdminAPI("integral.rechargecount"),defer=$q.defer();return vm.loading=!1,http(url).then(function(json){if(!+json.error_code){vm.rechargeCount=json.result;var recharge=vm.rechargeCount;vm.currentPercent=parseFloat(+recharge.iap_pay_channel_count/(recharge.iap_pay_channel_count+recharge.other_pay_channel_count)).toFixed(2),vm.initRound(vm.currentPercent),defer.resolve(json)}vm.loading="complete"})["catch"](function(){vm.loading="complete"}),defer.promise},initRound:function(cx,cy,r,percent){$("#pie").highcharts({chart:{plotBackgroundColor:"#ffffff",plotShadow:!1,width:null,borderWidth:0,plotBorderWidth:0,spacing:[0,0,0,0],margin:[null],colorCount:2},credits:{enabled:!1},tooltip:{enabled:!1},title:{floating:!0,text:null},plotOptions:{pie:{colors:["#14a7ff","#0ecbab"],allowPointSelect:!0,cursor:"pointer",dataLabels:{distance:-38,enabled:!0,color:"#ffffff",format:" {point.percentage:1f} %",style:{color:"#ffffff",fontSize:14,fontFamily:"微软雅黑"}}}},series:[{type:"pie",data:[[+vm.currentPercent],[1-+vm.currentPercent]]}]})},changeTap:function(flag){vm.currentFlag=flag,vm.initRound(vm.currentPercent)}}),$scope.$on("checkApp",function(event,first_appinfo){vm.init(first_appinfo.guid)})}])});