"use strict";define(function(require){var app=require("app");require("../../services/appMakeService"),require("common/directives/upload-files");var server=require("common/services/server");app.controller("ModalChangeIcons",["$scope","$mdDialog","http","config","utils","upload","appMakeService",function($scope,$mdDialog,http,config,utils,upload,appMakeService){var vm=$scope.vm={};angular.extend(vm,{guid:$scope.$parent.vm.guid,showuploadurl:!1,filename:"",data:{},init:function(){vm.btnname="",vm.getSysIcon(),vm.getBaseInfo(vm.guid),vm.watchFiles(),vm.imghost=server.system_resource_host+"/"},getBaseInfo:function(guid){appMakeService.getAppBaseInfo(guid).then(function(data){vm.systemicon=data.result.system_icons,console.log("vm.systemicon",vm.systemicon),vm.systemicon.navbar.config=data.result.system_icons.navbar.config;var objurl=data.result.system_icons.navbar.custom_url;vm.systemicon.navbar.custom_url&&(vm.showdiynavicon=!0,vm.uploadeddiyhref=objurl.host+objurl.dir+objurl.filepath+objurl.filename),data.result.application.system_icon_url?(vm.uploadedhref=data.result.application.system_icon_url,vm.btnname="重新上传",vm.showuploadurl=!0):(vm.disabled=!1,vm.btnname="自定义上传",vm.showuploadurl=!1),console.log(" vm.showuploadurl ",vm.showuploadurl)})},uploaddiyIcon:function(file){vm.uploadloading=!1;var url=config.getAPI("upload");upload(url,file).then(function(resp){vm.uploadloading="complete",utils.success("图标上传成功");var obj=resp.material;vm.uploadeddiyhref=obj.host+obj.dir+obj.filepath+obj.filename,vm.showdiynavicon=!0,vm.systemicon.navbar.flag="diy",vm.selectnavIcon(vm.systemicon.navbar.flag),vm.systemicon.navbar.custom_url=resp.material,console.log("当前上传的图标对象:",vm.systemicon.navbar),vm.uploadedhref=vm.uploadeddiyhref},function(reason){utils.error("该图片上传失败!"),vm.uploadloading="complete"})},watchFiles:function(){$scope.$watch("vm.uploadme",function($files,oldfiles){$files&&vm.uploaddiyIcon($files)})},selectnavIcon:function(index){vm.systemicon.navbar.flag=index,console.log("selectnavIcon flag",vm.systemicon.navbar.flag)},downloadIcon:function(file){vm.uploadloading=!1;var url=config.getAPI("upload");upload(url,file).then(function(resp){vm.uploadloading="complete",utils.success("图标上传成功"),vm.showuploadurl=!0;var obj=resp.material;vm.uploadedhref=obj.host+obj.dir+obj.filepath+obj.filename,vm.btnname=obj.filename,console.log("href",vm.uploadedhref)},function(reason){utils.error("该图片上传失败!"),vm.uploadloading="complete"})},getSysIcon:function(){vm.uploadloading=!1;var url=config.getAPI("getMainUIList");http(url,{method:"get"}).then(function(resp){vm.defaulthref=resp.result.system_default_icon,vm.uploadloading="complete"})},recoverSysDefault:function(){utils.confirm({headTitle:"重置提示",msg:"确定要恢复系统默认图标么?"},function(sure){sure&&(vm.uploadloading=!1,vm.showuploadurl=!1,vm.uploadedhref="",vm.data.system_icon_url="",vm.showdiynavicon=!1,vm.systemicon.navbar.custom_url=null,vm.data.new_system_icons=vm.systemicon,vm.selectnavIcon(" "),appMakeService.updateAppBaseInfo(vm.guid.iconsguid,vm.data).then(function(resp){vm.disabled=!1,vm.btnname="上传我的系统图标",vm.uploadloading="complete"}))})},save:function(){vm.uploadloading=!1,vm.data.system_icon_url=vm.uploadedhref,vm.data.new_system_icons=vm.systemicon,appMakeService.updateAppBaseInfo(vm.guid.iconsguid,vm.data).then(function(resp){utils.success("系统图标设置成功"),vm.uploadloading="complete"}),setTimeout(function(){$mdDialog.hide({systemicon_flag:vm.systemicon.navbar.flag})},2500)},close:function(){$mdDialog.hide.cancel()}}),vm.init()}])});