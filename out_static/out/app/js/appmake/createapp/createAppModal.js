"use strict";define(function(require){require("common/services/localStroge");var app=require("app"),server=require("common/services/server");require("common/modal/modal-header"),app.controller("CreateAppModalCtrl",["$rootScope","$state","$scope","$timeout","$mdDialog","appMakeService","http","config","localStorages","utils","youzanBindService","modalData",function($rootScope,$state,$scope,$timeout,$mdDialog,appMakeService,http,config,localStorages,utils,youzanBindService,modalData){var vm=$scope.vm={};angular.extend(vm,{client:{ios:{showName:"iOS"},android:{showName:"Android"}},istest:!0,versioninfo:{},debug:{},release:{},init:function(guid){server.wxappOpen&&angular.extend(vm.client,{wxapp:{showName:"微信小程序"}}),vm._version=modalData.version,vm.getPackageInfo(guid),appMakeService.getRelVersion(0).then(function(data){data.error_code||(vm.versioninfo.debug=data.result)}),vm.version=server.version,"ecshop"==vm.version&&(vm.getBusinessInfo(),vm.getShopInfo())},getShopInfo:function(){youzanBindService.getYouzanShopInfo().then(function(resp){resp.error_code||(vm.shopinfo=resp.result.shop_info,vm.shopinfo&&!angular.isArray(vm.shopinfo)&&vm.getYouzanAuth())})},getYouzanAuth:function(){appMakeService.getYouzanAuth().then(function(resp){"0"===resp.error_code&&resp.result&&(vm.youzaninfo=resp.result,vm.now=Date.parse(new Date),vm.youzaninfo&&vm.youzaninfo.expireTime&&(vm.overdue_time=vm.youzaninfo.expireTime-vm.now))})},packageLimit:function(){utils.confirm({headTitle:"订购提醒",msg:"你的店铺尚未订购有赞App授权使用，请前往订购!"},function(sure){sure&&(vm.businessinfo&&angular.isArray(vm.businessinfo)&&$state.go("mainLayout.businessAuth"),vm.businessinfo&&!angular.isArray(vm.businessinfo)&&0==vm.businessinfo.is_confirm_pay&&$state.go("mainLayout.noBuyBusinessAuth"),vm.businessinfo&&!angular.isArray(vm.businessinfo)&&1==vm.businessinfo.is_confirm_pay&&$state.go("mainLayout.businessAuth"),$mdDialog.cancel())})},getPackageInfo:function(guid){appMakeService.getPackageInfo(guid).then(function(data){vm.packageinfo=data.result})},close:function(){$mdDialog.cancel()},changePackageType:function(is_release){vm.is_release=is_release,is_release&&!vm.versioninfo.release&&appMakeService.getRelVersion(1).then(function(data){data.error_code||(vm.versioninfo.release=data.result,vm.versioninfo.release.android.display_build_version=!1,vm.versioninfo.release.ios.display_build_version=!1)})},getBusinessInfo:function(){appMakeService.getBusiness().then(function(resp){!resp.error_code&&resp.result&&(vm.businessinfo=resp.result)})},createApp:function(){var url=config.getAPI("dopackage"),obj=this.subData();vm.loading=!1,http(url,{method:"post",data:obj}).then(function(data){if(!data.error_code){localStorages.setObject("packages",data.result),$rootScope.$broadcast("to-build"),data.result.is_release=obj.is_release;var packageId={};vm.is_release?(packageId.ios=vm._version.release.ios&&0==vm._version.release.ios.status?vm._version.release.ios.id:"",packageId.android=vm._version.release.android&&0==vm._version.release.android.status?vm._version.release.android.id:""):(packageId.ios=vm._version.debug.ios&&0==vm._version.debug.ios.status?vm._version.debug.ios.id:"",packageId.android=vm._version.debug.android&&0==vm._version.debug.android.status?vm._version.debug.android.id:""),$mdDialog.hide({name:"create",packageId:angular.extend(packageId,data.result),iosVersion:obj.version_code.ios,androidVersion:obj.version_code.android,is_release:obj.is_release})}vm.loading="complete"})["catch"](function(resp){vm.loading="fail",1006==resp.error_code&&$timeout(function(){$state.go("mainLayout.modifymessage")},3e3)})},subData:function(){var obj={is_release:!!vm.is_release,version_code:{},join_plan:!!vm.is_release||!!vm.join_plan&&vm.join_plan};if(vm.is_release){obj.change_log=vm.change_log;var releaseInfo=vm.versioninfo.release;vm.release.ios&&(obj.version_code.ios={major:releaseInfo.ios.major,minor:releaseInfo.ios.minor,build:releaseInfo.ios.build,display_build_version:releaseInfo.ios.display_build_version,certificate:"self"}),vm.release.android&&(obj.version_code.android={major:releaseInfo.android.major,minor:releaseInfo.android.minor,build:releaseInfo.android.build,display_build_version:releaseInfo.android.display_build_version}),vm.release.wxapp&&(obj.version_code.wxapp={major:releaseInfo.wxapp.major,minor:releaseInfo.wxapp.minor,build:releaseInfo.wxapp.build,display_build_version:releaseInfo.wxapp.display_build_version})}else{var debugInfo=vm.versioninfo.debug;vm.debug.android&&(obj.version_code.android={major:debugInfo.android.major,minor:debugInfo.android.minor,build:debugInfo.android.build}),vm.debug.ios&&(obj.version_code.ios={major:debugInfo.ios.major,minor:debugInfo.ios.minor,build:debugInfo.ios.build}),vm.debug.wxapp&&(debugInfo.wxapp?obj.version_code.wxapp={major:debugInfo.wxapp.major,minor:debugInfo.wxapp.minor,build:debugInfo.wxapp.build}:obj.version_code.wxapp={major:1,minor:0,build:1})}return obj},showProgressPop:function(){this.close();var data={};vm.is_release?(vm._version&&vm._version.release&&vm._version.release.ios&&0===+vm._version.release.ios.status&&(data.packageId={ios:vm._version.release.ios.id},vm._version.release.android&&vm._version.release.android.id&&0===+vm._version.release.android.status&&(data.packageId.android=vm._version.release.android.id),vm._version.release.wxapp&&vm._version.release.wxapp.id&&0===+vm._version.release.wxapp.status&&(data.packageId.wxapp=vm._version.release.wxapp.id)),vm._version&&vm._version.release&&vm._version.release.android&&0===+vm._version.release.android.status&&(data.packageId={android:vm._version.release.android.id},vm._version.release.ios&&vm._version.release.ios.id&&0===+vm._version.release.ios.status&&(data.packageId.ios=vm._version.release.ios.id),vm._version.release.wxapp&&vm._version.release.wxapp.id&&0===+vm._version.release.wxapp.status&&(data.packageId.wxapp=vm._version.release.wxapp.id)),vm._version&&vm._version.release&&vm._version.release.wxapp&&0===+vm._version.release.wxapp.status&&(data.packageId={wxapp:vm._version.release.wxapp.id},vm._version.release.android&&vm._version.release.android.id&&0===+vm._version.release.android.status&&(data.packageId.android=vm._version.release.android.id),vm._version.release.ios&&vm._version.release.ios.id&&0===+vm._version.release.ios.status&&(data.packageId.ios=vm._version.release.ios.id))):(vm._version&&vm._version.debug&&vm._version.debug.ios&&0===+vm._version.debug.ios.status&&(data.packageId={ios:vm._version.debug.ios.id},vm._version.debug.android&&vm._version.debug.android.id&&0===+vm._version.debug.android.status&&(data.packageId.android=vm._version.debug.android.id),vm._version.debug.wxapp&&vm._version.debug.wxapp.id&&0===+vm._version.debug.wxapp.status&&(data.packageId.wxapp=vm._version.debug.wxapp.id)),vm._version&&vm._version.debug&&vm._version.debug.android&&0===+vm._version.debug.android.status&&(data.packageId={android:vm._version.debug.android.id},vm._version.debug.ios&&vm._version.debug.ios.id&&0===+vm._version.debug.ios.status&&(data.packageId.ios=vm._version.debug.ios.id),vm._version.debug.wxapp&&vm._version.debug.wxapp.id&&0===+vm._version.debug.wxapp.status&&(data.packageId.wxapp=vm._version.debug.wxapp.id)),vm._version&&vm._version.debug&&vm._version.debug.wxapp&&0===+vm._version.debug.wxapp.status&&(data.packageId={wxapp:vm._version.debug.wxapp.id},vm._version.debug.android&&vm._version.debug.android.id&&0===+vm._version.debug.android.status&&(data.packageId.android=vm._version.debug.android.id),vm._version.debug.ios&&vm._version.debug.ios.id&&0===+vm._version.debug.ios.status&&(data.packageId.ios=vm._version.debug.ios.id))),data.packageId.is_release=vm.is_release,utils.mdDialog({templateUrl:"appmake/createapp/dabaoModal.html",controller:"DabaoCtrl",locals:{packageData:{packageId:data.packageId,iosVersion:data.iosVersion,androidVersion:data.androidVersion}}})}}),vm.init(config.Appinfo.guid)}])});