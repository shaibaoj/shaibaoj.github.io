"use strict";define(function(require){var app=require("app");require("common/services/server");require("appmake/services/URIService"),app.factory("pageManagerService",["$q","$upload","http","config","utils","URIService","$timeout",function($q,$upload,http,config,utils,URIService,$timeout){var services={};return angular.extend(services,{createPage:function(params){var _this2=this,url=config.getAPI("pageManage.createpage"),defer=$q.defer();return http(url,{method:"post",data:params}).then(function(json){_this2.resetHttp(),defer.resolve(json)}),defer.promise},getPageDetail:function(module_id){var url=config.getAPI("pageManage.pagedetail").replace("{module_id}",module_id);return http(url)["catch"](function(reject){})},getTplDetail:function(module_id,slug){var url=config.getAPI("pageManage.getsharetpldetail"),params={module_id:module_id,slug:slug};return http(url,{method:"get",params:params})["catch"](function(reject){})},types:[{name:"通用页",flag:"standard-link"},{name:"详情页",flag:"detail"},{name:"弹层页",flag:"layer"},{name:"功能页",flag:"func"}],page:{},pageMapping:{},resetHttp:function(){this.page={}},getHook:function(pageId,identity){return this.page[pageId]||(this.page[pageId]={}),this.page[pageId][identity]||(this.page[pageId][identity]={}),this.page[pageId][identity]},requestPageList:function(params){var _this=this,defer=$q.defer(),url=config.getAPI("pageManage.getpagelist"),identity=params.identity,pageId=params.pageId,hook=this.getHook(pageId,identity);return hook.result?defer.resolve():(hook.httpCache||(hook.httpCache=http(url,{params:{type:identity,module_id:"detail"==identity?"":pageId}})),hook.httpCache.then(function(json){var list=angular.copy(json.result);list.forEach(function(page){_this.pageMapping[page.id]=page.name}),hook.result=list,defer.resolve()})),defer.promise},getPages:function(){var typeLength=this.types.length,ajaxCount=0,_this=this,defer=$q.defer(),pageId=URIService.getPageId(),pageResult={},_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_loop=function(){var type=_step.value,identity=type.flag;_this.requestPageList({identity:identity,pageId:pageId}).then(function(result){ajaxCount+=1,pageResult[identity]=_this.page[pageId][identity].result,ajaxCount===typeLength&&defer.resolve(pageResult)})},_iterator=_this.types[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)_loop()}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator["return"]&&_iterator["return"]()}finally{if(_didIteratorError)throw _iteratorError}}return defer.promise},getGroupList:function(){var _this=this,defer=$q.defer(),url=config.getAPI("pageManage.getgrouplist");return http(url,{method:"get"}).then(function(data){_this.groupList=data.result,defer.resolve(data.result)}),defer.promise},fieldlist:{},getPageList:function(type){var defer=$q.defer(),url=config.getAPI("pageManage.getpagelist");return http(url,{method:"get",params:{type:type,module_id:URIService.getPageId()}}).then(function(data){defer.resolve(data)}),defer.promise},getFields:function(model_id,member_group){var _this=this,defer=$q.defer();if(this.fieldlist[model_id+"."+member_group])defer.resolve(this.fieldlist[model_id+"."+member_group]);else{var url=config.getAPI("pageManage.getassociatefield");http(url,{method:"get",params:{model_id:model_id,member_group:member_group}}).then(function(data){_this.fieldlist[model_id+"."+member_group]=data,defer.resolve(data)})}return defer.promise},isPage:function(url){return!!(url&&url.indexOf("module?module_id=")>-1&&url.indexOf("c=0")<0)},isContent:function(url){return!!(url&&url.indexOf("dingdone://module?module_id=")>-1&&url.indexOf("content_id=")>-1&&url.indexOf("{{id}}")<0&&url.indexOf("c=0")<0)},getPageID:function(url){return url.match(/module_id=(\S*)/)[1].indexOf("&")!=-1?url.match(/module_id=(\S*)/)[1].split("&")[0]:url.match(/module_id=(\S*)/)[1]},getShareBind:function(id){var defer=$q.defer(),url=config.getAPI("pageManage.getsharetplbind").replace("{page_id}",id);return http(url,{method:"get"}).then(function(data){defer.resolve(data.result)}),defer.promise},pageNameConfig:{"dingdone://detail/default":"默认详情"},getUriList:function(){var flag=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"navigator",defer=$q.defer(),url=config.getAPI("getadminurilist").replace("{group_key}",flag),_this=this;return this.uriList&&flag==this.uriflag?defer.resolve(_this.uriList):(this.uriflag=flag,http(url).then(function(data){+data.error_code||(_this.uriList=data.result,angular.forEach(_this.uriList,function(uri){_this.pageNameConfig[uri.uri]=uri.name})),defer.resolve(_this.uriList)})),defer.promise},getPageName:function(url,cache){var defaultName=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"默认",name="";if(url)if(this.isPage(url))name=cache?cache[this.getPageID(url)]||defaultName:this.pageMapping[this.getPageID(url)]||defaultName;else{for(var key in this.pageNameConfig)url.indexOf(key)>-1&&(name=this.pageNameConfig[key]);"dingdone://detail/default"==url&&(name="默认详情"),name||(name="自定义链接")}return name},showPageDialog:function(data){var defer=$q.defer(),mapping={},islink="",isContent="",arr=data.url?data.url.split("&"):[];this.isContent(data.url)?isContent=data.url:this.isPage(data.url)?angular.forEach(arr,function(item,index){if(0!=index){var temp=item.split("=");if(temp[1].match(/\{\{(\S*)\}\}/)){var key=temp[1].match(/\{\{(\S*)\}\}/)[1];mapping[temp[0]]={field_key:key}}else mapping[temp[0]]={value:temp[1]}}}):islink=data.url;var modalData=A.extend({editPageId:this.isPage(data.url)?this.getPageID(data.url):"",mapping:mapping,islink:islink,isContent:isContent},data);return utils.mdDialog({controller:"SelectPageCtrl",templateUrl:"appmake/page_design/data/select_page.html",clickOutsideToClose:!0,locals:{modalData:modalData}}).then(function(data){var str="dingdone://module?module_id=";data.isPage&&(data.module_id=data.url,data.url=data.url&&"undefined"!=data.url?str+data.url:""),defer.resolve(data)}),defer.promise}}),services}])});