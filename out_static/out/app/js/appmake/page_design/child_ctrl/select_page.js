"use strict";define(function(require){var app=require("app");require("../services/page_design_service"),require("appmake/services/pageManagerService"),require("common/services/modelService"),require("common/modal/modal-header"),require("common/modal/modal-footer"),require("common/directives/form-custom"),require("common/directives/uri-set"),require("common/directives/dingdone-uri"),require("common/directives/model/dingdone-bind"),require("common/services/page_params_service"),require("common/directives/select-content"),app.controller("SelectPageCtrl",function($scope,$mdSidenav,$timeout,utils,config,http,$q,PageDesignService,modalData,$mdDialog,pageManagerService,URIService,PageParamesService,modelService){var vm=$scope.vm={};angular.extend(vm,{model:modalData.model||"",uriflag:modalData.uriflag,pageType:modalData.pageType,groupPageType:modalData.groupPageType||"",currentPageId:modalData.currentPageId,editPageId:modalData.editPageId,pageModelId:modalData.pageModelId,compConfig:modalData.compConfig,componentId:modalData.componentId,list:modalData.list,showContent:modalData.showContent,page:{},mapping:modalData.mapping||{},islink:modalData.islink||"",isContent:modalData.isContent||"",defaultIndex:0,pageUrl:modalData.pageUrl||"",showDelete:modalData.showDelete||"",isCheck:!0,types:[{name:"通用页",flag:"standard-link"}],url:"",bindKeyList:[],init:function(){vm.initData()},getDetailPageData:function(){var _this=this;pageManagerService.getPages().then(function(json){vm.page=json,vm.formatPage(),!vm.editPageId||vm.islink||vm.isContent?vm.isContent?(vm.url=vm.isContent,$scope.selectedIndex=vm.types.length):vm.islink?(vm.url=vm.islink,$scope.selectedIndex=vm.types.length+1):$scope.selectedIndex=0:(vm.initTap(vm.editPageId),_this.currentPage={id:vm.editPageId},vm.editPageId&&vm.selectPage(_this.currentPage))})},pageFormConfig:{normal:["ListUI10"],link:["html5"],submodules:["submodules1","submodules2","submodules3","submodules_tabbar","submodules_sliding","submodules_detail_column_container"]},pageFormName:{detail:{normal:"详情页",submodules:"组合页"},standard:{normal:"普通页",submodules:"组合页",link:"链接页"},"standard-link":{normal:"普通页",submodules:"组合页",link:"链接页"}},formatPage:function(){angular.forEach(vm.types,function(type){"standard-link"!=type.flag&&"standard"!=type.flag&&"detail"!=type.flag||!function(){var obj={};angular.forEach(vm.page[type.flag],function(page){angular.forEach(vm.pageFormConfig,function(val,key){var bool=_.find(val,function(uniqueid){return uniqueid==page.uniqueid});bool&&(obj[key]?"":obj[key]=[],obj[key].push(page))})}),vm.page[type.flag]=obj}()})},initTap:function(pageId){var isCurrentIndex=void 0;angular.forEach(vm.types,function(type,index){var flag=angular.copy(type.flag);"standard-link"!=flag||vm.page[flag]||(flag="standard");var standardPageIds=[];"standard-link"==flag||"standard"==flag||"detail"==flag?angular.forEach(vm.pageFormConfig,function(val,key){angular.forEach(vm.page[flag][key],function(page){standardPageIds.push(page.id)})}):standardPageIds=_.map(vm.page[flag],function(pageInfo){return pageInfo.id});var isCurrent=_.find(standardPageIds,function(id){return id==pageId});isCurrent&&(isCurrentIndex=index)}),vm.defaultIndex=isCurrentIndex||0,$scope.selectedIndex=isCurrentIndex||0},initData:function(){switch(vm.componentId&&(vm.modalName=!0),vm.pageType){case"zuhe":vm.isHasOrg=!0,"detail_group"==vm.groupPageType?vm.types.push({name:"详情页",flag:"detail"}):vm.types.push({name:"功能页",flag:"func"});break;case"daohang":vm.isHasNav=!0,vm.types.push({name:"详情页",flag:"detail"}),vm.types.push({name:"功能页",flag:"func"});break;case"shake":vm.isHasShake=!0,vm.types.push({name:"详情页",flag:"detail"}),vm.types.push({name:"功能页",flag:"func"});break;case"tanceng":vm.isHasDetail=!0,vm.types.push({name:"详情页",flag:"detail"}),vm.types.push({name:"功能页",flag:"func"}),vm.pageModelId&&vm.types.push({name:"弹层页",flag:"layer"});break;case"push":vm.isHasDetail=!0,vm.types.push({name:"功能页",flag:"func"});break;default:vm.isHasDetail=!0,vm.types.push({name:"详情页",flag:"detail"}),vm.types.push({name:"功能页",flag:"func"})}vm.getDetailPageData()},selectPage:function(page,type){this.currentPage&&page.id==this.currentPage.id||(vm.mapping={}),"detail"!=type&&delete vm.mapping.content_id;var _this=this;this.currentType=type,this.currentPage=page,this.hideTip=!0,PageParamesService.getList(page.id).then(function(pageParamList){vm.bindKeyList=pageParamList,_this.openRight()}),pageManagerService.getPageDetail(page.id).then(function(data){vm.viewId=data.result.view_id}),vm.url=""},openRight:function(){$mdSidenav("right").open()},closeRight:function(){$mdSidenav("right").close()},setParamString:function(){var str="";for(var key in vm.mapping)vm.mapping[key]&&void 0!=vm.mapping[key].field_key&&""!=vm.mapping[key].field_key?str+="&"+key+"={{"+vm.mapping[key].field_key+"}}":vm.mapping[key]&&vm.mapping[key].value&&(str+="&"+key+"="+vm.mapping[key].value);return"detail"===this.currentType&&str.indexOf("&content_id={{id}}")==-1&&(str+="&content_id={{id}}"),this.currentPage?this.currentPage.id+str:(vm.isCheck=!1,void utils.error("请选择界面！"))},cancel:function(){$mdDialog.cancel()},resetUrl:function(){$mdDialog.hide("")},saveDetail:function(){vm.isCheck=!0;var obj={};if(vm.url)obj={url:vm.url};else{var url=this.setParamString();obj={url:url,isPage:!0,viewId:vm.viewId}}vm.isCheck&&$mdDialog.hide(obj)},save:function(){vm.url?pageManagerService.isContent(vm.url)?$scope.$broadcast("saveContent",{flag:"saveDetail"}):$scope.$broadcast("saveUri",{flag:"saveDetail"}):vm.saveDetail()}}),$scope.$on("saveDetail",function($event,url){vm.url=url,vm.saveDetail()}),vm.init()})});
