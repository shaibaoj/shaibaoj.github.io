"use strict";define(function(require){var app=require("app");app.factory("PageDesignService",function($q,http,config,utils,$timeout){var services={rowLayout:{up:{name:"上",value:1},middle:{name:"中",value:3},down:{name:"下",value:2}},form_scheme:{},attribute_values:{},pageparams:{},appglobalparams:null,ModuleCategoryList:{},widgetList:{},cacheFormScheme:{},init:function(){var widgetTypes=Object.keys(this.widgetList),_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=widgetTypes[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var widgetType=_step.value;this.getWidgetList(widgetType)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator["return"]&&_iterator["return"]()}finally{if(_didIteratorError)throw _iteratorError}}},getWidgetList:function(type){var deferred=$q.defer(),promise=deferred.promise,_this=this,viewKeyHash={topbar:"navbar_menus",bottombar:"bottom_bar_menus",floatbar:"float_bar_menus",listui:"listui_widgets",detail:"layout_widgets",header:"header_widgets",sku:"sku_widgets",placeholder:"place_widgets"},url=config.getAPI("views.getWidgetList").replace("{view_key}",viewKeyHash[type]);return http(url).then(function(json){_this.widgetList[type]=json.result.views,deferred.resolve(_this.widgetList[type])}),promise},getWidgetListBytpl:function(type){var deferred=$q.defer(),promise=deferred.promise,_this=this,viewKeyHash={compose:"layout_widget",formcompose:"form_group_widgets",submit:"form_submit_layouts",forms:"forms"},url=config.getAPI("views.getWidgetListBytpl").replace("{view_key}",viewKeyHash[type]);return http(url).then(function(json){_this.widgetList[type]=json.result,deferred.resolve(_this.widgetList[type])}),promise},getControlList:function(type,tpl){return"tpl"==tpl?this.getWidgetListBytpl(type):this.getWidgetList(type)},setCurrentComp:function(compInfo){this.currentComp=compInfo},getComponentCategoryList:function(category_key){var pageKey="?parent="+category_key,deferred=$q.defer(),promise=deferred.promise,_this=this;if(this.ModuleCategoryList[category_key])deferred.resolve(_this.ModuleCategoryList[category_key]);else{var url="function_search"==category_key?config.getAPI("pagedesign.search_list"):config.getAPI("pagedesign.category_list")+pageKey;http(url).then(function(resp){_this.ModuleCategoryList[category_key]=resp.result,deferred.resolve(resp.result)})}return promise},getnormalcomponent:function(){var _this=this,category_key="cmp_general";return _this.getComponentCategoryList(category_key)},getdetailcomponent:function(){var _this=this,category_key="cmp_detail";return _this.getComponentCategoryList(category_key)},getsearchcomponent:function(){var _this=this,category_key="function_search";return _this.getComponentCategoryList(category_key)},getCompData:function(){var url=config.getAPI("pagedesign.getCompData").replace("{comp_id}",this.currentComp.id),deferred=$q.defer(),promise=deferred.promise;return http(url).then(function(json){deferred.resolve(json.result)}),promise},saveData:function(data){var flag=arguments.length>1&&void 0!==arguments[1]&&arguments[1],url=config.getAPI("pagedesign.setCompData").replace("{comp_id}",this.currentComp.id);return http(url,{method:"post",data:data}).then(function(json){+json.error_code?utils.error(json.error_message):!flag&&utils.success("保存成功")})},saveStyle:function(data){var flag=arguments.length>1&&void 0!==arguments[1]&&arguments[1],deferred=$q.defer(),promise=deferred.promise,url=config.getAPI("pagedesign.setCompStyle").replace("{comp_id}",this.currentComp.id);return http(url,{method:"post",data:{views:data}}).then(function(json){json.error_code?utils.error(json.error_message):"notip"!=flag&&utils.success("保存成功"),deferred.resolve()}),promise},deleteComponent:function(pageId,compId){var url=config.getAPI("pagedesign.deleteComponent"),deferred=$q.defer(),promise=deferred.promise;return utils.confirm({headTitle:"删除提醒",msg:"确定删除该组件吗?"},function(sure){sure&&http(url,{method:"post",data:{id:compId,module_id:pageId}}).then(function(json){json.error_code?utils.error(json.error_message):(utils.success("删除成功"),deferred.resolve())})}),promise},getAppGlobalparams:function(){var url=config.getAdminAPI("pagedesign.AppGlobalParam"),_this=this;return!this[url+"defer"]&&(this[url+"defer"]=$q.defer()),this.appglobalparams&&"resolve"==this[url]?this[url+"defer"].resolve(this.appglobalparams):"undefined"==typeof this[url]&&(this[url]="request",http(url).then(function(json){_this[url+"defer"].resolve(json.result),_this.appglobalparams=json.result,_this[url]="resolve"})),this[url+"defer"].promise},updateAttributeValues:function(pageViewId,pageViews){this.attribute_values[pageViewId]=pageViews},getSpecialAttributeValues:function(view_id,view_type){var deferred=$q.defer(),apiKey="";apiKey="normal"==view_type||"detail"==view_type||"function"==view_type?"views.getNormalAttributeValues":"group"==view_type||"detail_group"==view_type?"views.getGroupAttributeValues":"views.getAttributeValues";var url=config.getAdminAPI(apiKey).replace("{app_view_id}",view_id)+"?need_form_scheme=1";return http(url).then(function(json){deferred.resolve(angular.copy(json.result))}),deferred.promise},getAttributeValues:function(view_id,forbidden_cache){var deferred=$q.defer(),_this=this;if(this.attribute_values[view_id]&&!forbidden_cache)deferred.resolve(this.attribute_values[view_id]);else{var url=config.getAdminAPI("views.getAttributeValues").replace("{app_view_id}",view_id);http(url).then(function(json){deferred.resolve(json.result),_this.attribute_values[view_id]=json.result})}return deferred.promise},getFormScheme:function(view_key){var url=config.getAdminAPI("views.getView").replace("{view_key}",view_key),deferred=$q.defer(),_this=this;return this.form_scheme[view_key]?deferred.resolve(angular.copy(this.form_scheme[view_key])):http(url).then(function(json){var form_scheme=json.result.form_scheme;_this.form_scheme[view_key]=form_scheme,deferred.resolve(angular.copy(form_scheme))}),deferred.promise},getFormSchemeWithUuid:function(view_key){var url=config.getAdminAPI("views.getView").replace("{view_key}",view_key),deferred=$q.defer(),_this=this;return http(url).then(function(json){_this.form_scheme[view_key]=json.result.form_scheme,deferred.resolve(angular.copy(json.result))}),deferred.promise},getWeightViewId:function(view_key){var url=config.getAdminAPI("views.getView").replace("{view_key}",view_key),deferred=$q.defer();return http(url).then(function(json){deferred.resolve(json.result)}),deferred.promise},getMultipleView:function(view_key,count){var url=config.getAdminAPI("views.getTool"),deferred=$q.defer();return http(url,{method:"post",data:{action:"views",view_key:view_key,count:count}}).then(function(json){deferred.resolve(json.result)}),deferred.promise},getWidgetForPreview:function(page_view_id,component_view_id){var currentPageAttrValue=this.attribute_values[page_view_id],currentCompAttrValue=currentPageAttrValue[component_view_id],extendLayoutViewId=currentCompAttrValue.tile_widget,currentExtendLayoutAttrValue=currentPageAttrValue[extendLayoutViewId],rowLayout=Object.keys(this.rowLayout),result={};return currentExtendLayoutAttrValue&&angular.forEach(rowLayout,function(layout){currentExtendLayoutAttrValue[layout]&&angular.forEach(currentExtendLayoutAttrValue[layout],function(row_view_id){if(row_view_id){var row=currentPageAttrValue[row_view_id],left=row&&row.left?row.left:[],center=row&&row.center?row.center:[],right=row&&row.right?row.right:[];result[row_view_id]=left.concat(center,right)}})}),result},formatViewsData:function(json){var data={views:json.result.views,binding_views:json.result.enabled_binding_views,event_views:json.result.enabled_event_views};return data},getBindData:function(bindView,bindOrder){var defer=$q.defer(),keyList=[],mapping={},control={};if(bindOrder)angular.forEach(bindOrder,function(fieldId){var exist=bindView[fieldId]||{};keyList.push({key:fieldId,name:exist.name,data_types:exist.data_types,widget_types:exist.widget_types}),mapping[fieldId]=exist.__binding__||{};var uiControl=exist.__ui_control__;uiControl&&Object.keys(uiControl).length||(uiControl={}),control[fieldId]=uiControl,control[fieldId].view=exist.view});else for(var fieldId in bindView){var exist=bindView[fieldId];keyList.push({key:fieldId,name:exist.name,data_types:exist.data_types}),mapping[fieldId]=exist.__binding__||{};var uiControl=exist.__ui_control__;uiControl&&Object.keys(uiControl).length||(uiControl={}),control[fieldId]=uiControl,control[fieldId].view=exist.view}return defer.resolve({keyList:keyList,mapping:mapping,control:control}),defer.promise},getEventBindData:function(bindView,bindOrder){var defer=$q.defer(),keyList=[],mapping={};return angular.forEach(bindOrder,function(fieldId){var exist=bindView[fieldId];keyList.push({key:fieldId,name:exist.name}),mapping[fieldId]={default_uri:exist.__event__?exist.__event__.default_uri:""}}),defer.resolve({keyList:keyList,mapping:mapping}),defer.promise},getFormViewsScheme:function(viewkey,rowid){var defer=$q.defer(),cache=this.cacheFormScheme[rowid],_this=this;if(cache)defer.resolve(cache);else{var url=config.getAdminAPI("views.getFormViews").replace("{view_key}",viewkey);http(url).then(function(_json){_this.cacheFormScheme[rowid]=_json.result,defer.resolve(_json.result)})}return defer.promise},getCacheFormScheme:function(rowid){return this.cacheFormScheme[rowid]},getFormViewConfig:function(uniqueid){var defer=$q.defer(),url=config.getAdminAPI("pagedesign.config").replace("{config_key}",uniqueid);return http(url).then(function(_json){defer.resolve(_json.result.tabs)}),defer.promise}};return services.init(),services})});