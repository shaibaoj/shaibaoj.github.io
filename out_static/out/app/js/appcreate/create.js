"use strict";define(function(require){var app=require("app");require("common/services/server");require("common/services/appmake/baseinfo"),require("common/modal/app_icon"),require("common/modal/app_startup"),require("../appcreate/directive/prossinganimate"),require("../appcreate/directive/modal-import"),app.controller("ModuleDiyCreateCtrl",["$scope","$modal","$timeout","$state","$stateParams","$interval","utils","upload","config","http","appBase","appMakeService",function($scope,$modal,$timeout,$state,$stateParams,$interval,utils,upload,config,http,appBase,appMakeService){var vm=$scope.vm={};angular.extend(vm,{init:function(){console.log($stateParams,"$stateParams"),vm.TIME_DELAY=5e3,$stateParams.module_id||$stateParams.template_id?vm.getModalInfo():vm.loading=!0},getModalInfo:function(){vm.loading=!1;var url=config.getAPI("createApp.create");http(url,{method:"post",data:{productId:$stateParams.template_id||$stateParams.module_id}}).then(function(data){console.log(data,"从返回的app名称图标启动图信息"),!+data.error_code&&data.result?vm.initTemplate(data.result):vm.loading="fail"})},initTemplate:function(res){vm.modal_tem=res,vm.app_name=res.name,vm.initStartUpPicData(res),vm.initAppIcon(res),vm.loading="complate"},initStartUpPicData:function(baseinfo){vm.startupValue={},vm.startupValue.startup_pic=baseinfo.startup.image,vm.startupValue.startup_type=baseinfo.startup.type,vm.startupValue.effect=baseinfo.startup.effect,vm.startupValue.text_size=baseinfo.startup.copyright.text_size,vm.startupValue.text_color=baseinfo.startup.copyright.text_color,vm.startupValue.copyright=baseinfo.startup.copyright.content,vm.startupValue.isCopyrightOpen=baseinfo.startup.copyright||!0,vm.app_start_icon=utils.getImgUrl(baseinfo.startup.image)},initAppIcon:function(res){vm.app_icon=utils.getImgUrl(res.icon)},requirelength:function(){vm.app_name.length>10&&(utils.error("APP名称限制为1-20个字符"),vm.app_name=vm.app_name.substr(0,vm.app_name.length-1))},checkInfo:function(){return vm.app_name?vm.app_name&&this.appnamecheck()?(utils.error("您输入的App名称含有非法字符!"),!1):vm.app_icon?!!vm.app_start_icon||(utils.error("请上传App启动图"),!1):(utils.error("请上传App图标"),!1):(utils.error("请输入App名称"),!1)},createConfirm:function(){if(($stateParams.template_id||$stateParams.module_id)&&vm.checkInfo()&&vm.importApp(),console.log($stateParams.module_id,"$stateParams.module_id"),!$stateParams.template_id&&!$stateParams.module_id&&vm.checkInfo()){var obj=vm.collectParam(),create_obj=obj.data;vm.ajaxCreateApp(create_obj),console.log(create_obj,"创建APP要提交的create_obj")}},ajaxCreateApp:function(obj){var url=config.getAPI("createApp.create");console.log(obj,"创建app要上传的obj"),vm.loading=!1,http(url,{method:"post",data:obj}).then(function(data){+data.error_code||$stateParams.module_id?utils.error("创建app失败!"):utils.success("创建成功!").then(function(){appMakeService.resetAppList(),$state.go("mainLayout.index")})})},importApp:function(){vm.importStatue=0,vm.animateMove=!0,vm.moduleStart=!0,vm.loading=!1;var url=config.getAPI("createApp.importApp");http(url,{method:"post",data:vm.collectParam(!0)}).then(function(data){data.error_code?(utils.error("导入app失败!"),vm.importStatue=1):(vm.getPackageStatus(),vm.timer=$interval(function(){vm.getPackageStatus()},vm.TIME_DELAY),appMakeService.resetAppList())})},getPackageStatus:function(){var url=config.getAPI("createApp.appQueue");http(url).then(function(resp){resp.result&&"success"==resp.result.app_template.status?(vm.importStatue=2,vm.animateMove=!1,vm.moduleStart=!1,$interval.cancel(vm.timer)):resp.result&&"failed"==resp.result.app_template.status?(vm.importStatue=1,vm.animateMove=!1,vm.moduleStart=!1,$interval.cancel(vm.timer)):"null"==String(resp.result)&&($interval.cancel(vm.timer),$state.go("loginLayout.userlogin"))})},collectParam:function(bool){vm.startUpObj=vm.startUpObj?vm.startUpObj:vm.modal_tem.startup,vm.app_icon_obj=vm.app_icon_obj?vm.app_icon_obj:vm.modal_tem.icon,console.log(vm.startUpObj,"vm.startUpObj");var obj={level:"app",data:{name:vm.app_name,icon:vm.app_icon_obj,startup:{type:vm.startUpObj.startup_type||vm.modal_tem.startup.type,image:vm.app_start_icon_obj||vm.modal_tem.startup.image,effect:vm.startUpObj.effect?vm.startUpObj.effect:"1",copyright:bool?vm.startUpObj.copyright:{content:vm.startUpObj.copyright,textSize:vm.startUpObj.text_size,textColor:vm.startUpObj.text_color}}}};return bool&&(delete obj.level,obj.productId=$stateParams.template_id||$stateParams.module_id),obj},goback:function(){window.history.go(-1)},getAppIconConfig:function(guid){appMakeService.getAppIconConfig(guid).then(function(data){vm._appIconConfig=data.result})},showAppIconPop:function(){utils.mdDialog({templateUrl:"appcreate/modal/app_icon.html",controller:"AppIconCtrl",clickOutsideToClose:!0,locals:{modalParams:{appName:vm.app_name,guid:vm.guid,params:vm.iconParams,iconType:"default",icon:vm.app_icon?vm.app_icon:""}}}).then(function(res){res&&"success"===res.status&&(vm.iconType=res.iconType,vm.app_icon_obj=res.icon,vm.app_icon=utils.getImgUrl(res.icon),console.log(vm.app_icon,vm.app_icon),vm.iconParams=res.params,vm.updateIcon())})},updateIcon:function(){if(vm.iconType&&vm.baseinfo&&vm.baseinfo.icon){var data={icon_type:vm.iconType,icon:vm.baseinfo.icon};appMakeService.updateAppBaseInfo(vm.guid,data).then(function(data){data.error_code?utils.error("App图标更新失败!"):utils.success("App图标更新成功!")})["catch"](function(resp){utils.error("App图标更新失败!")})}},showAppStartUpPop:function(){utils.mdDialog({templateUrl:"appcreate/modal/app_startup.html",controller:"AppStartUpCtrl",clickOutsideToClose:!0,locals:{params:{systemStartupConfig:appBase.getSystemStartupConfig(),systemStartupPic:appBase.getSystemStartupPic(),value:vm.startupValue}}}).then(function(res){res&&"success"===res.status&&(console.log(res,"启动图"),vm.startUpObj=res.value,vm.startupValue=res.value,vm.app_start_icon_obj=vm.startUpObj.startup_pic,vm.app_start_icon=utils.getImgUrl(vm.startUpObj.startup_pic),vm.updateStartPic(res.value))})},updateStartPic:function(resp){vm.guid&&resp&&appMakeService.updateAppBaseInfo(vm.guid,resp).then(function(data){data.error_code?utils.error("启动图更新失败!"):utils.success("启动图更新成功!")})["catch"](function(resp){utils.error("启动图更新失败!")})},confirm:function(){vm.importStatue=2,$timeout(function(){$state.go("mainLayout.index")},300)},reImport:function(){vm.importStatue=0,vm.getPackageStatus(),vm.timer=$interval(function(){vm.getPackageStatus()},vm.TIME_DELAY)},appnamecheck:function(){return vm.appNameError=!/^[\u4E00-\u9FA5a-zA-Z0-9_]+$/.test(vm.app_name),vm.appNameError}}),vm.init()}])});