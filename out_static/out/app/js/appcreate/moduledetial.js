"use strict";define(function(require){var app=require("app"),server=require("common/services/server");require("appmake/modal/preview_helper"),require("appmake/modal/temp_buy_record/usetemptip"),require("appcreate/loginmodel"),require("common/services/modulemarket"),require("appmake/services/appMakeService"),app.controller("ModuleDetailCtrl",["$rootScope","$scope","$modal","$timeout","$state","$stateParams","utils","config","http","moduleMarket","$mdDialog","appMakeService",function($rootScope,$scope,$modal,$timeout,$state,$stateParams,utils,config,http,moduleMarket,$mdDialog,appMakeService){var vm=$scope.vm={};angular.extend(vm,{init:function(){vm.getModuleDetial()},getModuleDetial:function(){vm.loading=!1,moduleMarket.getProductDetial($stateParams.product_id).then(function(data){vm.loading=!0,vm.currentModule=data.result,vm.dealCurrentTag(vm.currentModule.tags),$("#content-view").append(vm.currentModule.content)})},previewHelper:function(){$mdDialog.show({controller:"ModalPreviewHelper",templateUrl:"appmake/modal/preview_helper.html",clickOutsideToClose:!0,openFrom:"#preview",closeTo:"#preview"})},dealCurrentTag:function(tag){vm.currentTag=[],angular.forEach(tag.scene,function(item,index){vm.currentTag.push(item.name)}),console.log("vm.currentTag",vm.currentTag)},DingMoneyBuy:function(){var url=server.ding_money_buy+"&product_type=app&product_id="+$stateParams.product_id+"&user_id="+vm.user_id+"&type=template";localStorage.payurl=url,window.location.href=url},freeUse:function(){var url=config.getAPI("user");http(url).then(function(resp){resp.user.user_id&&vm.checkHasApp()})["catch"](function(reject){vm.openLoginModel()})},checkHasApp:function(){vm.hasapp=!1,appMakeService.getAppList().then(function(data){var data=data.result;data&&angular.isArray(data.applications)&&data.applications.length?vm.hasapp=!0:vm.hasapp=!1,vm.hasapp?utils.error("您已经存在App,无法继续创建！"):$state.go("modalMarketLayout.appcreate",{template_id:$stateParams.product_id})})},tempfunction:function(){vm.checkHasApp()},openLoginModel:function(){utils.mdDialog({controller:"LoginModel",templateUrl:"appcreate/modal/loginmodel.html",clickOutsideToClose:!0}).then(function(){vm.tempfunction()})},useMode:function(){if(vm.guid){var item={slug:"app",product:$stateParams.product_id};utils.mdDialog({controller:"UseTempTipCtrl",templateUrl:"appmake/modal/temp_buy_record/usetemptip.html",clickOutsideToClose:!0,locals:{modalData:{tempInfo:item,pageId:$stateParams.id}}})}else vm.freeUse()},goback:function(){window.history.back()}}),vm.init(),$scope.$on("checkUserId",function(event,user_id){console.log(vm.user_id),vm.user_id=user_id}),$scope.$on("checkApp",function(event,first_appinfo){vm.guid=first_appinfo.guid})}])});