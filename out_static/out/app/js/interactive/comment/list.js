"use strict";define(function(require){var app=require("app"),moment=require("moment");require("common/directives/pager-redirect"),require("common/directives/pagination/page1"),app.controller("commentListCtrl",["$rootScope","$scope","$state","$stateParams","http","utils","config","navconfig","$modal",function($rootScope,$scope,$state,$stateParams,http,utils,config,navconfig,$modal){var vm=$scope.vm={};angular.extend(vm,{init:function(){vm.getListData(),vm.selectArr=[],vm.watchCurrentPage(),vm.currentSelected=0,vm.loading="complete"},getListData:function(){var url=config.getAPI("getusercommentlist"),params=this.collectListParam();vm.loading=!1,vm._loading=!1,http(url,{params:params}).then(function(resp){if(resp&&!+resp.error_code){if(!vm.pagination||!vm.pagination.currentPage){var options={per_page:20,current_page:1,total:resp.result.total,total_pages:Math.ceil(resp.result.total/20)};vm.initPagination(options)}vm.listdata=resp.result.data,vm.listdata&&angular.forEach(vm.listdata,function(list){list.submit_date=moment(list.submit_date).format("YYYY-MM-DD HH:mm")}),vm.loading="complete",vm._loading="complete"}})["catch"](function(e){vm.loading="complete"})},check:function(index,id){var isCheck=vm.listdata[index].isCheck;vm.listdata[index].isCheck=!isCheck,vm.currentSelected=isCheck?vm.currentSelected-1:vm.currentSelected+1,vm.currentSelected==vm.listdata.length?vm.isCheckAll=!0:vm.isCheckAll=!1},checkAll:function(){vm.isCheckAll=!vm.isCheckAll,this._select()},cancelAll:function(){vm.isCheckAll=!1,this._select()},_select:function(){angular.forEach(vm.listdata,function(val,key){val.isCheck=vm.isCheckAll}),vm.currentSelected=vm.isCheckAll?vm.listdata.length:0},updatastate:function(bool,num,id,item){if(bool){vm.findCommentId();var url=config.getAPI("updatecommentlist"),params=vm.formatParams(num);item?item.loading=!1:vm.loading=!1,http(url,{method:"post",data:params}).then(function(data){data&&0==data.error_code&&(vm.updataPage(num),vm.selectArr=[],item?item.loading="complete":vm.loading="complete")})["catch"](function(e){vm.selectArr=[],item?item.loading="complete":vm.loading="complete"})}else{var url=config.getAPI("updatecommentlist"),code=0;item?item.loading=!1:vm.loading=!1,code=0==num?1:1==num?2:1,http(url,{method:"post",data:{comment_ids:[id],status:code}}).then(function(data){data&&0==data.error_code&&(angular.forEach(vm.listdata,function(v){id==v.id&&(v.status=code)}),item?item.loading="complete":vm.loading="complete")})["catch"](function(e){item?item.loading="complete":vm.loading="complete"})}},findCommentId:function(){angular.forEach(vm.listdata,function(value){value.isCheck?vm.selectArr.push(value.id):vm.selectArr=_.without(vm.selectArr,value.id)})},formatParams:function(num){var params={comment_ids:vm.selectArr,status:num};return params},updataPage:function(num){angular.forEach(vm.selectArr,function(value){angular.forEach(vm.listdata,function(v){value==v.id&&(v.status=num)})})},delList:function(bool,id,index){if(bool){var ids=[],listIndex=[];vm.isCheckAll?angular.forEach(vm.listdata,function(val){ids.push(val.id)}):(angular.forEach(vm.listdata,function(val,key){val.isCheck&&(ids.push(val.id),listIndex.push(key))}),ids.length||utils.error("请选择要删除的内容")),utils.confirm({headTitle:"删除提醒",msg:"确定删除选中的数据吗?"},function(sure){if(sure){var url=config.getAPI("deleteusercomment");vm.loading=!1,http(url,{method:"delete",data:{comment_ids:ids}}).then(function(data){if(data.error)utils.error(data.error.message);else{if(vm.isCheckAll)vm.listdata=[],vm.isCheckAll=!1,vm.nodata=!0;else{vm.listdata.splice(index,1);var newdata=[];angular.forEach(vm.listdata,function(value){value.isCheck||newdata.push(value)}),vm.listdata=newdata,!vm.listdata.length&&(vm.nodata=!0)}vm.currentSelected=0}vm.loading="complete"})["catch"](function(reject){vm.loading="complete"})}})}else utils.confirm({headTitle:"删除提醒",msg:"确定删除选中的数据吗?"},function(sure){if(sure){var url=config.getAPI("deleteusercomment");vm.loading=!1,http(url,{method:"delete",data:{comment_ids:[id]}}).then(function(data){data.error?utils.error(data.error.message):(vm.listdata.splice(index,1),!vm.listdata.length&&(vm.nodata=!0),vm.loading="complete")})["catch"](function(reject){vm.loading="complete"})}})},initPagination:function(options){vm.pagination={totalItems:options.total,numPages:options.last_page,itemsPerPage:options.per_page,maxSize:options.total_pages,currentPage:options.current_page}},watchCurrentPage:function(){var _this=this;$scope.$watch("vm.pagination.currentPage",function(currentpage,old){currentpage&&old&&_this.getListData()})},collectListParam:function(){var params={};return vm.pagination&&vm.pagination.currentPage&&(params.page=vm.pagination.currentPage,params.count=vm.pagination.itemsPerPage,vm.isCheckAll=!1,vm.currentSelected=!1),params}}),$scope.$on("checkApp",function(event,first_appinfo){vm.init()})}])});