"use strict";define(function(require){var app=require("app"),moment=require("moment");require("common/controllers/imageSizeModal"),app.factory("utils",["$rootScope","$q","$http","$modal","$timeout","$state","config","navconfig","$mdDialog","$mdToast","$document",function($rootScope,$q,$http,$modal,$timeout,$state,config,navconfig,$mdDialog,$mdToast,$document){var keyMap={win:17,mac:91};return{mdDialog:function(setting){var openDialog=$mdDialog.show({controller:setting.controller,templateUrl:setting.templateUrl,clickOutsideToClose:!!A.isUndefined(setting.clickOutsideToClose)||setting.clickOutsideToClose,parent:setting.parent,openFrom:setting.openFrom,closeTo:setting.closeTo,locals:setting.locals,multiple:setting.multiple||!0,fullscreen:setting.fullscreen});return openDialog},alert:function(options,callback){if(!options.msg)return!1;var openModel=$modal.open({templateUrl:"common/directives/alert_tpl.html",windowClass:options.winClass||"tipWindow",index:10,controller:["$scope",function($scope){$scope.close=function(){openModel.close(!1),$.isFunction(callback)&&callback()},$scope.type=options.type||"success",$scope.msg=options.msg}],backdrop:!1});$timeout(function(){openModel.close(close),$.isFunction(callback)&&callback()},options.delay||2e3)},toast:function(options,setting){if(!options.msg)return!1;var defaultsetting={type:"success",position:"top",posId:"body",delay:2e3,toastClass:"dingdone-toast"};return setting&&(setting=angular.extend(defaultsetting,setting)),$mdToast.show({templateUrl:"common/directives/alert_tpl.html",controller:["$scope",function($scope){$scope.msg=options.msg,$scope.type=options.type}],position:defaultsetting.position,parent:defaultsetting.posId,toastClass:defaultsetting.toastClass,hideDelay:defaultsetting.delay})},confirm:function(options,callback){var defaultsetting={msgClass:"message",msg:"提示",headTitle:"删除",href:"",sureName:"确定",sureClass:"btn-danger",cancelName:"取消",cancelClass:"btn-cancel",needCancl:!0,icon:"icon-trash"};$mdDialog.show({templateUrl:"common/directives/confirm_tpl.html",parent:options.parent,multiple:!0,controller:["$scope",function($scope){Object.assign($scope,defaultsetting,options),$scope.textLines="string"==typeof options.msg?[options.msg]:options.msg,$scope.close=function($event){$event&&$event.preventDefault(),$mdDialog.cancel(),$.isFunction(callback)&&callback(!1)},$scope.sure=function($event){$event&&$event.preventDefault(),$mdDialog.hide(),$.isFunction(callback)&&callback(!0)}}]})},success:function(msg,setting){return this.toast({msg:msg,type:"success"},setting)},error:function(msg,setting){return this.toast({msg:msg,type:"error"},setting)},clearCache:function(guid,user_id){var url=config.getAPI("clearcache").replace("{guid}",guid).replace("{user_id}",user_id);$http({method:"post",url:url}).success(function(data){}).error(function(data){})},getImgUrl:function(obj,width,height,mode){var url="";if(obj&&!angular.isObject(obj)&&(obj=JSON.parse(obj)),obj){var obj=obj.material?obj.material:obj,mode=mode||1;obj.source=obj.source||"","qiniu"==obj.source||"upyun"==obj.source?(obj.host&&(url=obj.host+obj.dir+obj.filepath+obj.filename+"?imageView2/"+mode),width&&(url+="/w/"+width),height&&(url+="/h/"+height)):"youzan"==obj.source?obj.host&&(url=obj.host+obj.dir+obj.filepath+obj.filename):"material"==obj.source?(obj.dir=obj.dir||"",url=width?obj.host+obj.dir+width+"x"+height+"/"+obj.filepath+obj.filename:obj.host+obj.dir+obj.filepath+obj.filename):(obj.dir=obj.dir||"",url=obj.host+obj.dir+obj.filepath+obj.filename)}return url},setNavAndBreadcrumb:function(group,child){if(group&&navconfig.navmenus[group.groupUnique]&&(angular.forEach(navconfig.navmenus,function(value,key){value.isopen=!1,value.openClass=""}),navconfig.navmenus[group.groupUnique].isopen=!0,navconfig.navmenus[group.groupUnique].openClass="panel-open"),group&&child){var breadcrumb=child.breadcrumb||null;$rootScope.currentMenu={childunique:child.unique},angular.isArray(breadcrumb)&&($rootScope.breadcrumb=angular.copy(breadcrumb),group.groupName&&$rootScope.breadcrumb.unshift({name:group.groupName}))}child||($rootScope.currentMenu={childunique:null}),group&&($rootScope.isOperateMode=group.isOperateMode)},dealBreadcrumb:function(navmenus,breadcrumb){var breadcrumbarr=[],parent="",son="",homename="",homeurl="";for(var routename in breadcrumb)if($state.current.name==routename){if(son=breadcrumb[routename],parent=son.dynamicHomeGroupKey?"design"==$rootScope.currentmode?navmenus.makehome:navmenus.operatehome:"content"==son.groupkey?navmenus.content.childs.indexOf($state.params.model_id)!=-1?navmenus.content:navmenus.ecshop:navmenus[son.groupkey],homename="design"==parent.mode?"制作主页":"运营主页",homeurl="design"==parent.mode?$state.href("mainLayout.index"):$state.href("mainLayout.operateindex"),breadcrumbarr.push({name:homename,href:homeurl}),son.hidegroup||breadcrumbarr.push({name:parent.name,href:parent.href,active:!0}),son.childbread.split("").indexOf(",")!=-1){var temparr=son.childbread.split(","),tempKeys=Object.keys($state.params),tempitem="",tempParamsData="";angular.forEach(temparr,function(item,index){var reg=/^\{/gi,reg2=/\}$/gi;if(reg.test(item)){if(tempitem=item.replace(reg,"").replace(reg2,""),tempKeys.indexOf(tempitem)!=-1){tempParamsData=$state.params[tempitem],son.isdynamic&&son.mapping&&(son.mapping[tempParamsData]=$state.params);for(var menu in navmenus)if(menu==tempParamsData){breadcrumbarr.push({name:navmenus[menu].name,href:navmenus[menu].href,active:!0});break}}}else if(""!=item)for(var routename in breadcrumb)if(item==breadcrumb[routename].name){breadcrumbarr.push({name:item,href:$state.href(routename),active:!0});break}})}else{var tempurl="";for(var routename in breadcrumb)if(son.childbread===breadcrumb[routename].name){tempurl=$state.href(routename);break}""!=tempurl&&breadcrumbarr.push({name:son.childbread,href:tempurl,active:!0})}if(son.name!=parent.name&&!son.ishome)if(son.isdynamic&&son.mapping){var tempParms=_.values($state.params),tempname="";for(var key in son.mapping){if(son.mapping.hasOwnProperty("id")&&"id"!=key){""!=son.mapping[key].id?navmenus[key]&&(tempname="编辑"+navmenus[key].name):navmenus[key]&&(tempname="新增"+navmenus[key].name),breadcrumbarr.push({name:tempname,active:!0}),son.mapping={},son.mapping.id="";break}if(tempParms.indexOf(key)!=-1){breadcrumbarr.push({name:son.mapping[key],active:!0});break}}}else breadcrumbarr.push({name:son.name,active:!0});if(breadcrumbarr.length>2){for(var i=0;i<breadcrumbarr.length-1;i++)breadcrumbarr[i].active=!1;breadcrumbarr[breadcrumbarr.length-1].href=""}else son.ishome?breadcrumbarr[0].href="":breadcrumbarr[1].href="";break}return breadcrumbarr},randomString:function(len){len=len||32;for(var $chars="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",maxPos=$chars.length,salt="",i=0;i<len;i++)salt+=$chars.charAt(Math.floor(Math.random()*maxPos));return salt},toUTC:function(date){var date=date?moment(date).format("YYYY-MM-DDTHH:mm:ss+08"):"";return date},formatDate:function(utcstr,format){var str,_format=function(num){return num<10?num="0"+num:num+="",num},date=moment(utcstr),year=date.year(),month=date.month()+1,dd=date.date(),hour=date.hour(),min=date.minutes(),sec=date.second();switch(format){case"YYYY-MM-DD hh:mm:ss":str=_format(year)+"-"+_format(month)+"-"+_format(dd)+" "+_format(hour)+":"+_format(min)+":"+_format(sec);break;case"YYYY-MM-DD hh:mm":str=_format(year)+"-"+_format(month)+"-"+_format(dd)+" "+_format(hour)+":"+_format(min);break;case"MM-DD hh:mm":str=_format(month)+"-"+_format(dd)+" "+_format(hour)+":"+_format(min);break;case"hh:mm:ss":str=_format(hour)+":"+_format(min)+":"+_format(sec)}return str},angleCalc:function(scale){return 180*Math.atan(scale)/Math.PI},countArr:function(count){for(var arr=[],count=count||3,i=0;i<+count;i++)arr[i]=i;return arr},concat:function(up,down){var resp=[];return D.isArray(up)&&D.isArray(down)&&(resp=up.concat(down)),resp},ceil:function(m,n){return Math.ceil(m/n)},filterHtmlTag:function(str){return str=str.replace(/(\n)/g,""),str=str.replace(/(\t)/g,""),str=str.replace(/(\r)/g,""),str=str.replace(/<\/?[^>]*>/g,"")},isMedium:function(slug){var types=["channel","radio","vod","audio","programme","program"];return $.inArray(slug,types),$.inArray(slug,types)!=-1},inModelList:function(uniqueid){return $.inArray(uniqueid,config.moduleList)!=-1},getColor:function(colorAp){return"#"+colorAp.substr(3)},refreshStateRoute:function(stateKey,stateParams){stateKey&&$state.go(stateKey,stateParams)},listenEvent:function(eventType,callback){var _this=this;$document.on(eventType,function($event){$event.keyCode==keyMap[_this.osPlatForm()]&&(callback&&callback(),$rootScope.$digest())})},osPlatForm:function(){var platform=window.navigator.platform.toLocaleLowerCase();return platform.indexOf("mac")!=-1?"mac":platform.indexOf("win")!=-1?"win":void 0},po_Last_Div:function(obj){if(window.getSelection){obj.focus();var range=window.getSelection();range.selectAllChildren(obj),range.collapseToEnd()}else if(document.selection){var range=document.selection.createRange();range.moveToElementText(obj),range.collapse(!1),range.select()}},verify_name_standard:function(verify_string){var name_standard_regex=/^[_a-zA-Z]\w*$/;return verify_string=verify_string||"",name_standard_regex.test(verify_string)}}}]),app.factory("upload",["$q","$upload","$mdDialog","config","utils",function($q,$upload,$mdDialog,config,utils){return function(url,file,width,height,imgMark){var sizeLimit;"number"==typeof imgMark?sizeLimit=imgMark:imgMark?(sizeLimit=config.imageUploadSize[imgMark].size||config.imageUploadSize.defaultImg.size,config.imageUploadSize[imgMark].type&&(imgType=config.imageUploadSize[imgMark].type)):(imgMark="defaultImg",sizeLimit=config.imageUploadSize.defaultImg.size);var filesize,format,imgType,deferred=$q.defer();return file[0]&&(filesize=file[0].size,format=file[0].type),file.size&&(filesize=file.size,format=file.type),filesize>1024*sizeLimit?(sizeLimit>=1024?sizeLimit=sizeLimit/1024+"M":sizeLimit+="K",$mdDialog.show({templateUrl:"common/imageSizeModal.html",controller:"imageSizeCtrl",multiple:!0,locals:{modalParams:{size:sizeLimit}}}),deferred.reject()):$upload.upload({url:url,method:"post",file:file,data:{type:imgType},fileFormDataName:"file"}).success(function(data){data.url=utils.getImgUrl(data,width,height),deferred.resolve(data)}).error(function(reason){deferred.reject(reason),"appIcon"==imgMark&&4161==reason.error_code?utils.error("请上传PNG格式的图片"):utils.error(reason.error_message)}),deferred.promise}}]),app.factory("mathService",function(){var add=function(a,b){var c,d,e;try{c=a.toString().split(".")[1].length}catch(f){c=0}try{d=b.toString().split(".")[1].length}catch(f){d=0}return e=Math.pow(10,Math.max(c,d)),(mul(a,e)+mul(b,e))/e},sub=function(a,b){var c,d,e;try{c=a.toString().split(".")[1].length}catch(f){c=0}try{d=b.toString().split(".")[1].length}catch(f){d=0}return e=Math.pow(10,Math.max(c,d)),(mul(a,e)-mul(b,e))/e},mul=function(a,b){var c=0,d=a.toString(),e=b.toString();try{c+=d.split(".")[1].length}catch(f){}try{c+=e.split(".")[1].length}catch(f){}return Number(d.replace(".",""))*Number(e.replace(".",""))/Math.pow(10,c)},div=function(a,b){var c,d,e=0,f=0;try{e=a.toString().split(".")[1].length}catch(g){}try{f=b.toString().split(".")[1].length}catch(g){}return c=Number(a.toString().replace(".","")),d=Number(b.toString().replace(".","")),mul(c/d,Math.pow(10,f-e))};return{add:add,subtract:sub,multiply:mul,divide:div}}),app.factory("colorService",function(){var clientToHexWithAlpha=function(str){var obj={},reg=new RegExp("^#[0-9a-fA-F]{8}$");if(reg.test(str)){obj.color="#"+str.substr(3);var alpha=parseInt("0x"+str.substr(1,2))/255;obj.alpha=1==alpha?alpha:alpha.toFixed(2)}return obj},hexToRgba=function(color,alpha){var str=color.replace("#",""),arr=[];return arr.push(parseInt(str.substr(0,2),16)),arr.push(parseInt(str.substr(2,2),16)),arr.push(parseInt(str.substr(4,2),16)),arr.push("undefined"===alpha?1:alpha),"rgba("+arr.join(",")+")"};return{hexToRgb:function(color){var str=color.replace("#",""),arr=[];return arr.push(parseInt(str.substr(0,2),16)),arr.push(parseInt(str.substr(2,2),16)),arr.push(parseInt(str.substr(4,2),16)),"rgb("+arr.join(",")+")"},hexToRgba:hexToRgba,hexToClient:function(color){var alpha="ff",colorNum=color.substr(1);return["#",alpha,colorNum].join("")},clientToHex:function(color){return["#",color.substr(3)].join("")},clientToHexWithAlpha:clientToHexWithAlpha,clientToRgba:function(str){var colorObj=clientToHexWithAlpha(str),colorStr=hexToRgba(colorObj.color,colorObj.alpha);return colorStr},rgbaToClient:function(color){var start=color.indexOf("("),rgba=color.replace(/\s/g,"").slice(start+1).slice(0,-1),rgbaArr=rgba.split(","),result="#",alphaInt=(void 0===rgbaArr[3]?1:rgbaArr[3],(255*(void 0===rgbaArr[3]?1:rgbaArr[3])).toFixed(0)/1),alpha16=alphaInt.toString(16);1==alpha16.length&&(alpha16="0"+alpha16),result+=alpha16;for(var i=0;i<3;i++){var num=(+rgbaArr[i]).toString(16);1==num.length&&(num="0"+num),result+=num}return result}}})});