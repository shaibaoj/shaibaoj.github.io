"use strict";define(function(require){var app=require("app");require("common/services/modelService"),app.directive("dingdoneNav",["$rootScope","$window","$state","navconfig","utils","modelService",function($rootScope,$window,$state,navconfig,utils,modelService){return{scope:{menus:"="},restrict:"EA",templateUrl:"common/directives/dingdone-nav.html",replace:!0,link:function($scope,element,attrs){var vm=$scope.vm=$scope.menus;angular.extend(vm,{isIncludeNavmenus:!1,init:function(){if(vm.checkState(),$window.sessionStorage.isDuplitModel){var state="true"==$window.sessionStorage.isDuplitModel;vm.changeDesighMode(state,"session")}else vm.changeDesighMode(!1,"init")},checkSelect:function(statename){"operate"==$rootScope.currentmode?vm.isoperate=!0:vm.isoperate=!1},checkState:function(){if(angular.forEach(vm.navmenus,function(item){if($state.current.name==item.router_state)if(0!=Object.keys($state.params).length){var tempurl=item.href,currentpath=$state.href($state.current.name,$state.params);currentpath==tempurl&&(vm.sonunique=item.unique,vm.isIncludeNavmenus=!0)}else $state.current.url==item.href&&(vm.sonunique=item.unique,vm.isIncludeNavmenus=!0)}),vm.isIncludeNavmenus||!function(){var currentBreadObj=navconfig.breadcrumb[$state.current.name];currentBreadObj&&currentBreadObj.routerSelectChild?"none"!=currentBreadObj.childbread&&angular.forEach(vm.navmenus,function(item){item.name==currentBreadObj.childbread&&(vm.sonunique=item.unique)}):angular.forEach(navconfig.breadcrumb,function(item,key){$state.current.name==key&&item.dynamicHomeGroupKey?vm.sonunique=vm.isoperate?"operatehome":"makehome":$state.current.name==key&&vm.navmenus&&vm.navmenus[item.groupkey]&&(vm.sonunique=vm.navmenus[item.groupkey].unique)})}(),angular.forEach(vm.navmenus,function(item){item.childs&&item.childs.indexOf(vm.sonunique)!=-1?(vm.parentunique=item.unique,vm.oldunique=item.unique):item.childs&&item.unique==vm.sonunique&&(vm.parentunique=vm.sonunique)}),vm.parentunique){var data={menu:vm.navmenus[vm.parentunique],key:vm.parentunique,son:vm.sonunique};$rootScope.$broadcast("show_sonnavbar",data)}},mouse_enter:function(menu){menu.hoverState=!0},mouse_leave:function(menu){menu.hoverState=!1},dealDynamicMenuSelectIndex:function(modelList){for(var tempIndex=0,i=0;i<modelList.length;i++)if(modelList[i].all_visible){tempIndex=i;break}return tempIndex},dealSonMenu:function(key,menu){var router_state=menu.childs.length?vm.navmenus[menu.childs[0]].router_state:"",modelList=$rootScope.contentMenuList;if(""!=router_state){if("content"==menu.unique){var tempIndex=vm.dealDynamicMenuSelectIndex(modelList.normalmodel);$state.go(router_state,{model_id:menu.childs[tempIndex]})}else if("ecshop"==menu.unique){var _tempIndex=vm.dealDynamicMenuSelectIndex(modelList.shopmodel);$state.go(router_state,{model_id:menu.childs[_tempIndex]})}else $state.go(router_state),$rootScope.isFirstShowContent=!0;var data={menu:menu,key:key};$rootScope.$broadcast("show_sonnavbar",data)}},titleClick:function(key,menu){menu.isgroup&&vm.oldunique?vm.oldunique==menu.unique||(vm.parentunique=vm.navmenus[key].unique):vm.parentunique=vm.navmenus[key].unique,vm.oldunique=vm.parentunique,["content","ecshop"].indexOf(key)<0?vm.dealSonMenu(key,menu):modelService.fetchModelList("normal",!0).then(function(modellist){$rootScope.$broadcast("model_broadcast",modellist),vm.dealSonMenu(key,menu)})},descClick:function(menuid){vm.sonunique=vm.navmenus[menuid].unique},changeMenuState:function(state){var uniqueArr=["pagemange","funcmode","datalist","trigger","shopping"];angular.forEach(uniqueArr,function(item,index){navconfig.navmenus[item].main_show=state}),$window.sessionStorage.isDuplitModel=state,vm.isDuplitModel=!state,$rootScope.isDuplitModel=vm.isDuplitModel},changeDesighMode:function(state,type){console.log("state",state,"type",type),"click"==type&&"true"!=$window.sessionStorage.isShowConfirm?utils.confirm({headTitle:"更换设计模式",msg:"修改配置容易导致当前App功能或界面报错,请谨慎操作!"},function(sure){sure&&(vm.changeMenuState(state),$window.sessionStorage.isShowConfirm=!0)}):vm.changeMenuState(state)}}),vm.init(),$scope.$watch("vm.navmenus",function(newval){vm.checkSelect($state.current.name),vm.checkState()}),$scope.$on("selectcurrentmode",function(event,$modelinfo){var currentmode=$modelinfo;vm.isoperate="operate"==currentmode}),$scope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){vm.isIncludeNavmenus=!1,vm.checkState(),["mainLayout.index","mainLayout.operateindex"].indexOf($state.current.name)!=-1?$rootScope.changeContentPadding=!0:$rootScope.changeContentPadding=!1})}}}])});