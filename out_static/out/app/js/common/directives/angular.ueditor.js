"use strict";define(function(require,exports,module){var app=require("app"),server=require("common/services/server");require("bootstrap.min"),require("jquery.tmpl.min"),require("jquery.modal"),require("ajaxload_new"),require("ajax_upload"),require("ueditor.config"),require("ueditor.all"),require("ueditor.plugins");var NGUeditor;NGUeditor=app,NGUeditor.directive("ueditor",["utils","config","appMakeService",function(utils,config,appMakeService){return{restrict:"C",require:"ngModel",scope:{config:"=",ready:"=",linkmodel:"="},link:function($S,element,attr,ctrl){window.baseUrl=server.API_dingdone,$S.config.UEDITOR_HOME_URL=server.staticCDN+"/js/third-party/ueditor/",config.Appinfo&&config.Appinfo.guid&&(window.GUID=config.Appinfo.guid);var _NGUeditor,_updateByRender;_updateByRender=!1,new(_NGUeditor=function(){function _NGUeditor(){this.bindRender(),this.initEditor()}return _NGUeditor.prototype.initEditor=function(){var _UEConfig,_editorId,_self;return _self=this,"undefined"==typeof UE?void console.error("Please import the local resources of ueditor!"):(_UEConfig=$S.config?$S.config:{},_UEConfig.initialFrameHeight=_UEConfig.initialFrameHeight||300,_editorId=attr.id?attr.id:"_editor"+Date.now(),element[0].id=_editorId,this.editor=new UE.ui.Editor(_UEConfig),this.editor.render(_editorId),this.editor.ready(function(){_self.editorReady=!0,_self.editor.addListener("contentChange",function(){console.log("检测编辑器内容改变",_self.editor.getContent()),ctrl.$setViewValue(_self.editor.getContent()),_updateByRender||$S.$$phase||$S.$apply(),_updateByRender=!1}),_self.modelContent&&_self.modelContent.length>0&&_self.setEditorContent(),"function"==typeof $S.ready&&$S.ready(_self.editor),$S.$on("$destroy",function(){!attr.id&&UE.delEditor&&UE.delEditor(_editorId)}),_self.editor.addListener("_setIndex",function(event,data){angular.forEach($S.linkmodel,function(field,key){"indexpic"==field.key&&$S.$apply(function(){data?(data.uri?(data.uri.source=data.source,field.value=data.uri):field.value=data,field.value.url=utils.getImgUrl(field.value,config.picConfig.form_singlepic.width,config.picConfig.form_singlepic.height)):field.value=null})})}),_self.editor.addListener("_keyword",function(event,word){angular.forEach($S.linkmodel,function(field,key){"keywords"==field.key&&$S.$apply(function(){field.value=field.value||[],field.value.push(word)})})}),_self.editor.addListener("_title",function(event,title){angular.forEach($S.linkmodel,function(field,key){"title"==field.key&&$S.$apply(function(){field.value=title})})}),_self.editor.addListener("_desc",function(event,title){angular.forEach($S.linkmodel,function(field,key){"brief"==field.key&&$S.$apply(function(){field.value=title})})}),_self.editor.addListener("_native",function(event,title){angular.forEach($S.linkmodel,function(field,key){"is_content_native"==field.key&&$S.$apply(function(){field.value=field.value?0:1})})})}))},_NGUeditor.prototype.setEditorContent=function(content){null==content&&(content=this.modelContent),this.editor&&this.editorReady&&this.editor.setContent(content)},_NGUeditor.prototype.bindRender=function(){var _self;_self=this,ctrl.$render=function(){_self.modelContent=ctrl.$isEmpty(ctrl.$viewValue)?"":ctrl.$viewValue,_updateByRender=!0,_self.setEditorContent()}},_NGUeditor}())}}}])});
