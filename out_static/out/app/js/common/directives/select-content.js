"use strict";define(function(require){var app=require("app");require("appmake/services/pageManagerService"),app.directive("selectContent",function($rootScope,config,http,utils,$q,pageManagerService){return{scope:{url:"="},replace:!0,templateUrl:"common/directives/select-content.html",link:function($scope){var vm=$scope.vm={};angular.extend(vm,{selector:{},init:function(){vm.loading="init",vm.noadd=!0,vm.getPageList(),vm.nodata=!0},paramsCache:{},initEdit:function(url){var params=$scope.url.split("?")[1].split("&");angular.forEach(params,function(str){var value=str.split("=")[1];"undefined"!=str.split("=")[0]&&(vm.paramsCache[str.split("=")[0]]="undefined"!=value?value:"")}),vm.currentPage=vm.paramsCache.module_id,vm.selectPage({id:vm.currentPage}),vm.currentContent=vm.paramsCache.content_id},getPageList:function(){var deferred=$q.defer(),_this=this;return pageManagerService.getPageList("detail").then(function(data){vm.pagelist=data.result,pageManagerService.isContent($scope.url)&&_this.initEdit($scope.url),deferred.resolve(data)}),deferred.promise},getContentList:function(){vm.listdata=[],vm.loading=!1;var url=config.getAPI("contentlist"),params=this.collectListParam();http(url,{params:params}).then(function(resp){resp.error||(vm.contentlit=resp.data,angular.forEach(vm.contentlit,function(val){val.src=utils.getImgUrl(val.data.indexpic),vm.listdata.push(val)}),vm.list=vm.listdata,vm.nodata=!vm.list.length,vm.loading="complete")})},selectPage:function(page){vm.currentPage=page.id,pageManagerService.getPageDetail(vm.currentPage).then(function(data){vm.currentModel=data.result.model_id,vm.getContentList()}),$scope.url="dingdone://module?module_id="+vm.currentPage+"&content_id=",vm.currentContent=""},isEnter:function(event){13==event.keyCode&&this.getContentList()},collectListParam:function(){var params={model_id:vm.currentModel,keywords:vm.keywords};return params},selectContent:function(content){vm.currentContent=content.id,$scope.url="dingdone://module?module_id="+vm.currentPage+"&content_id="+content.id},save:function(flag){return vm.currentPage?vm.currentContent?($scope.url="dingdone://module?module_id="+vm.currentPage+"&content_id="+vm.currentContent,void $scope.$emit(flag,$scope.url)):void utils.error("请选择内容！"):void utils.error("请选择详情页！")}}),$scope.$on("saveContent",function(event,params){vm.save(params.flag)}),vm.init()}}})});
