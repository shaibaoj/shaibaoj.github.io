"use strict";define(function(require){var app=require("app");app.directive("dingdoneNode",["config","http","utils",function(config,http,utils){return{scope:{modelId:"=",nodes:"=",nodesList:"=",notReset:"=",width:"=",nonodes:"=",copymodel:"=",loading:"=",maxCol:"="},replace:!0,templateUrl:"common/directives/model/dingdone-node.html",link:function($scope){var vm=$scope.vm={};angular.extend(vm,{arr:[],isShow:!1,loading:"init",init:function(isReset){$scope.nodes=isReset?{}:$scope.nodes||{},this.isShow=!!$scope.copymodel,this.nodesData=[],this.refreshView(),$scope.modelId&&this.getNode(0,0)},show:function(){this.isShow=!this.isShow},select:function(obj){var id=obj.id;$scope.nodes[id]?delete $scope.nodes[id]:$scope.nodes[id]=obj.name,this.refreshView(),$scope.nodesList&&this.refreshData($scope.nodes)},getNode:function(parent_id,arrIndex,bool){if($scope.modelId){var url=config.getAPI("nodechildren").replace("{model_id}",$scope.modelId).replace("{parent_id}",parent_id),_this=this;this.loading=!1,vm.ajax(url,function(json){var arr=_this.nodesData,length=arr.length;$scope.nonodes=!json.nodes.length,arr.splice(arrIndex,length-arrIndex,json.nodes),_this.loading="complate",$scope.nodesList&&$scope.nodesList.length?($scope.nodes={},console.log("有nodes"),angular.forEach(_this.nodesData[arrIndex],function(node){var bool=_.find($scope.nodesList,function(eachField){return eachField===node.id});bool&&($scope.nodes[node.id]=node.name)}),_this.refreshView()):_this.refreshView(),vm.tapNode(!0)})}},ajax:function(url,success,error,fail){http(url).then(function(json){json.ErrorCode?(utils.error(json.ErrorText),error&&error()):success&&success(json)},function(reason){utils.error(reason.error_message),fail&&fail()})},refreshData:function(obj){$scope.nodesList=[];for(var key in obj)$scope.nodesList.push(key)},currentLevel:0,maxCol:$scope.maxCol?$scope.maxCol:4,tapNode:function(flag){flag?vm.currentLevel=vm.currentLevel+vm.maxCol<vm.nodesData.length?vm.currentLevel+1:vm.currentLevel:vm.currentLevel=vm.currentLevel>0?vm.currentLevel-1:vm.currentLevel},refreshView:function(){this.showText=_.values($scope.nodes).join(",")||"全部分类"}}),$scope.$watch("modelId",function(newVal,oldVal){var isReset=newVal&&oldVal&&!angular.equals(newVal,oldVal);$scope.notReset?vm.init():vm.init(isReset),$scope.copymodel?$scope.notReset=!0:$scope.notReset=!1},!0),$scope.$watch("nodes",function(newVal,oldVal){$scope.nodes=newVal,vm.refreshView()},!0)}}}])});