"use strict";define(function(require){var app=require("app");require("appmake/services/appMakeService");var server=require("common/services/server");app.directive("dingdonePreview",["$rootScope","PreviewAssistant","appMakeService","http","config","$timeout","$interval",function($rootScope,PreviewAssistant,appMakeService,http,config,$timeout,$interval){return{scope:{params:"=",newparams:"=",v3params:"=",rainbowClose:"="},replace:!0,template:'<div class="preview-status-box sys-flex" ng-class="{visible : isVisible}" _status="{{status}}"><div class="icon"></div><div class="inner">{{text}}</div></div>',link:function(scope,attr,el){var vm={};angular.extend(vm,{previewStatus:{ready:"正在推送给预览助手，请确保已打开预览助手并进入「预览」",success:{0:"未发现可预览的设备，请安装预览助手并启动",1:"预览信息成功推送至你的手机",2:"预览信息成功推送至{connections}台手机"},error:{"-1":"暂不支持该属性预览","-2":"未知模块","-3":"服务器连接失败","-4":"预览助手断开连接或连接失败"}},init:function(guid){vm.guid=guid,vm.sessionid=$rootScope.user.sessionid,PreviewAssistant.rainbowStart(vm.sessionid,guid,vm.serviceUpDown)},serviceUpDown:function(params){$timeout(function(){scope.isVisible=!0,scope.status=0,scope.text="downline"==params.action?"一台"+params.client+"设备已下线":scope.isVisible=!1},0),$timeout(function(){scope.isVisible=!1},5e3)},ajaxAttrCallback:function(json){if(json.error_code)scope.status=-1,scope.text="预览信息推送失败，"+json.error_message;else{scope.status=1;var info,connections=json.result.connections;switch(connections){case 0:info=vm.previewStatus.success[0];break;case 1:info=vm.previewStatus.success[1];break;default:info=vm.previewStatus.success[2].replace("{connections}",connections)}scope.text=info}$timeout(function(){scope.isVisible=!1},5e3)}}),scope.$watch("params",function(newVal,oldVal){var deviceList=PreviewAssistant.getDevice();deviceList.length&&server.isDDPreviewOpen&&newVal&&!angular.equals(newVal,oldVal)&&(scope.isVisible=!0,scope.status=0,scope.text=vm.previewStatus.ready,$timeout(function(){PreviewAssistant.ddPreview(newVal).then(function(json){vm.ajaxAttrCallback(json)})},1e3))},!0),scope.$watch("newparams",function(newVal,oldVal){var deviceList=PreviewAssistant.getDevice();deviceList.length&&server.isDDPreviewOpen&&newVal&&!angular.equals(newVal,oldVal)&&(scope.isVisible=!0,scope.status=0,scope.text=vm.previewStatus.ready,$timeout(function(){PreviewAssistant.new_ddPreview(newVal).then(function(json){vm.ajaxAttrCallback(json)})},1e3))},!0),scope.$watch("v3params",function(newVal,oldVal,scope){var deviceList=PreviewAssistant.getDevice();deviceList.length&&server.isDDPreviewOpen&&newVal&&!angular.equals(newVal,oldVal)&&(scope.isVisible=!0,scope.status=0,scope.text=vm.previewStatus.ready,$timeout(function(){PreviewAssistant.v3_ddPreview(newVal).then(function(json){vm.ajaxAttrCallback(json)})},1e3))},!0),config.Appinfo?server.isDDPreviewOpen&&vm.init(config.Appinfo.guid):scope.$on("checkApp",function(event,appinfo){server.isDDPreviewOpen&&vm.init(config.Appinfo.guid)}),scope.$watch("rainbowClose",function(newVal){newVal&&PreviewAssistant.rainbowClose()})}}}])});