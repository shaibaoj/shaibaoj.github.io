"use strict";define(function(require){var app=require("app");require("common/modal/modal-header"),app.controller("TopbarCtrl",function($scope,$mdDialog,modalData){var vm=$scope.vm={};angular.extend(vm,{loading:"complate",init:function(){this.menus=modalData.menus},select:function(btn){this.current=angular.copy(btn)},close:function(){$mdDialog.cancel()},save:function(){var obj={title:vm.title,button:this.current};$mdDialog.hide(obj)}}),vm.init()}),app.directive("dingdoneWidgetBar",function(utils,config,http,PageDesignService,$compile){return{scope:{widget:"="},replace:!0,templateUrl:"common/directives/superui/bar.html",require:["?^dingdoneWidgetItem","?^dingdoneWidget"],link:function($scope,el,attrs,parentCtrl){var dingdoneWidget=(parentCtrl[0],parentCtrl[1]),vm=$scope.vm={};angular.extend(vm,{barType:$scope.widget.barType||"topbar",layoutKey:$scope.widget.layoutKey||["left_menus","center_menus","right_menus"],VIEWS:$scope.widget.VIEWS,root_view_id:$scope.widget.root_view_id,menus:{},pageId:dingdoneWidget.getPageId(),pageModelId:dingdoneWidget.pageModelId,init:function(){var _this=this;PageDesignService.getWidgetList(this.barType).then(function(menus){_this.menus=menus})},add:function(layout){var _this=this;utils.mdDialog({controller:"TopbarCtrl",templateUrl:"appmake/modal/baseinfo/modulemanage/topbar.html",locals:{modalData:{menus:_this.menus}}}).then(function(data){if(data){var view_key=data.button.key;PageDesignService.getFormSchemeWithUuid(view_key).then(function(json){var new_view_id=json.app_view_id,aim=_this.VIEWS[_this.root_view_id][layout];aim.push(new_view_id),_this.VIEWS[new_view_id]=angular.extend(angular.copy(json.default_attrs),{__meta__:{name:data.title}}),$scope.$emit("listenAttrChange",{eventName:"addField",new_view_id:new_view_id,field_layout_key:layout,line_id:_this.root_view_id,VIEWS:_this.VIEWS})})}})},toggleBtn:function(menuViewId){var _this2=this;menuViewId===this.currentViewId?this.currentViewId=null:!function(){_this2.attributeValues=_this2.VIEWS[menuViewId];var view_key=_this2.attributeValues.view,_this=_this2;PageDesignService.getFormScheme(view_key).then(function(json){var conditionAttr=[{widget:"group",title:"配置",children:[{widget:"condition",title:"按钮筛选显示",attrs:{views:vm.attributeValues,config:{ignoreModel:!vm.pageModelId,pageId:vm.pageId,model:{id:vm.pageModelId}}}}]}];_this.formScheme=$scope.widget.supportCondition?json.concat(conditionAttr):json,_this.currentViewId=menuViewId;var dom='<dingdone-widget form-scheme="vm.formScheme" attribute-values="vm.attributeValues" dynamic-compile="true" page-id="vm.pageId" page-model-id="vm.pageModelId" callback="vm.previewCallback( info )" class="hastab"></dingdone-widget>';$compile(dom)($scope).appendTo(el.find(".dingdone-widget-placeholder").empty())})}()},dragstart:function(itemViewId,$index){this.dragViewId=itemViewId,this.dragIndex=$index},moved:function(layout,itemViewId,$index){var viewIds=vm.VIEWS[vm.root_view_id][layout],firstFind=_.indexOf(viewIds,this.dragViewId);firstFind<this.dragIndex?viewIds.splice(this.dragIndex+1,1):viewIds.splice($index,1)},del:function(layout,index,$event){$event.stopPropagation();var _this=this;utils.confirm({headTitle:"删除提示",msg:"确定要删除该按钮吗？"},function(sure){sure&&(_this.VIEWS[_this.root_view_id][layout].splice(index,1),$scope.$emit("listenAttrChange",{eventName:"delField",field_layout_key:layout,line_id:_this.root_view_id,VIEWS:_this.VIEWS}))})},previewCallback:function(info){info.view_id=this.currentViewId,$scope.$emit("listenAttrChange",{eventName:"changeAttr",info:info})}}),vm.init()}}})});