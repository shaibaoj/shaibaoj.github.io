"use strict";define(function(require){var app=require("app");app.directive("dingdoneWidgetColor",["$compile","config","colorService",function($compile,config,colorService){return{scope:{widget:"="},replace:!0,templateUrl:"common/directives/superui/color.html",require:"?^dingdoneWidgetItem",link:function($scope,el,attrs,dingdoneWidgetItem){var vm=$scope.vm={};angular.extend(vm,{colorForView:"",alphaForView:"",colorpickerResult:"",colorForClient:"",withAlpha:!(!$scope.widget||!$scope.widget.enabled_alpha)&&$scope.widget.enabled_alpha,init:function(){this.initValues(),this.initColorpicker()},initValues:function(){var value=dingdoneWidgetItem.getValue(),reg=new RegExp("^#[0-9a-fA-F]{8}$");if(reg.test(value)){this.colorForClient=this.formatcolorForClient(value),this.colorForView="#"+value.substr(3);var alpha=parseInt("0x"+value.substr(1,2))/255;this.alphaForView=1==alpha?alpha:alpha.toFixed(2),dingdoneWidgetItem.setValue(this.colorForClient)}},initColorpicker:function(){vm.colorpickerOption=angular.copy(config.colorpickerDefault),vm.withAlpha&&(vm.colorpickerOption.showAlpha=!0),vm.toRgb();var html='<spectrum-colorpicker ng-model="vm.spectrumColor" on-change="vm.colorpickerChange( color )" on-hide="vm.callback()" options="vm.colorpickerOption"></spectrum-colorpicker>';$compile(html)($scope).appendTo(el)},colorpickerChange:function(color){if(color){var resultStr=color.replace(/[^0-9,\.]/g,""),resultArr=resultStr.split(",");this.alphaForView=resultArr[3]||1;for(var hex=[],i=0;i<3;i++){var num=+resultArr[i];hex.push(num<16?"0"+num.toString(16):num.toString(16))}this.colorForView="#"+hex.join(""),this.colorForView.length<=6&&(vm.colorForView=vm.colorForView.replace("#","#0")),this.callback()}},toRgb:function(){vm.colorForView&&(vm.colorForView<=6&&(vm.colorForView=vm.colorForView.replace("#","#0")),vm.spectrumColor=vm.withAlpha?colorService.hexToRgba(vm.colorForView,vm.alphaForView):colorService.hexToRgb(vm.colorForView))},customColor:function(){if(vm.colorForView){var reg6=/^#[0-9a-fA-F]{6}$/;reg6.test(vm.colorForView)?vm.toRgb():vm.colorForView=""}vm.callback()},customAlpha:function(){"undefined"!=typeof vm.alphaForView&&(vm.alphaForView=+vm.alphaForView,(!angular.isNumber(vm.alphaForView)||vm.alphaForView>1||vm.alphaForView<0)&&(vm.alphaForView=vm.color?1:"")),vm.callback()},formatcolorForClient:function(colorForClient){var colorForClient=colorForClient||"";return colorForClient&&8==colorForClient.length&&(colorForClient="#0"+colorForClient.substr(1)),colorForClient},callback:function(){var num=(255*(vm.withAlpha?vm.alphaForView:1)).toFixed(0)/1,num16=num.toString(16),tmp_colorForClient="#"+num16+vm.colorForView.substr(1);this.colorForClient=this.formatcolorForClient(tmp_colorForClient),dingdoneWidgetItem.setValue(this.colorForClient)}}),vm.init(),$scope.$watch("vm.colorForClient",function(newVal,oldVal){"undefined"==typeof newVal||angular.equals(newVal.toLowerCase(),oldVal.toLowerCase())||dingdoneWidgetItem.setValue(newVal,null,!0)})}}}])});