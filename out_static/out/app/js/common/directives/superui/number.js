"use strict";define(function(require){var app=require("app");require("../string-to-number"),app.directive("dingdoneWidgetNumber",["mathService",function(mathService){return{scope:{externalValue:"=",widget:"="},replace:!0,templateUrl:"common/directives/superui/number.html",require:["?^dingdoneWidgetItem","?^dingdoneWidget"],link:function($scope,el,attrs,parentCtrl){var vm=$scope.vm={},dingdoneWidgetItem=parentCtrl[0],dingdoneWidget=parentCtrl[1];angular.extend(vm,{widget:$scope.widget||{},isShow:!1,init:function(){this.resetConfig();var value=void 0===$scope.externalValue?+dingdoneWidgetItem.getValue():$scope.externalValue;this.value=isNaN(value)||value<this.widget.min||value>this.widget.max?this.widget.min:value},resetConfig:function(){if(this.widget.less_than){var lessThanValue=dingdoneWidget.getValueWithId(this.widget.less_than),max=this.widget.max;this.widget.max=Math.min(lessThanValue,max)}if(this.widget.greater_than){var greaterThanValue=dingdoneWidget.getValueWithId(this.widget.greater_than),min=this.widget.min;this.widget.min=Math.max(greaterThanValue,min)}this.widget.step=this.widget.step||1;var num=this.widget.step.toString();this.widget.accuracy=num.split(".")[1]&&num.split(".")[1].length},minusEnable:function(){return mathService.subtract(this.value,this.widget.step)>=this.widget.min},plusEnable:function(){return mathService.add(this.value,this.widget.step)<=this.widget.max},minus:function(){if(this.minusEnable()){var alreadyMin=this.value<=this.widget.min;this.value=alreadyMin?this.widget.min:mathService.subtract(this.value,this.widget.step)}},plus:function(){if(this.plusEnable()){var alreadyMax=this.value>=this.widget.max;this.value=alreadyMax?this.widget.max:mathService.add(this.value,this.widget.step)}},toggle:function(){vm.isShow=!vm.isShow},check:function(){this.value=+this.value,isNaN(this.value)?this.value=this.widget.min:this.value>this.widget.max?this.value=this.widget.max:this.value<this.widget.min?this.value=this.widget.min:this.value=+parseFloat(this.value).toFixed(this.widget.accuracy)},keyup:function(){this.value>this.widget.max&&(this.value=this.widget.max)}}),vm.init(),$scope.$watch("externalValue",function(){vm.init()}),$scope.$watch("vm.value",function(newVal,oldVal){"undefined"==typeof newVal||angular.equals(newVal,oldVal)||(void 0===$scope.externalValue?dingdoneWidgetItem.setValue(newVal,null,!0):$scope.externalValue=newVal)}),$scope.$on("refreshView",function(e){vm.resetConfig()})}}}])});