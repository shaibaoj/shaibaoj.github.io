"use strict";define(function(require){require("common/controllers/superui/imageLibPop"),require("./dingdone-file-select"),require("common/services/dingdone_selector_service");var app=require("app");app.directive("dingdoneWidgetImage",["utils","upload","config","dingdoneSelectorService",function(utils,upload,config,dingdoneSelectorService){return{scope:{widget:"="},replace:!0,templateUrl:"common/directives/superui/image.html",require:["?^dingdoneWidgetItem","?^dingdoneWidget"],link:function($scope,el,attrs,parentCtrl){var dingdoneWidgetItem=parentCtrl[0],dingdoneWidget=parentCtrl[1],vm=$scope.vm={};angular.extend(vm,{enabled_bind:$scope.widget.enabled_bind,dynamicParam:{},loading:"complete",url:config.getAPI("views.upload",null,"API_admin"),value:dingdoneWidgetItem.getValue(),type:1,init:function(){var _this=this;this.src=vm.value.img_url,this.image=vm.value.image,vm.enabled_bind&&dingdoneSelectorService.init({pageId:dingdoneWidget.pageId,pageModelId:dingdoneWidget.pageModelId}).then(function(result){_this.selector=result})},uploadPic:function(file){vm.loading=!1;var _this=this;upload(vm.url,file[0]).then(function(json){vm.loading="complete",_this.src=json.result.img_url,_this.image=json.result.filename,vm.save()},function(reason){vm.loading="complete",utils.error("该图片上传失败!")})},save:function(){var obj={image:1==vm.type?this.image:["{{",this.dynamicParam.key,"}}"].join(""),img_url:this.src},resource={};resource[obj.img_url]=obj.image,dingdoneWidgetItem.setValue(obj,resource,!0)},openImageLibPop:function(){var _this=this,modalInstance=utils.mdDialog({templateUrl:"common/directives/superui/image-lib.html",controller:"ImageLibCtrl",locals:{modalData:{currentImage:{filename:_this.image,image:_this.src},groupType:$scope.widget.group||"extend_icon"}}});modalInstance.then(function(resp){_this.src=resp.image,_this.image=resp.filename,vm.save()})},selectField:function(){var _this=this;dingdoneSelectorService.showPop({selector:_this.selector,pageId:dingdoneWidget.pageId,currentKey:_this.dynamicParam.key||"",dataTypes:["image"]}).then(function(data){_this.dynamicParam=data,vm.save()})}}),vm.init()}}}])});