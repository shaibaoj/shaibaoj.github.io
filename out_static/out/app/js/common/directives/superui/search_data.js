"use strict";define(function(require){var app=require("app");require("common/services/modelService"),require("appmake/services/appMakeService"),app.directive("dingdoneWidgetSearchData",["utils","config","http","$timeout","modelService","$state","$q","appMakeService",function(utils,config,http,$timeout,modelService,$state,$q,appMakeService){return{scope:{widget:"="},replace:!0,templateUrl:"common/directives/superui/search_data.html",link:function($scope,el,attrs){var vm=$scope.vm={};angular.extend(vm,{moduleId:$scope.widget.moduleId,modelList:[],compId:"",init:function(){vm.searchloading="init",vm.getDataTable()},getDataTable:function(){var deferred=$q.defer();vm.modelList.length>0?deferred.resolve(vm.modelList):modelService.fetchModelList().then(function(resp){vm.modelList=resp,vm.selectIn(vm.modelList),deferred.resolve(resp)})},selectIn:function(lists){vm.getModelSlug(),A.forEach(lists,function(list){A.forEach(vm.collectData,function(slug,key){list.slug==key&&(list.isCheck=!0,list.compId=slug)})})},getModelSlug:function(){console.log($scope.widget.VIEWS,"getModelSlug"),vm.collectData={};for(var k in $scope.widget.VIEWS){var value=$scope.widget.VIEWS[k];"search_container"==value.view&&A.forEach(value.__meta__.__models__,function(val){A.forEach($scope.widget.VIEWS,function(list,key){val.slug==list.__meta__.__model__&&(vm.collectData[val.slug]=key)})})}},check:function(index,id){vm.searchloading=!1;var isCheck=vm.modelList[index].isCheck;vm.modelList[index].isCheck=!isCheck,vm.modelList[index].isCheck?vm.creatComponent(id,index):vm.delComponent(id,index)},creatComponent:function(id,index){var url=config.getAPI("pagedesign.creatFunComponent"),data={model_id:id};http(url,{method:"post",data:data}).then(function(resp){0===resp.error_code&&(vm.compId=resp.result.view_id,vm.addViews(resp.result.page_views,vm.compId),utils.success("添加成功"),vm.searchloading="complete")})},delComponent:function(id,index){var url=config.getAPI("pagedesign.delFunComponent"),data={model_id:id};http(url,{method:"post",data:data}).then(function(resp){0===resp.error_code&&(vm.deleteViews(resp.result.page_views,vm.compId),utils.success("取消成功"),vm.searchloading="complete")})},addViews:function(views,compId){A.forEach($scope.widget.VIEWS,function(view,k){A.forEach(views,function(val,key){k==$scope.widget.pageId&&key==$scope.widget.pageId&&(console.log(val.__meta__.__models__),view.__meta__.__models__=val.__meta__.__models__,view.components=val.components)})}),A.forEach(views,function(val,key){key==compId&&($scope.widget.VIEWS[compId]=val)})},deleteViews:function(views,compId){A.forEach($scope.widget.VIEWS,function(view,k){A.forEach(views,function(val,key){k==$scope.widget.pageId&&key==$scope.widget.pageId&&(view.__meta__.__models__=val.__meta__.__models__,view.components=val.components)}),k==compId&&delete $scope.widget.VIEWS[compId]})},goPage:function(data){appMakeService.setPagemanageParam({pageType:"search",uniqueid:"search_module",module_id:$scope.widget.moduleId,view_id:$scope.widget.pageId});var pageType="search_";pageType=data.compId?pageType+data.compId:pageType+vm.compId,$state.go("pageDesignLayout.pageDesign",{moduleId:vm.moduleId,pageType:pageType,defaultType:"manage",viewId:$scope.widget.pageId})}}),vm.init()}}}])});