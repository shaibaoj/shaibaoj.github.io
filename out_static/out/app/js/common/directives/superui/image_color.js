"use strict";define(function(require){var app=require("app");require("common/controllers/superui/imageLibPop"),require("./dingdone-file-select"),require("common/services/dingdone_selector_service"),app.directive("dingdoneWidgetImageColor",["config","utils","$compile","upload","$modal","dingdoneSelectorService",function(config,utils,$compile,upload,$modal,dingdoneSelectorService){return{scope:{widget:"="},replace:!0,templateUrl:"common/directives/superui/image_color.html",require:["?^dingdoneWidgetItem","?^dingdoneWidget"],link:function($scope,el,attrs,parentCtrl){var dingdoneWidgetItem=parentCtrl[0],dingdoneWidget=parentCtrl[1],vm=$scope.vm={};angular.extend(vm,{enabled_bind:$scope.widget.enabled_bind,dynamicParam:{},type:"color",value:dingdoneWidgetItem.getValue(),init:function(){var _this2=this,_this=this;if(this.value&&this.value.is_image){var image=this.value.image,param=image.replace("{{","").replace("}}","");image===param?this.type="upload":(this.type="param",this.dynamicParam.key=param)}this.color.init(),this.upload.init(),vm.enabled_bind&&dingdoneSelectorService.init({pageId:dingdoneWidget.pageId,pageModelId:dingdoneWidget.pageModelId}).then(function(result){_this.selector=result;var key=_this.dynamicParam.key;if(key){var name=_this2.selector.dictionary[key];name?_this.dynamicParam.name=name:_this.dynamicParam.key=""}})},changeType:function(type){this.type=type,vm.save()},color:{colorForView:"",alphaForView:"",colorpickerResult:"",colorForClient:"",withAlpha:!(!$scope.widget||!$scope.widget.enabled_alpha)&&$scope.widget.enabled_alpha,init:function(){this.initValues(),this.initColorpicker()},formatcolorForClient:function(colorForClient){var colorForClient=colorForClient||"";return colorForClient&&8==colorForClient.length&&(colorForClient="#0"+colorForClient.substr(1)),colorForClient},initValues:function(){var value=vm.value&&vm.value.color,reg=new RegExp("^#[0-9a-fA-F]{8}$");if(reg.test(value)){this.colorForClient=this.formatcolorForClient(value),this.colorForView="#"+value.substr(3);var alpha=parseInt("0x"+value.substr(1,2))/255;this.alphaForView=1==alpha?alpha:alpha.toFixed(2)}},initColorpicker:function(){vm.colorpickerOption=angular.copy(config.colorpickerDefault),this.withAlpha&&(vm.colorpickerOption.showAlpha=!0),this.toRgb();var html='<spectrum-colorpicker ng-model="vm.spectrumColor" on-change="vm.color.colorpickerChange( color )" on-hide="vm.color.callback()" options="vm.colorpickerOption"></spectrum-colorpicker>';$compile(html)($scope).appendTo(el.find(".dingdone-widget-color"))},colorpickerChange:function(color){if(color){var resultStr=color.replace(/[^0-9,\.]/g,""),resultArr=resultStr.split(",");this.alphaForView=resultArr[3]||1;for(var hex=[],i=0;i<3;i++){var num=+resultArr[i];hex.push(num<16?"0"+num.toString(16):num.toString(16))}this.colorForView="#"+hex.join(""),this.callback()}},toRgb:function(){if(this.colorForView){var color=this.colorForView,str=color.replace("#",""),arr=[];arr.push(parseInt(str.substr(0,2),16)),arr.push(parseInt(str.substr(2,2),16)),arr.push(parseInt(str.substr(4,2),16)),this.withAlpha?(arr.push(vm.color.alphaForView||1),vm.spectrumColor="rgba("+arr.join(",")+")"):vm.spectrumColor="rgb("+arr.join(",")+")"}},customColor:function(){if(this.colorForView){var reg6=/^#[0-9a-fA-F]{6}$/;reg6.test(this.colorForView)?this.toRgb():this.colorForView=""}this.callback()},customAlpha:function(){"undefined"!=typeof this.alphaForView&&(this.alphaForView=+this.alphaForView,(!angular.isNumber(this.alphaForView)||this.alphaForView>1||this.alphaForView<0)&&(this.alphaForView=this.colorForView?1:"")),this.callback()},callback:function(){var num=(255*(this.withAlpha?this.alphaForView:1)).toFixed(0)/1,num16=num.toString(16),tmp_colorForClient="#"+num16+this.colorForView.substr(1);this.colorForClient=this.formatcolorForClient(tmp_colorForClient),vm.save()}},upload:{loading:"complete",url:config.getAPI("views.upload",null,"API_admin"),src:"",image:"",init:function(){this.src=vm.value&&vm.value.img_url,this.image=vm.value&&vm.value.image,this.repeat=vm.value&&vm.value.repeat},uploadPic:function(file){this.loading=!1;var _this=this;upload(this.url,file[0],null,null,$scope.widget.size_limit).then(function(json){_this.loading="complete",_this.src=json.result.img_url,_this.image=json.result.filename,vm.save()},function(reason){_this.loading="complete",utils.error("该图片上传失败!")})},openImageLibPop:function(){var _this=this,modalInstance=$modal.open({animateanimation:!0,templateUrl:"common/directives/superui/image-lib.html",controller:"ImageLibCtrl",resolve:{modalData:{currentImage:{filename:_this.image,image:_this.src},groupType:$scope.widget.group||"extend_icon"}}});modalInstance.result.then(function(resp){_this.src=resp.image,_this.image=resp.filename,vm.save()})}},selectField:function(){var _this=this;dingdoneSelectorService.showPop({selector:_this.selector,pageId:dingdoneWidget.pageId,currentKey:_this.dynamicParam.key||"",dataTypes:["image"]}).then(function(data){_this.dynamicParam=data,vm.save()})},save:function(){this.value={is_image:"upload"==this.type||"param"==this.type,color:this.color.colorForClient,image:"param"==this.type?["{{",vm.dynamicParam.key,"}}"].join(""):this.upload.image,img_url:this.upload.src,repeat:this.upload.repeat,paint_color:""},this.resource=null,this.value.is_image&&this.value.image&&(this.resource={},this.resource[this.value.img_url]=this.value.image),dingdoneWidgetItem.setValue(this.value,this.resource)}}),vm.init(),$scope.$watch("vm.value",function(newVal,oldVal){"undefined"==typeof newVal||angular.equals(newVal,oldVal)||dingdoneWidgetItem.setValue(newVal,vm.resource,!0)})}}}])});