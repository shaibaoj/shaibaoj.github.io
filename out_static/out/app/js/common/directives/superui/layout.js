"use strict";define(function(require){var app=require("app");require("./unit"),app.directive("dingdoneWidgetLayout",function(LayoutService,utils,PageDesignService,$compile){return{scope:{widget:"="},templateUrl:"common/directives/superui/layout.html",replace:!0,link:function($scope,el){var vm=$scope.vm={};angular.extend(vm,{VIEWS:$scope.widget.VIEWS,root_view_id:$scope.widget.root_view_id,columns:[],slider:{},init:function(){this.columns=this.VIEWS[this.root_view_id].fields;this.columns&&this.columns.length},createColumn:function(){var _this=this;PageDesignService.getFormSchemeWithUuid("detail_component_section").then(function(json){var new_view_id=json.app_view_id,aim=_this.VIEWS[_this.root_view_id].fields;aim.push(new_view_id),_this.VIEWS[new_view_id]=angular.copy(json.default_attrs),_this.resetSlider(),$scope.$emit("listenAttrChange",{eventName:"addColumn",new_view_id:new_view_id,VIEWS:_this.VIEWS})})},addWidget:function(columnViewId){var _this=this;LayoutService.showWidgetPop("layout").then(function(json){var new_view_id=json.app_view_id,column=_this.VIEWS[columnViewId];column.cmps||(column.cmps=[]),column.cmps.push(new_view_id),_this.VIEWS[new_view_id]=angular.extend(angular.copy(json.default_attrs),{__meta__:{name:json.name}}),$scope.$emit("listenAttrChange",{eventName:"addWidget",new_view_id:new_view_id,columnViewId:columnViewId,VIEWS:_this.VIEWS})})},delWidget:function(columnViewId,$index,$event){$event.stopPropagation();var _this=this;utils.confirm({msg:"确定删除该控件吗?",headTitle:"删除提醒"},function(){_this.VIEWS[columnViewId].cmps.splice($index,1)})},toggleAttrBox:function(view_id){var _this2=this,view_key=this.VIEWS[view_id].view;this.current_view_id&&this.current_view_id===view_id?this.current_view_id=null:!function(){var _this=_this2;PageDesignService.getFormScheme(view_key).then(function(json){_this.current_view_id=view_id,_this.current_view_key=view_key,vm.form_scheme=json,vm.attribute_values=$scope.widget.VIEWS[view_id];var dom='<dingdone-widget class="form-horizontal common" form-scheme="vm.form_scheme" dynamic-compile="true" attribute-values="vm.attribute_values" callback="vm.previewCallback( info )"></dingdone-widget>';$compile(dom)($scope).appendTo(el.find(".dingdone-widget-placeholder").empty())})}()},setCustomNum:function(num){var _this=this,currentLen=this.columns.length,m=num-currentLen;if(0!==m)if(m>0)for(var i=0;i<m;i++)this.createColumn();else{for(var cache=[],i=num;i<currentLen;i++)cache=cache.concat(_this.VIEWS[_this.columns[i]].cmps);var aim=_this.VIEWS[this.columns[num-1]];aim.cmps||(aim.cmps=[]),aim.cmps=aim.cmps.concat(cache),this.columns.splice(num,currentLen-num),this.resetSlider()}},initWidthSlider:function(){var sum=0,_this=this;this.columns.forEach(function(columnViewId){sum+=_this.VIEWS[columnViewId].rowRatio}),1!=sum&&this.resetSlider()},resetSlider:function(){var _this=this,len=this.columns.length,hash={1:[0,100],2:[0,50,100],3:[0,33,66,100],4:[0,25,50,75,100]},result=hash[len];result.forEach(function(value,$index){_this.slider[$index]=value}),this.sliderChange()},sliderChange:function(){var values=_.values(this.slider).sort(function(a,b){return a-b});this.setRowRatio(values)},setRowRatio:function(widthArr){var _this=this;this.columns.forEach(function(columnViewId,$index){_this.VIEWS[columnViewId].rowRatio=(widthArr[$index+1]-widthArr[$index])/100})},previewCallback:function(info){info.view_id=this.current_view_id,$scope.$emit("listenAttrChange",{eventName:"changeAttr",info:info})}}),vm.init()}}})});