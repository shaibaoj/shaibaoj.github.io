"use strict";define(function(require){var app=require("app"),moment=require("moment");require("appmake/services/appMakeService"),require("appmake/myapp/modal/chooseStoreModal");var server=require("common/services/server");app.directive("dingdoneAppBaseInfo",["$rootScope","$q","http","$state","appMakeService","utils","config","youzanBindService",function($rootScope,$q,http,$state,appMakeService,utils,config,youzanBindService){return{scope:{},templateUrl:"common/directives/blocks/dingdone-app-base-info.html",link:function($scope){var vm=$scope.vm={};angular.extend(vm,{version:server.version,config:config,init:function(guid){appMakeService.getAppBaseInfo(guid).then(function(resp){vm.appinfo=resp.result.application,console.log("vm.appinfo",vm.appinfo),vm.initBase()}),"ecshop"!=vm.version&&vm.getBusiness(),"ecshop"==vm.version&&vm.getYouzanShopInfo(),vm.isOperateMode=$rootScope.isOperateMode,vm.wacthScreen(),$(window).resize(function(){vm.currentWidth=$(window).width()}),"mainLayout.operateindex"==$rootScope.currentState?vm.isOperateMode=!0:vm.isOperateMode=!1,vm.getStoreInfo.init()},wacthScreen:function(){vm.currentWidth=$(window).width(),$scope.$watch("vm.currentWidth",function(val){val>1280?vm.bigScreen=!0:vm.bigScreen=!1,$(window).resize(function(){vm.currentWidth=$(window).width()})})},initBase:function(){vm.appinfo.icon=utils.getImgUrl(vm.appinfo.icon),vm.appinfo.create_time=+vm.appinfo.create_time?moment.unix(+vm.appinfo.create_time).format("YYYY-MM-DD HH:mm"):"--",vm.appinfo.pack_time=+vm.appinfo.pack_time?moment.unix(+vm.appinfo.pack_time).format("YYYY-MM-DD HH:mm"):"--"},getYouzanShopInfo:function(){youzanBindService.getYouzanShopInfo().then(function(resp){resp.error_code||(vm.shopinfo=resp.result.shop_info,vm.shopinfo&&angular.isArray(vm.shopinfo)&&(vm.hasshop=!1),vm.shopinfo&&!angular.isArray(vm.shopinfo)&&(vm.hasshop=!0,vm.getYouzanAuth()))})},getYouzanAuth:function(){appMakeService.getYouzanAuth().then(function(resp){"0"===resp.error_code&&resp.result&&(vm.youzaninfo=resp.result,vm.now=Date.parse(new Date),vm.youzaninfo&&vm.youzaninfo.expireTime&&(vm.overdue_time=vm.youzaninfo.expireTime-vm.now,vm.overdue_time>0&&(parseInt(vm.overdue_time/864e5)>0&&(vm.time=parseInt(vm.overdue_time/864e5)+"天"),0==parseInt(vm.overdue_time/864e5)&&(vm.time=parseInt(vm.overdue_time/36e5)+"小时"),0==parseInt(vm.overdue_time/36e5)&&(vm.time=parseInt(vm.overdue_time/6e4)+"分钟"),0!=parseInt(vm.overdue_time/6e4)&&0!=vm.overdue_time||(vm.time=vm.overdue_time+"秒")))),resp.error_code&&"0"!==resp.error_code&&(vm.has_error=!0,vm.youzanbindtip={transition:"all .3s",top:"-webkit-calc( ( 100% - 182px ) / 2 )"})})},closeTip:function(){vm.youzanbindtip={transition:"all .3s",top:"-182px"}},getBusiness:function(guid){appMakeService.getBusiness(guid).then(function(resp){!resp.error_code&&resp.result&&(vm.businessinfo=resp.result,vm.businessinfo&&!angular.isArray(vm.businessinfo)&&(vm.hasbusiness=!0,vm.businessinfo.overdue_time&&vm.businessinfo.overdue_time>=0&&(vm.businessinfo.overdue_time&&parseInt(vm.businessinfo.overdue_time/86400)>0&&(vm.time=parseInt(vm.businessinfo.overdue_time/86400),vm.overdue_time=vm.time+"天"),vm.businessinfo.overdue_time&&0==parseInt(vm.businessinfo.overdue_time/86400)&&(vm.time=parseInt(vm.businessinfo.overdue_time/3600),vm.overdue_time=vm.time+"小时"),vm.businessinfo.overdue_time&&0==parseInt(vm.businessinfo.overdue_time/3600)&&(vm.time=parseInt(vm.businessinfo.overdue_time/60),vm.overdue_time=vm.time+"分钟"),(vm.businessinfo.overdue_time&&0==parseInt(vm.businessinfo.overdue_time/60)||0==vm.businessinfo.overdue_time)&&(vm.time=vm.businessinfo.overdue_time,vm.overdue_time=vm.time+"秒")),vm.businessinfo.overdue_time&&vm.businessinfo.overdue_time<0&&(vm.time=vm.businessinfo.overdue_time))),vm.businessinfo&&angular.isArray(vm.businessinfo)&&(vm.overdays=!1,vm.surpusdays=!1,vm.notapply=!1,vm.hasbusiness=!1)})},chooseStoreWay:function(){$q.all(vm.getStoreInfo.allXhr()).then(function(){vm.btnloading="complate",utils.mdDialog({templateUrl:"appmake/myapp/modal/chooseStoreModal.html",controller:"chooseStoreWay",clickOutsideToClose:!0,locals:{data:{buyInfo:vm.buyAppStoreInfo}}}).then(function(res){res&&res.way&&$state.go("mainLayout.appstore",{way:res.way})})})},getStoreInfo:{init:function(){vm.nocreateapp=!0,vm.checkapp=!1,vm.buyAppStoreInfo={},vm.buyAppStoreInfo={}},allXhr:function(){var q1=$q.defer(),q2=$q.defer(),q3=$q.defer(),q4=$q.defer(),q5=$q.defer(),q6=$q.defer(),q7=$q.defer(),q8=$q.defer();vm.btnloading=!1,this.getMarketInfo(q1),this.__getMarketInfo(q2),this.getAppStoreInfoIos(q3),this.__getAppStoreInfoIos(q4),this._getAppStoreInfoIos(q5),this.__getAppStoreInfoIos_(q6),this.getAppStoreInfoAnd(q7),this.__getAppStoreInfoAnd(q8);var allAjax=[q1.promise,q2.promise,q3.promise,q4.promise,q5.promise,q6.promise,q7.promise,q8.promise];return allAjax},getMarketInfo:function(q){var url=config.getAPI("getstoreinfo.appstoreremain").replace("{client_key}",2);http(url).then(function(data){data&&0==data.error_code&&(vm.buyAppStoreInfo.buy_ios=data.result.remain_times),q.resolve()})},__getMarketInfo:function(q){var _url=config.getAPI("getstoreinfo.appstoreremain").replace("{client_key}",1);http(_url).then(function(data){data&&0==data.error_code&&(vm.buyAppStoreInfo.buy_android=data.result.remain_times),q.resolve()})},getAppStoreInfoIos:function(q){var url=config.getAPI("getstoreinfo.appstoreinfo").replace("{client_key}",2).replace("{is_self}",0);http(url).then(function(resp){resp&&0==resp.error_code&&(vm.buyAppStoreInfo.iosStatus=resp.result.status),q.resolve()})},__getAppStoreInfoIos:function(q){var _url=config.getAPI("getstoreinfo.appstorerecord").replace("{client_key}",2).replace("{is_self}",0);http(_url).then(function(resp){resp&&0==resp.error_code&&(vm.buyAppStoreInfo.iosRecord=resp.result),q.resolve()})},_getAppStoreInfoIos:function(q){var url=config.getAPI("getstoreinfo.appstoreinfo").replace("{client_key}",2).replace("{is_self}",1);http(url).then(function(resp){resp&&0==resp.error_code&&(vm.buyAppStoreInfo.selfIosStatus=resp.result.status),q.resolve()})},__getAppStoreInfoIos_:function(q){var _url=config.getAPI("getstoreinfo.appstorerecord").replace("{client_key}",2).replace("{is_self}",1);http(_url).then(function(resp){resp&&0==resp.error_code&&(vm.buyAppStoreInfo.selfIosRecord=resp.result),q.resolve()})},getAppStoreInfoAnd:function(q){var url=config.getAPI("getstoreinfo.appstoreinfo").replace("{client_key}",1).replace("{is_self}",0);http(url).then(function(resp){resp&&0==resp.error_code&&(vm.buyAppStoreInfo.AndStatus=resp.result.status),q.resolve()})},__getAppStoreInfoAnd:function(q){var _url=config.getAPI("getstoreinfo.appstorerecord").replace("{client_key}",1).replace("{is_self}",0);http(_url).then(function(resp){resp&&0==resp.error_code&&(vm.buyAppStoreInfo.andRecord=resp.result),q.resolve()})}}}),$scope.$on("isoperate",function(event,$modelinfo){vm.currentMode=$modelinfo}),config.Appinfo?vm.init(config.Appinfo.guid):$scope.$on("checkApp",function(event,appinfo){vm.init(appinfo.guid)})}}}])});