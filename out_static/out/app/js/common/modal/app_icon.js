"use strict";define(function(require){var app=require("app");require("common/directives/focus"),require("common/modal/modal-header"),require("common/modal/modal-footer"),app.controller("AppIconCtrl",["$scope","$mdDialog","http","config","utils","modalParams","upload","appMakeService",function($scope,$mdDialog,http,config,utils,modalParams,upload,appMakeService){var vm=$scope.vm={};angular.extend(vm,{appIconConfig:modalParams,utils:utils,iconType:"default",bg:{type:"system"},front:{type:"pic"},appNameWords:[],init:function(){vm.iconType="default",this.initAppIconConfig(),this.initLoading(),console.log(modalParams,"modalParams")},initAppIconConfig:function(){appMakeService.getAppIconConfig(modalParams.guid).then(function(data){vm.appIconConfig=data.result,vm.changeBgColor(_.keys(vm.appIconConfig.background_color)[0]),vm.changeBgEffect(vm.appIconConfig.background_image[0]);var currentAppName=modalParams.appName?modalParams.appName.replace(/\s/g,""):"",words=new Set(currentAppName);words.forEach(function(word){vm.appNameWords.push(word)});var icons=vm.appIconConfig["case"],connection=vm.appIconConfig.connection,totalPage=Math.ceil(icons.length/32),iconsArr=new Array(totalPage);angular.forEach(icons,function(value,key){var index=parseInt(key/32);iconsArr[index]||(iconsArr[index]=[]),iconsArr[index].push(value)}),vm.frontSrc=connection.scheme+"://"+connection.host+"/"+connection.background_case_path,vm.iconsArr=iconsArr,vm.totalPage=totalPage,vm.currentPage=1,vm.iconType=modalParams.iconType,vm.initParams()})},initLoading:function(){vm.createloading="init",vm.bgloading="init",vm.frontloading="init",vm.appiconloading="init"},initParams:function(){D.isEmpty(vm.appIconConfig.settings)?modalParams&&modalParams.settings&&this.__init(modalParams.settings):vm.appIconConfig&&vm.appIconConfig.settings&&this.__init(vm.appIconConfig.settings),"custom"===vm.iconType&&(vm.appIconUrl=utils.getImgUrl(modalParams.icon))},__init:function(params){console.log("aaaaaaaa",params),params.bg_color_name&&(vm.bg.colorName=params.bg_color_name),params.bg_image_url&&(vm.previewUrl=params.bg_image_url,vm.bg.type="diy"),params.bg_image&&(vm.bg.effect=params.bg_image,vm.previewUrl=vm.createBgImg(vm.bg.effect),vm.bg.type="system"),params.text&&(vm.frontWord=params.text,vm.front.type="words",vm.currentWord=params.text,$.inArray(vm.currentWord,vm.appNameWords)==-1&&(vm.addWord=!0,vm.diyWord=vm.currentWord)),params.fg_image&&(vm.frontName=params.fg_image,vm.frontUrl=vm.frontSrc+vm.frontName,vm.front.type="pic",vm.frontWord=void 0),params.fg_image_url&&(vm.frontUrl=params.fg_image_url,vm.front.type="upload"),!params.bg_image_url||params.bg_color||params.bg_color_name||params.bg_image||params.fg_image||params.fg_image_url||params.text?vm.iconType="default":vm.iconType="custom"},setIconType:function(type){console.log(type,"type"),vm.iconType=type,"custom"===type?(vm.frontUrl=null,vm.oldpreviewUrl=vm.previewUrl,vm.previewUrl=null):vm.previewUrl=vm.oldpreviewUrl},changeBgType:function(type){vm.bg.type=type,"diy"===type?(vm.oldpreviewUrl=vm.previewUrl,vm.previewUrl=null):vm.previewUrl=vm.oldpreviewUrl},changeBgColor:function(colorName,color){vm.bg.colorName=colorName,vm.changeBgEffect(vm.appIconConfig.background_image[0]),vm.oldpreviewUrl=vm.previewUrl,vm.previewUrl=vm.createBgImg(vm.appIconConfig.background_image[0])},changeBgEffect:function(effect){vm.bg.effect=effect,vm.oldpreviewUrl=vm.previewUrl,vm.previewUrl=vm.createBgImg(effect)},createBgImg:function(effect){var connection=vm.appIconConfig.connection;return connection.scheme+"://"+connection.host+"/"+connection.background_image_path+vm.bg.colorName+"/"+effect},changeFrontType:function(type){vm.front.type=type},generateIcon:function(callback){"default"===vm.iconType?this.diyIcon(callback):(vm.params=vm.appIcon,callback&&callback(vm.appIcon.material))},diyIcon:function(callback){var url=config.getAPI("generateAppIcon"),params={};if("diy"===vm.bg.type?params.bg_image_url=vm.previewUrl:(params.bg_image=vm.bg.effect,params.bg_color=vm.appIconConfig.background_color[vm.bg.colorName],params.bg_color_name=vm.bg.colorName),"pic"===vm.front.type)params.fg_image=vm.frontName,params.text=null;else if("words"===vm.front.type){if(""==vm.frontWord)return void utils.error("文字格式不对,请重新填写!");params.text=vm.frontWord,params.fg_image=null}else params.fg_image_url=vm.frontUrl,params.fg_image=null,params.text=null;modalParams.guid&&(params.application_id=modalParams.guid),vm.params=params,vm.createloading=null,http(url,{method:"post",data:params}).then(function(data){0===data.error_code?callback&&callback(data.result.icon):vm.createloading="fail"})["catch"](function(){vm.createloading="fail",utils.error("生成app失败!")})},changeFrontImg:function(icon){vm.frontName=icon,vm.frontWord=void 0,vm.currentIcon=icon},prePage:function(){vm.currentPage>1&&(vm.currentPage--,$(".carousel-inner-wrap").css("transform","translateX("+-409*(vm.currentPage-1)+"px)"))},nextPage:function(){vm.currentPage<vm.totalPage&&($(".carousel-inner-wrap").css("transform","translateX("+-409*vm.currentPage+"px)"),vm.currentPage++)},selectWord:function(word){vm.frontWord=word,vm.currentWord=word,vm.currentIcon=void 0},blurWord:function(){vm.diyWord?(vm.frontNameReg=!/^[\u4E00-\u9FA5a-zA-Z]+$/.test(vm.diyWord),vm.frontNameReg?(vm.selectWord(""),vm.diyWord="",vm.addWord=!0):vm.frontWord=vm.diyWord):(vm.addWord=!1,vm.frontWord="")},save:function(){this.generateIcon(function(icon){vm.createloading="complete",$mdDialog.hide({status:"success",icon:icon,settings:{bg_image_url:vm.params.bg_image_url},iconType:vm.iconType})})},close:function(){$mdDialog.hide()},uploadBgPic:function(file){var url=config.getAPI("upload");vm.bgloading=null,upload(url,file,100,100,"appIconImg").then(function(data){vm.previewUrl=data.url.split("?")[0],vm.bgloading="complete"},function(reason){vm.bgloading="fail"})},uploadFrontPic:function(file){var url=config.getAPI("upload");vm.frontloading=null,upload(url,file,100,100,"appIconImg").then(function(data){vm.frontUrl=data.url.split("?")[0],vm.frontloading="complete"},function(reason){vm.frontloading="fail"})},uploadAppIcon:function(file){var url=config.getAPI("upload");vm.appiconloading=null,upload(url,file,100,100,"appIcon").then(function(data){console.log(data,"data"),!+data.error_code&&data?(vm.appIconUrl=data.url.split("?")[0],vm.appIcon=data,vm.appiconloading="complete",console.log("success","success")):(4161==data.error_code?utils.error("请上传PNG格式的图片!"):4160==data.error_code?utils.error("请上传1024*1024分辨率以下的图片"):utils.error(error_message),console.log("fail","fail"))},function(reason){vm.appiconloading="fail"})}}),vm.init()}])});