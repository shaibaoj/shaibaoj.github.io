"use strict";define(function(require){var app=require("app");require("common/directives/model/dingdone-node"),require("appmake/modal/modulemanage/cover_popup_tip"),app.controller("ContentBindCtrl",["$scope","utils","config","$state","http","$modalInstance","data","upload",function($scope,utils,config,$state,http,$modalInstance,data,upload){var vm=$scope.vm={};angular.extend(vm,{id:data.id,bindDetails:data.details,record_ids:data.record_ids,init:function(){vm.nodesListCache={},vm.loading=!0,angular.forEach(vm.bindDetails,function(bindmodel){vm.nodesListCache[bindmodel.to]={}}),vm.chooseModel(vm.bindDetails[0]),vm.checkIsBind()},noBind:{},checkIsBind:function(){angular.forEach(vm.bindDetails,function(model){vm.getModelDetails(model.to).then(function(data){if(data){var requiredlist=vm.initRequire(data.user_models[0].fields);angular.forEach(requiredlist,function(required){var bool=_.find(model.mapping,function(val){return val===required.key});bool||(vm.noBind[model.to]=model)}),vm.loading="complete"}})})},initRequire:function(arr){var requirelist=[];return angular.forEach(arr,function(val){val.required&&requirelist.push(val)}),requirelist},getModelDetails:function(model_id){vm.loading=!1;var url=config.getAPI("contentModelV3.requiremodel").replace("{model_id}",model_id);return http(url)["catch"](function(){vm.loading="complete"})},chooseModel:function(model){vm.currentBind=model},selectModel:function(model){angular.isArray(model.nodes)||(model.nodes=[]),model.isCheck=model.isCheck?!model.isCheck:model.isCheck=!0},showTip:function(bind){utils.mdDialog({controller:"coverPopupTipCtrl",templateUrl:"appmake/modal/modulemanage/cover_popup_tip.html",clickOutsideToClose:!0,escapeToClose:!0,parent:angular.element($("#component-type-list")),locals:{modalData:{type:"contentCopy",msg:"『"+bind.name+"』数据表中的必填字段未被绑定，请前往数据表中 “绑定字段” 后再进行复制操作！",sureName:"立即绑定",iconClass:"iconCopy2",cancelName:"好的，我知道了",sureUrl:{url:"mainLayout.contentcopy",params:{moduleId:vm.id,currentTo:bind.to}}}}}).then(function(data){})},save:function(){vm.loading=!1;var data=[],noBind=!0;if(angular.forEach(vm.bindDetails,function(bind){var obj={};if(bind.isCheck||bind.nodes&&bind.nodes.length&&noBind){if(vm.noBind[bind.to])return noBind=!1,vm.close(),vm.showTip(vm.noBind[bind.to]),void(vm.loading="complete");obj.to=bind.to,obj.mapping=bind.mapping;var nodes=vm.nodesListCache[bind.to];obj.nodes=[];for(var key in nodes)obj.nodes.push(key);data.push(obj)}}),noBind){var url=config.getAPI("copyContent"),params={record_ids:vm.record_ids,data:data};return data.length?void http(url,{method:"post",data:params}).then(function(data){data&&0==data.error_code?(utils.success("复制成功！"),vm.loading="complete",vm.close()):(utils.error("复制失败！"),vm.loading="complete",vm.close())})["catch"](function(reject){vm.loading="complete"}):(utils.error("内容模型未勾选！"),void(vm.loading="complete"))}},goContentBind:function(id){$state.go("mainLayout.contentcopy",{moduleId:vm.id,currentTo:id}),$modalInstance.dismiss("cancel")},close:function(){$modalInstance.dismiss("cancel")}}),vm.init()}])});
