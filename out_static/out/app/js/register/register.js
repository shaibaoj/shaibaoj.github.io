"use strict";define(function(require){var app=require("app"),server=require("common/services/server");require("common/directives/agreement-modal"),app.controller("RegisterCtrl",["$rootScope","$scope","$state","$stateParams","http","utils","config","$timeout","$modal","$mdDialog",function($rootScope,$scope,$state,$stateParams,http,utils,config,$timeout,$modal,$mdDialog){var vm=$scope.vm={};angular.extend(vm,{token:$stateParams.register_token&&$stateParams.register_token.split("=")[1],init:function(){vm.isOnline="onlinev3"!=server.platform,vm.showWxcode=!0,vm.next_disabled=!0,vm.showmodal=!1,vm.sendcode=!0,vm.time=!1,vm.repeatsend=!1,vm.count=60,vm.disabled=!0,vm.check=!1,vm.isemail=window.location.href.indexOf("email"),vm.helperemail=window.location.href.split("=")[2],vm.server=server},validateWxcode:function(){if(!vm.wx_code)return vm.next_disabled=!0,void(vm.error_verifywxcode="请输入邀请码");var url=config.getAdminAPI("validatecode");http(url,{method:"post",data:{code:vm.wx_code,type:"wechat_invite"}}).then(function(resp){"0"===resp.error_code&&(resp.result.valid===!0?(vm.next_disabled=!1,vm.error_verifywxcode=""):(vm.error_verifywxcode="无效验证码",vm.next_disabled=!0))})},changeType:function(){vm.numType=!vm.numType},next:function(){vm.next_disabled||(vm.showWxcode=!1)},validateMobile:function(){if(vm.mobile){var reg=/^1[34578]\d{9}$/;reg.test(vm.mobile)?vm.error_mobile="":vm.error_mobile="手机号码有误!"}else vm.error_mobile="请输入手机号";vm.checkBtnDisabeld()},validateCode:function(){if(vm.verifycode){var reg=/^\d{6}$/;if(reg.test(vm.verifycode)){var url=config.getAdminAPI("validatecode");http(url,{method:"post",data:{code:vm.verifycode,type:"mobile_bind",mobile:vm.mobile}}).then(function(resp){0==resp.error_code&&(1==resp.result.valid?(vm.verifysuccess=!0,vm.error_verifycode="",vm.sendcode=!1,vm.repeatsend=!1,vm.time=!1):(vm.error_verifycode="无效验证码",vm.verifysuccess=!1,vm.time||(vm.sendcode=!0)),vm.checkBtnDisabeld())})}else vm.error_verifycode="验证码错误",vm.verifysuccess=!1,vm.time||(vm.sendcode=!0),vm.checkBtnDisabeld()}else vm.error_verifycode="请输入验证码",vm.verifysuccess=!1,vm.time||(vm.sendcode=!0),vm.checkBtnDisabeld()},validateUsername:function(){if(vm.username){var reg=/^[A-Za-z]{1}[0-9A-Za-z_]{5,11}$/;if(reg.test(vm.username)){var url=config.getAdminAPI("testregisterfield")+"?username="+vm.username;http(url).then(function(resp){vm.error_username="正在检测信息...",vm.usernamesuccess=!1,vm.valerror=!1,"0"===resp.error_code&&$timeout(function(){1==resp.result.is_use?(vm.error_username="用户名已存在",vm.usernamesuccess=!1,vm.valerror=!1,vm.checkBtnDisabeld()):(vm.error_username="",vm.usernamesuccess=!0,vm.valerror=!1,vm.checkBtnDisabeld())},1500)})}else vm.error_username="由6-12位字母、数字、下划线组成,以字母开头",vm.usernamesuccess=!1,vm.valerror=!0,vm.checkBtnDisabeld()}else vm.error_username="请输入用户名",vm.usernamesuccess=!1,vm.valerror=!1},validateEmail:function(){if(vm.email){var reg=/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;if(reg.test(vm.email)){var url=config.getAdminAPI("testregisterfield")+"?email="+vm.email;http(url).then(function(resp){vm.error_email="正在检测信息...",vm.emailsuccess=!1,"0"===resp.error_code&&$timeout(function(){1==resp.result.is_use?(vm.error_email="邮箱已被占用",vm.emailsuccess=!1):(vm.error_email=null,vm.emailsuccess=!0)},1500)})}else vm.error_email="邮箱格式不正确",vm.emailsuccess=!1}else vm.error_email="请输入邮箱！",vm.emailsuccess=!1;vm.checkBtnDisabeld()},autopassword:function(){vm.validatype="password",console.log(vm.validatype)},validatePassword:function(){if(vm.passhasnull=!1,vm.password){var reg=/(?![^a-zA-Z]+$)(?!\D+$).[^\s]{5,17}$/;!reg.test(vm.password)||vm.password.length<6||vm.password.length>18?vm.error_password="密码由6-18位英文和数字、特殊字符组成":vm.error_password=""}else vm.error_password="请输入密码",vm.passhasnull=!0;vm.checkBtnDisabeld()},validateRepeatPsd:function(){vm.repeatpassword?vm.repeatpassword!=vm.password?vm.error_repeatpassword="两次输入密码不一致":vm.error_repeatpassword="":vm.error_repeatpassword="请输入确认密码",vm.checkBtnDisabeld()},checkBtnDisabeld:function(){console.log(vm.check),vm.token||(vm.mobile&&!vm.error_mobile&&vm.verifycode&&vm.verifysuccess&&vm.username&&!vm.error_username&&vm.password&&!vm.error_password&&vm.check?vm.disabled=!1:vm.disabled=!0),vm.token&&(vm.isemail>0?vm.password&&!vm.error_password&&vm.repeatpassword&&vm.check&&!vm.error_repeatpassword?vm.disabled=!1:vm.disabled=!0:vm.email&&!vm.error_email&&vm.password&&!vm.error_password&&vm.repeatpassword&&vm.check&&!vm.error_repeatpassword?vm.disabled=!1:vm.disabled=!0),console.log(vm.disabled,"vm.disabled")},isChecked:function(){vm.check=!vm.check,vm.checkBtnDisabeld()},sendVerifyCode:function(){if(!vm.mobile)return void(vm.error_mobile="请输入手机号");var reg=/^1[34578]\d{9}$/;if(!reg.test(vm.mobile))return void(vm.error_mobile="手机号码有误!");vm.time=!0,vm.sendcode=!1,vm.repeatsend=!1;var url=config.getAdminAPI("sendverifycode");http(url,{method:"post",data:{target_type:"mobile",verify_type:"bind",target:vm.mobile}}).then(function(resp){"0"===resp.error_code?(vm.countDown(),utils.success("验证码已发送到您的手机",{posId:".login-form",position:"top center"})):(vm.time=!1,vm.sendcode=!0)})},countDown:function(){0==vm.count?(vm.count=60,vm.sendcode=!1,vm.time=!1,vm.repeatsend=!0,vm.verifysuccess=!1):(vm.count--,vm.count<0&&(vm.count=0),$timeout(function(){vm.countDown()},1e3))},agreenment:function(){vm.check=!0,vm.showmodal=!1,vm.checkBtnDisabeld()},close:function(){vm.showmodal=!1},cancel:function(){vm.check=!1,vm.showmodal=!1,vm.checkBtnDisabeld()},register:function(action){if(!vm.disabled){vm.disabled=!0;var url="",obj={password:vm.password};obj.is_active="medium"!=server.version,vm.loading=!1,vm.loadeing=!0,vm.token?(url=config.getAdminAPI("helperregister"),vm.isemail>0?(obj.email=vm.helperemail,obj.type="email"):(obj.email=vm.email,obj.type="link"),obj.token=vm.token):(url=config.getAdminAPI("userregister"),obj.mobile=vm.mobile,obj.username=vm.username,obj.verify_code=vm.verifycode),http(url,{method:"post",data:obj}).then(function(resp){"0"==resp.error_code&&utils.success("注册成功",{posId:".login-form",position:"top center"}).then(function(){$scope.checkopen?$mdDialog.hide():vm.token?vm.isemail>0?($state.go("loginLayout.userlogin"),vm.loading="complete",vm.loadeing=!1):($state.go("layout_for_push.registersuccess",{username:vm.email,helper:"helper"}),vm.loading="complete",vm.loadeing=!1):($state.go("modalMarketLayout.appmarket"),vm.loading="complete")})})}},registerToCreat:function(){},showAgreementModal:function(){$scope.$emit("openAgreementModal",!0),vm.showmodal=!0}}),vm.init(),$scope.$on("checkagreenment",function(event,resp){vm.check=resp,console.log(vm),vm.checkBtnDisabeld()})}])});