"use strict";define(function(require){var app=require("app"),moment=require("moment");require("../modal/message/messageModal"),require("common/directives/form-select"),require("common/directives/pagination/page1"),require("./services/advertisement"),app.controller("MessageCtrl",["$scope","$modal","$state","navconfig","utils","config","http","advertisement",function($scope,$modal,$state,navconfig,utils,config,http,advertisement){var vm=$scope.vm={};angular.extend(vm,{init:function(){vm.loading="init",vm.getAdvertList(),vm.watchCurrentPage(),vm.watchOpend()},modifyStatus:function(item,index){function change(){var url=config.getAPI("modifystatus").replace("{id}",vm.list[index].id).replace("{status}",status);http(url).then(function(resp){vm.loading="complete"})}var status=item.opened?1:0;vm.loading=!1,item.opened&&vm.checkDisabled(item)?(item.opened=0,vm.loading="complete"):change()},watchOpend:function(){$scope.$watch("vm.list",function(){angular.forEach(vm.list,function(value){vm.checkDisabled(value)})},!0)},isdisabled:function(bool){bool&&utils.error("已开启相同时间段的广告!")},checkDisabled:function(item){var bool=!1;return item.disabled=!1,angular.forEach(vm.list,function(value){value.opened&&value.id!=item.id&&(moment(item.start_time).unix()-moment(value.end_time).unix()>0||moment(item.end_time).unix()-moment(value.start_time).unix()<0||(bool=!0,item.disabled=!0))}),bool},getAdvertList:function(){vm.loading=!1;var url=config.getAPI("getadvertlist"),params=this.collectListParam();http(url,{method:"get",params:params}).then(function(resp){resp.error||(vm.list=resp.data,angular.forEach(vm.list,function(val,index){1==val.opened&&(val.opened=!0),0==val.opened&&(val.opened=!1)}),vm.nodata=!vm.list.length,vm.loading="complete",vm.initPagination(resp))})["catch"](function(){vm.loading="complete"})},showAdvertPop:function(index){vm.currentAdvertInfo=index>-1?vm.list[index]:{},advertisement.saveCurrentAdvertisement(vm.currentAdvertInfo),$state.go("mainLayout.addMessage")},initPagination:function(options){vm.pagination=vm.pagination||{},vm.paginationLoading="complete",vm.advertlistcount=[{name:"每页10条",id:10},{name:"每页20条",id:20},{name:"每页40条",id:40}],angular.extend(vm.pagination,{totalItems:options.total,numPages:options.last_page,itemsPerPage:options.per_page,maxSize:options.last_page,currentPage:options.current_page,countconfig:vm.advertlistcount,pagecount:options.per_page}),0==vm.pagination.currentPage&&(vm.nodata=!1)},collectListParam:function(){var params={};return vm.pagination&&vm.pagination.currentPage&&(params.page=vm.pagination.currentPage,params.count=vm.pagination.pagecount),params},watchCurrentPage:function(){var _this=this;$scope.$watch("vm.pagination.currentPage",function(currentpage,old){currentpage&&old&&(vm.paginationLoading=!1,_this.getAdvertList())}),$scope.$watch("vm.pagination.pagecount",function(currentpagecount,old){currentpagecount&&old&&(vm.paginationLoading=!1,_this.getAdvertList())})},currentSelected:0,categoryCache:[],check:function(index,id){var isCheck=vm.list[index].isCheck;vm.list[index].isCheck=!isCheck,vm.currentSelected=isCheck?vm.currentSelected-1:vm.currentSelected+1,vm.currentSelected==vm.list.length?vm.isCheckAll=!0:vm.isCheckAll=!1},checkAll:function(){vm.isCheckAll=!vm.isCheckAll,this._select()},cancelAll:function(){vm.isCheckAll=!1,this._select()},_select:function(){angular.forEach(vm.list,function(val,key){val.isCheck=vm.isCheckAll}),vm.currentSelected=vm.isCheckAll?vm.list.length:0},delList:function(){var ids=[],listIndex=[],newdata=[];vm.isCheckAll?angular.forEach(vm.list,function(val){ids.push(val.id)}):(angular.forEach(vm.list,function(val,key){val.isCheck&&(ids.push(val.id),listIndex.push(key))}),ids.length||utils.error("请选择要删除的内容"));var idsStr=ids.join(",");utils.confirm({headTitle:"删除提醒",msg:"确定删除选中的广告吗?"},function(sure){if(sure){var url=config.getAPI("deletadvert");vm.loading=!1,http(url,{method:"post",data:{id:idsStr}}).then(function(data){data.error?utils.error(data.error.message):(vm.isCheckAll?(vm.list=[],vm.isCheckAll=!1,vm.nodata=!0):(angular.forEach(vm.list,function(value){value.isCheck||newdata.push(value)}),vm.list=newdata,!vm.list.length&&(vm.nodata=!0)),vm.currentSelected=0),vm.getAdvertList(),vm.loading="complete"})["catch"](function(reject){vm.loading="complete"})}})}}),$scope.$on("checkApp",function(event,first_appinfo){vm.init()})}])});