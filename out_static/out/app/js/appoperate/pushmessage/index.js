"use strict";define(function(require){var app=require("app");require("common/directives/pager-redirect"),require("common/directives/form-select"),require("common/directives/pagination/page1"),app.controller("PushMessageCtrl",["$scope","$modal","$state","navconfig","utils","config","http","upload",function($scope,$modal,$state,navconfig,utils,config,http,upload){var vm=$scope.vm={};angular.extend(vm,{init:function(){vm.loading=!1,vm.showresultpage=!1,vm.getPushCondition(),vm.getPushList(),vm.watchCurrentPage()},getPushCondition:function(){vm.loading=!1;var url=config.getAPI("getpushcondition");http(url).then(function(resp){resp.error_code||(vm.push_condition=resp.result.push_condition,vm.promote_condition=resp.result.promote_condition,vm.condition=resp.result.flags,vm.condition&&(vm.permlist=[{status:vm.condition.demo_flag,desc:"APP不存在测试数据（导入了演示数据）"},{status:vm.condition.version_flag,desc:"APP安卓版打包成功（成功打包测试版或正版）且测试版版号≥1.0.10"},{status:vm.condition.record_flag,desc:"APP内容 ≥ 模块数x10"},{status:vm.condition.link_flag,desc:"APP外链模块数 < APP模块总数的1/2"},{status:vm.condition.active_flag,desc:"APP 30天内激活量≥20"}]),vm.loading="complete")})},showWechat:function(){vm.show=!0},hideWechat:function(){vm.show=!1},uploadPic:function(file,flag){vm.loading=!1;var url=config.getAPI("upload");upload(url,file,90,90).then(function(resp){var obj=resp.material,src=obj.host+obj.dir+obj.filepath+obj.filename;"wechat"==flag&&(vm.wechaturl=src),"baidu"==flag&&(vm.baiduurl=src),"next"==flag&&(vm.nexturl=src),vm.loading="complete"},function(reason){utils.error("该图片上传失败!"),vm.loading="complete"})},upLoadPicWeChat:function(file){vm.uploadPic(file,"wechat")},upLoadPicBaidu:function(file){vm.uploadPic(file,"baidu")},upLoadPicNext:function(file){vm.uploadPic(file,"next")},submit:function(){vm.loading=!1;var url=config.getAPI("savepromotepic");http(url,{method:"post",data:{pic1:vm.wechaturl,pic2:vm.baiduurl,pic3:vm.nexturl}}).then(function(resp){resp.error_code||(vm.hidepushform=!0,vm.showresultpage=!0,vm.loading="complete")})["catch"](function(){vm.loading="complete"})},toPushPage:function(){vm.init()},getPushList:function(){vm.loading=!1;var url=config.getAPI("getpushlist"),params=this.collectListParam();http(url,{params:params}).then(function(resp){resp.error?(utils.error(resp.error_message),vm.loading="complete"):(vm.listdata=resp.data,vm.initPagination(resp),vm.loading="complete",vm.nodata=!vm.listdata.length)})},initPagination:function(options){vm.pagination=vm.pagination||{},vm.paginationLoading="complete",vm.advertlistcount=[{name:"每页10条",id:10},{name:"每页20条",id:20},{name:"每页40条",id:40}],angular.extend(vm.pagination,{totalItems:options.total,numPages:options.last_page,itemsPerPage:options.per_page,maxSize:options.last_page,currentPage:options.current_page,countconfig:vm.advertlistcount,pagecount:options.per_page}),0==vm.pagination.currentPage&&(vm.nodata=!1)},collectListParam:function(){var params={};return vm.pagination&&vm.pagination.currentPage&&(params.page=vm.pagination.currentPage,params.count=vm.pagination.pagecount),params},watchCurrentPage:function(){var _this=this;$scope.$watch("vm.pagination.currentPage",function(currentpage,old){currentpage&&old&&(vm.paginationLoading=!1,_this.getPushList())}),$scope.$watch("vm.pagination.pagecount",function(currentpagecount,old){currentpagecount&&old&&(vm.paginationLoading=!1,_this.getPushList())})},delCurrentList:function(id,index){utils.confirm({headTitle:"删除提醒",msg:"确定删除当前推送吗?"},function(sure){if(sure){var url=config.getAPI("deletpush");vm.loading=!1,http(url,{method:"post",data:{id:id}}).then(function(data){data.error||(vm.listdata.splice(index,1),vm.nodata=!vm.listdata.length,vm.loading="complete")})}})},currentSelected:0,categoryCache:[],check:function(index,id){var isCheck=vm.listdata[index].isCheck;vm.listdata[index].isCheck=!isCheck,vm.currentSelected=isCheck?vm.currentSelected-1:vm.currentSelected+1,vm.currentSelected==vm.listdata.length?vm.isCheckAll=!0:vm.isCheckAll=!1},checkAll:function(){vm.isCheckAll=!vm.isCheckAll,this._select()},cancelAll:function(){vm.isCheckAll=!1,this._select()},_select:function(){angular.forEach(vm.listdata,function(val,key){val.isCheck=vm.isCheckAll}),vm.currentSelected=vm.isCheckAll?vm.listdata.length:0},delList:function(){var ids=[],listIndex=[],newdata=[];vm.isCheckAll?angular.forEach(vm.listdata,function(val){ids.push(val.id)}):(angular.forEach(vm.listdata,function(val,key){val.isCheck&&(ids.push(val.id),listIndex.push(key))}),ids.length||utils.error("请选择要删除的内容"));var idsStr=ids.join(",");utils.confirm({headTitle:"删除提醒",msg:"确定删除选中的内容吗?"},function(sure){if(sure){var url=config.getAPI("deletpush");vm.loading=!1,http(url,{method:"post",data:{id:idsStr}}).then(function(data){data.error?utils.error(data.error.message):(vm.isCheckAll?(vm.listdata=[],vm.isCheckAll=!1,vm.nodata=!0):(angular.forEach(vm.listdata,function(value){value.isCheck||newdata.push(value)}),vm.listdata=newdata,!vm.listdata.length&&(vm.nodata=!0)),vm.currentSelected=0),vm.getPushList(),vm.loading="complete"})["catch"](function(reject){vm.loading="complete"})}})}}),$scope.$on("checkApp",function(event,first_appinfo){vm.init()})}])});