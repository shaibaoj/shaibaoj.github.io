"use strict";define(function(require){var app=require("app");require("../modal/feedback/feedbackModal"),require("common/directives/form-select"),require("common/directives/pagination/page1"),app.controller("FeedbackCtrl",["$scope","$modal","$state","navconfig","utils","config","http",function($scope,$modal,$state,navconfig,utils,config,http){var vm=$scope.vm={};angular.extend(vm,{init:function(){vm.loading="init",vm.getFeedbackList(),vm.watchCurrentPage()},getFeedbackList:function(){vm.loading=!1;var params=this.collectListParam(),url=config.getAPI("getfeedbacklist");http(url,{method:"get",params:params}).then(function(resp){console.log("意见反馈数据: ",resp),resp.error||(vm.list=resp.data,vm.nodata=!vm.list.length,vm.initPagination(resp),vm.loading="complete")})},showFeedbackModal:function(index){vm.currentBackInfo=vm.list[index]||{};var modalInstance=$modal.open({animateanimation:!0,size:400,templateUrl:"appoperate/modal/feedback/feedbackModal.html",controller:"ModalFeedbackCtrl",resolve:{currentBackInfo:vm.currentBackInfo}});modalInstance.result.then(function(data){data&&vm.getFeedbackList()})},delCurrentList:function(index){console.log(index);var token=vm.list[index].device_token;console.log(vm.list[index].device_token),utils.confirm({headTitle:"删除提醒",msg:"确定删除当前回复吗?"},function(sure){if(sure){var url=config.getAPI("delallreply");vm.loading=!1,http(url,{method:"post",data:{device_token:token}}).then(function(data){vm.list.splice(index,1),vm.nodata=!vm.list.length,vm.loading="complete"})}})},initPagination:function(options){vm.pagination=vm.pagination||{},vm.paginationLoading="complete",vm.advertlistcount=[{name:"每页10条",id:10},{name:"每页20条",id:20},{name:"每页40条",id:40}],angular.extend(vm.pagination,{totalItems:options.total,numPages:options.last_page,itemsPerPage:options.per_page,maxSize:options.last_page,currentPage:options.current_page,countconfig:vm.advertlistcount,pagecount:options.per_page}),0==vm.pagination.currentPage&&(vm.nodata=!1)},collectListParam:function(){var params={};return vm.pagination&&vm.pagination.currentPage&&(vm.pagination.pagecount>vm.pagination.totalItems||vm.pagination.currentPage>Math.ceil(vm.pagination.totalItems/vm.pagination.pagecount)?params.page=1:params.page=vm.pagination.currentPage,params.count=vm.pagination.pagecount),params},watchCurrentPage:function(){var _this=this;$scope.$watch("vm.pagination.currentPage",function(currentpage,old){currentpage&&old&&(vm.paginationLoading=!1,_this.getFeedbackList())}),$scope.$watch("vm.pagination.pagecount",function(currentpagecount,old){currentpagecount&&old&&(vm.paginationLoading=!1,_this.getFeedbackList())})},currentSelected:0,categoryCache:[],check:function(index,id){var isCheck=vm.list[index].isCheck;vm.list[index].isCheck=!isCheck,vm.currentSelected=isCheck?vm.currentSelected-1:vm.currentSelected+1,vm.currentSelected==vm.list.length?vm.isCheckAll=!0:vm.isCheckAll=!1},checkAll:function(){vm.isCheckAll=!vm.isCheckAll,this._select()},cancelAll:function(){vm.isCheckAll=!1,this._select()},_select:function(){angular.forEach(vm.list,function(val,key){val.isCheck=vm.isCheckAll}),vm.currentSelected=vm.isCheckAll?vm.list.length:0},delList:function(){var ids=[],listIndex=[],newdata=[];vm.isCheckAll?angular.forEach(vm.list,function(val){ids.push(val.id)}):(angular.forEach(vm.list,function(val,key){val.isCheck&&(ids.push(val.id),listIndex.push(key))}),ids.length||utils.error("请选择要删除的内容"));var idsStr=ids.join(",");utils.confirm({headTitle:"删除提醒",msg:"确定删除选中的内容吗?"},function(sure){if(sure){var url=config.getAPI("delsinglereply");vm.loading=!1,http(url,{method:"post",data:{id:idsStr}}).then(function(data){data.error?utils.error(data.error.message):(vm.isCheckAll?(vm.list=[],vm.isCheckAll=!1,vm.nodata=!0):(angular.forEach(vm.list,function(value){value.isCheck||newdata.push(value)}),vm.list=newdata,!vm.list.length&&(vm.nodata=!0)),vm.currentSelected=0),vm.getFeedbackList(),vm.loading="complete"})["catch"](function(reject){vm.loading="complete"})}})}}),$scope.$on("checkApp",function(event,first_appinfo){vm.init()})}])});