"use strict";define(function(require){var app=require("app"),moment=require("moment");require("common/directives/datetimepicker"),require("common/modal/modal-header"),require("common/modal/modal-footer"),require("appmake/services/pageManagerService"),require("appmake/page_design/child_ctrl/select_page"),app.controller("ModalAdvertCtrl",["$scope","$state","navconfig","utils","config","http","$mdDialog","upload","currentAdvertInfo","pageManagerService",function($scope,$state,navconfig,utils,config,http,$mdDialog,upload,currentAdvertInfo,pageManagerService){var vm=$scope.vm={};angular.extend(vm,{currentAdvertInfo:currentAdvertInfo,init:function(){vm.loading="init",vm.showtimeinit=!1,pageManagerService.getUriList(),vm.internalChainName="",vm.currentAdvertInfo.id&&vm.getAdvertDetail()},getAdvertDetail:function(){vm.loading=!1;var url=config.getAPI("getadvertdetail").replace("{id}",vm.currentAdvertInfo.id);http(url).then(function(resp){console.log("返回值",resp),resp.error||(vm.detail=resp.result,vm.name=vm.detail.cname,vm.describe=vm.detail.desc,vm.material=vm.detail.image,vm.url=vm.detail.link,vm.duration=vm.detail.duration,vm.starttime=vm.detail.start_time,vm.endtime=vm.detail.end_time,vm.loading="complete",vm.displayCountdown=vm.detail.display_countdown)})},upLoadLocalMaterial:function(file){vm.loading=!1;var url=config.getAPI("upload");upload(url,file,90,90,"startImage").then(function(resp){var obj=resp.material;vm.material=obj.host+obj.dir+obj.filepath+obj.filename,vm.loading="complete"},function(reason){vm.loading="complete"})},openSelectPop:function(){var modalData={url:""};pageManagerService.showPageDialog(modalData).then(function(data){vm.internalChainName=pageManagerService.getPageName(data.url),vm.url=data.url})},check:function(){var date=new Date,bool=!0;return vm.name?vm.describe?vm.duration?vm.starttime?vm.endtime?(vm.starttime>vm.endtime&&(utils.error("结束时间不得小于开始时间!"),bool=!1),Math.ceil(moment(vm.starttime).unix()/6e4)<Math.ceil(moment(date).unix()/6e4)&&(utils.error("开始时间不得小于当前时间！"),bool=!1),bool):(utils.error("请填写结束时间!"),!1):(utils.error("请填写开始时间!"),!1):(utils.error("请填写广告持续时间!"),!1):(utils.error("请填写描述!"),!1):(utils.error("请填写广告名称!"),!1)},save:function(){if(vm.check()){var obj={position_type:"start",name:vm.name,desc:vm.describe,image:vm.material,link:vm.url,duration:vm.duration,start_time:vm.starttime,end_time:vm.endtime,display_countdown:vm.displayCountdown};vm.currentAdvertInfo.id&&(obj.id=vm.currentAdvertInfo.id);var url=config.getAPI("createadvert");http(url,{method:"post",data:obj}).then(function(resp){resp.error||(utils.success("广告发布成功").then(function(){vm.currentAdvertInfo.cname=vm.name,vm.currentAdvertInfo.end_time=vm.endtime,vm.currentAdvertInfo.start_time=vm.starttime,vm.currentAdvertInfo.image=vm.material}),setTimeout(function(){$mdDialog.hide(vm.currentAdvertInfo)},1500))})}}}),vm.init()}])});
