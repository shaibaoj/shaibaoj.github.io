"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};define(function(require){require("common/directives/form-select"),require("common/directives/loading");var moment=(require("heightchart"),require("moment")),app=require("app"),server=require("common/services/server");app.controller("orderSituation",["$scope","config","http","$log","utils","$state","$timeout",function($scope,config,http,$log,utils,$state,$timeout){var vm=$scope.vm={};angular.extend(vm,{search_dropDown_options:[{name:"昨日",days:1},{name:"最近7天",days:7},{name:"最近15天",days:15},{name:"最近一个月",days:30}],default_search_day:7,init:function(){vm.init_search_dropDown(vm.search_dropDown_options),vm.get_yesterday_order_and_pay_data(),vm.get_withdraw_cash_value(),vm.search_order_data_by_time(vm.default_search_day)},init_search_dropDown:function(options){if(!angular.isArray(options))throw new Error("下拉配置数据类型有误");vm.dropDown_data=options},change_search_day:function(new_days){vm.search_order_data_by_time(new_days)},submit_withdraw_cash:function(){try{vm.verify_withdraw_cash_mod()}catch(e){throw new Error("权限验证出错",e)}},skip_to_other_manage:function(type){"all_order"!==type&&"unpaid"!==type||$state.go("mainLayout.orderlist",{type:type})},init_confirm_dialog:function(){utils.confirm({msg:["资料尚未认证，无法提现，","是否前往认证"],sureName:"取消",sureClass:"btn-cancel",cancelName:"确认",cancelClass:"btn-sure-verify",icon:"icon-authentication"},function(confirm_value){confirm_value||$state.go("mainLayout.currentautheninfo")})},get_current_search_time:function(){var current_time=new Date,_year=current_time.getFullYear(),_month=current_time.getMonth(),_day=current_time.getDate();return new Date(_year,_month,_day,7,0,0).getTime()},unixTime_to_date:function(unixTime){if(unixTime=Number(unixTime),"number"!=typeof unixTime||isNaN(unixTime))throw new Error("转换时间戳传入的值类型有误");unixTime=moment.unix(unixTime)._d;var _month=unixTime.getMonth()+1,_date=unixTime.getDate();return _month.toString()+"/"+_date.toString()},predicate_positive_value:function(test_value){return"number"==typeof test_value&&!isNaN(test_value)&&test_value>=0&&test_value%1===0},parse_number_to_float:function(parse_number){if(parse_number=Number(parse_number),"number"!=typeof parse_number||isNaN(parse_number))throw new Error("被转换的值不是数字类型");var string_parse_number=parse_number.toString(),decimal_index=string_parse_number.indexOf(".");for(decimal_index<0&&(decimal_index=string_parse_number.length,string_parse_number+=".");string_parse_number.length<=decimal_index+2;)string_parse_number+="0";return string_parse_number},convert_money:function(money_value){if("number"!=typeof money_value||isNaN(money_value)||!(money_value>=0))throw new Error("传入的金钱数据类型或者值错误");return 0<=money_value&&money_value<=999999?(money_value=Math.round(money_value)/100,vm.parse_number_to_float(money_value)):1e6<=money_value&&money_value<=999999999?(money_value=Math.round(money_value/100)/100,vm.parse_number_to_float(money_value)+"万"):void 0},set_render_yesterday_order_and_pay_number:function(yesterday_data){if(!angular.isObject(yesterday_data)||_.isEmpty(yesterday_data))throw new Error("昨日付款订单数和下单数数据有误");if(!vm.predicate_positive_value(yesterday_data.yesterday_order_pay_total))throw new Error("昨日付款订单数 数据类型或者值有误");if(!vm.predicate_positive_value(yesterday_data.yesterday_order_total))throw new Error("昨日下单数 数据类型或者值有误");vm.yesterday_order_pay_total_number=yesterday_data.yesterday_order_pay_total,vm.yesterday_order_number=yesterday_data.yesterday_order_total},set_chart_option:function(single_day_data){if(!angular.isObject(single_day_data))throw new Error("所有单天数据非对象");var _ret=function(){var order_arr=[],pay_order_arr=[],categories_arr=[],order_name="下单笔数",pay_orde_name="付款订单";return angular.forEach(single_day_data,function(value,key){try{var current_day=vm.unixTime_to_date(key)}catch(e){throw new Error("时间戳转换为 月.日 格式发生错误",e)}if(!vm.predicate_positive_value(value.order_total)||!vm.predicate_positive_value(value.pay_order_total))throw new Error("当前下单笔数或付款订单数 数据值有误");categories_arr.push(current_day),order_arr.push(value.order_total),pay_order_arr.push(value.pay_order_total)}),{v:{categories:categories_arr,series:[{name:order_name,data:order_arr},{name:pay_orde_name,data:pay_order_arr}]}}}();if("object"===("undefined"==typeof _ret?"undefined":_typeof(_ret)))return _ret.v},set_order_data_to_render:function(search_res){if(!angular.isObject(search_res)&&_.isEmpty(search_res))throw new Error("搜索返回的数据类型有误");angular.forEach(search_res,function(value,key){if("single_day_data"!==key&&"income"!==key&&!vm.predicate_positive_value(value))throw new Error("获取的"+key+"字段类型有误")}),vm.order_total_number=search_res.order_total,vm.unpaid_order_total_number=search_res.unpaid_order_total,vm.undeliver_order_total_number=search_res.undeliver_order_total,vm.refunding_order_total_number=search_res.refunding_order_total;try{vm.income=vm.convert_money(search_res.income)}catch(e){throw new Error("收入金钱 转换赋值错误 ",e)}try{vm.chart_option=vm.set_chart_option(search_res.single_day_data)}catch(e){throw new Error("图表渲染参数配置发生错误 ",e)}},render_order_chart:function(chart_options){vm.chart=$("#container").highcharts({chart:{type:"spline"},colors:["#14a7ff","#0ec9aa"],title:{text:""},xAxis:{categories:chart_options.categories,type:"datetime"},yAxis:{title:{text:""}},legend:{layout:"horizontal",align:"right",verticalAlign:"top"},tooltip:{backgroundColor:"#24334b",borderColor:"#24334b",borderRadius:10,borderWidth:1,shadow:!1,padding:10,style:{color:"#ffffff",fontSize:"12px",fontWeight:"normal",fontFamily:"Courir new"},crosshairs:{width:1,color:"#ccc",dashStyle:"shortdot"},shared:!0,animation:!0,useHTML:!0,headerFormat:"<span>{point.key}</span><br/>",pointFormat:'<p style="display:inline-block;margin:0;margin-right:10px;">{series.name}: <span style="color: {series.color};">{point.y}</span></p>',footerFormat:"</table>"},plotOptions:{spline:{marker:{states:{hover:{fillColor:"#fff",lineWidth:3,radius:6}},radius:1,symbol:"circle"}}},series:[{name:chart_options.series[0].name,marker:{symbol:"circle",states:{hover:{lineColor:"#14a7ff"}}},data:chart_options.series[0].data,color:"#14a7ff",lineWidth:3},{name:chart_options.series[1].name,marker:{symbol:"circle",states:{hover:{lineColor:"#05ccac"}}},data:chart_options.series[1].data,color:"#05ccac",lineWidth:3}],credits:{enabled:!1}})},get_yesterday_order_and_pay_data:function(){var url=config.getAPI("get_yesterday_order_and_pay");http(url,{method:"GET"}).then(function(res){if($log.log("昨日下单数和付款订单数据 >>>",res),0===res.error_code)return res.result;throw utils.error(res.error_message),new Error(res.error_message)}).then(function(value){try{vm.set_render_yesterday_order_and_pay_number(value)}catch(e){$log.log("赋值昨日下单数和付款订单数据有误",e)}vm.loading="get_yesterday_order_and_pay_data_complete"})["catch"](function(e){$log.log(e)})},get_withdraw_cash_value:function(){var url=config.getAPI("get_withdraw_cash_value");http(url,{method:"GET"}).then(function(res){if(0!==res.error_code)throw utils.error(res.error_message),new Error(res.error_message);if(!res.result||null==res.result.available)throw new Error("缺少可提现字段数据");$log.log("可提现金额数目为 >>>",res.result.available),vm.withdraw_cash_value=Number(res.result.available/100).toFixed(2)})},search_order_data_by_time:function(search_time){if(search_time=Number(search_time),"number"!=typeof search_time)throw new Error("查询时间范围传入的 查询天数数据类型错误");var end_time=vm.get_current_search_time()/1e3,start_time=end_time-24*search_time*60*60,url=config.getAPI("search_order_by_time");vm.loading=!1,http(url,{method:"POST",data:{start_time:start_time,end_time:end_time}}).then(function(res){if($log.log("用户"+search_time+"天订单数据 >>>",res),0===res.error_code)return res.result;throw utils.error(res.error_message),new Error(res.error_message)}).then(function(value){vm.set_order_data_to_render(value)}).then(function(){$timeout(function(){vm.render_order_chart(vm.chart_option)},500)}).then(function(){vm.loading="search_order_data_by_time_complete"})["catch"](function(e){$log.log(e)})},verify_withdraw_cash_mod:function(){var url=config.getAPI("verify_withdraw_cash_mod"),pass="pass",no_pass="no_pass";vm.loading=!1,http(url,{method:"GET"}).then(function(res){if($log.log("验证提现权限返回的数据 >>>",res),res.user)return 2===res.user.user_type||3===res.user.user_type?vm.withdraw_cash_mod=pass:vm.withdraw_cash_mod=no_pass,{mod:vm.withdraw_cash_mod,user_id:res.user.user_id};throw new Error("用户接口返回数据缺少user字段")}).then(function(value){if(vm.loading="get_verify_withdraw_cash_mod_complete","no_pass"===value.mod)vm.init_confirm_dialog();else{var withdraw_url=server.withdraw_authurl,channel=server.service_store_channel,product_id="withdraw",redirect_url=server.host+"ecshop/ordersituation",openid=value.user_id,_url=withdraw_url+"?channel="+channel+"&product_id="+product_id+"&redirect_url="+redirect_url+"&openid="+openid;$log.log("提现跳转地址为 >>>",_url),window.location=_url}})["catch"](function(e){$log.log(e)})}}),$scope.$on("checkApp",function(){vm.init()})}])});