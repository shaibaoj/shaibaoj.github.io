"use strict";define(function(require){var app=require("app"),moment=require("moment");require("common/directives/pager-redirect"),require("common/directives/datetimepicker"),require("ecshop/modal/logisticsInfoModal"),require("ecshop/modal/revisePriceModal"),require("common/directives/content-reply"),app.controller("OrderManageListCtrl",["$stateParams","$scope","$state","http","config","utils","navconfig","$modal","$q","$rootScope",function($stateParams,$scope,$state,http,config,utils,navconfig,$modal,$q,$rootScope){var vm=$scope.vm={};angular.extend(vm,{init:function(guid){if(vm.initListParam(),vm.getOrderList(),vm.watchCurrentPage(),$stateParams.type){var type="all_order"===$stateParams.type?"":$stateParams.type;vm.changeState(type)}},getOrderList:function(){vm.currentOrderlist=[],vm.paginationLoading=!1;var url=config.getAPI("getorderlist"),params=vm.collectListParam();http(url,{method:"get",params:params}).then(function(resp){if(0==+resp.error_code){if(vm.orderlist=resp.result.data,console.log(vm.pagination,"vm.pagination"),vm.pagination&&vm.pagination.currentPage){var options={per_page:20,current_page:vm.pagination.currentPage,total:resp.result.count,total_pages:Math.ceil(resp.result.count/20)};vm.initPagination(options)}else{var options={per_page:20,current_page:1,total:resp.result.count,total_pages:Math.ceil(resp.result.count/20)};vm.initPagination(options)}vm.initTime(resp.result.data),vm.initProductImg(vm.orderlist),vm.currentOrderlist=angular.copy(vm.orderlist),vm.orderlist&&vm.orderlist.length?vm.nodata=!1:vm.nodata=!0}vm.paginationLoading="complete"})["catch"](function(resp){vm.paginationLoading="complete"})},initTime:function(orderlist){angular.forEach(orderlist,function(order){order.create_time&&(order.create_time=vm.format_time(order.create_time)),order.delivery_time&&(order.delivery_time=vm.format_time(order.delivery_time)),order.assess&&order.assess.time&&(order.assess.time=vm.format_time(order.assess.time))})},format_time:function(time){return moment(time).format("YYYY-MM-DD HH:mm")},productInfo:function(product_id,model_id){$rootScope.create_model_table=null,$state.go("secondLayout.contentform",{model_id:model_id,id:product_id})},orderstates:{"":"全部订单",unpaid:"待支付",paid:"已支付",delivery:"已发货",success:"交易成功",closed:"已关闭"},changeState:function(state){vm.current_state=state,vm.getOrderList()},collectListParam:function(){var params={order_no:vm.currentorderno,trade_time_start:vm.current_starttime?moment(vm.current_starttime).unix():"",trade_time_end:vm.current_endtime?moment(vm.current_endtime).unix()+86400-1:"",status:vm.current_state,buyer_name:vm.current_custom,product_name:vm.current_productname};return vm.pagination&&vm.pagination.currentPage&&(params["api.page"]=vm.pagination.currentPage,params["api.size"]=vm.pagination.itemsPerPage),console.log("搜集到的",params),params},initPagination:function(options){vm.pagination={totalItems:options.total,numPages:options.total_pages,itemsPerPage:options.per_page,maxSize:options.total_pages,currentPage:options.current_page}},watchCurrentPage:function(){var _this=this;$scope.$watch("vm.pagination.currentPage",function(currentpage,old){currentpage&&old&&(console.log(currentpage,"当前页",old,"cc"),_this.getOrderList())}),$scope.$watch("vm.pagination.pagecount",function(currentpagecount,old){currentpagecount&&old&&(vm.paginationLoading=!1,console.log(currentpagecount,"当前页条数!!!!!!!",old),_this.getOrderList())})},search:function(){vm.pagination.currentPage=1,vm.getOrderList(),vm.initListParam()},initListParam:function(){vm.current_state=null,vm.orderstate=""},detialGoods:function(order,id){$state.go("mainLayout.aftersaledetails",{product_id:id})},delLogisticsInfo:function(order,id){console.log(order,"order"),utils.confirm({headTitle:"删除提醒",msg:"确定要关闭订单吗?"},function(sure){var url=config.getAPI("closeorder").replace("{order_no}",id);return http(url,{method:"post"}).then(function(){order.status="closed"})})},addLogisticsInfoModal:function(order,id){var defer=$q.defer();return utils.mdDialog({controller:"LogisticsInfoModalCtrl",templateUrl:"ecshop/modal/logisticsInfoModal.html",locals:{order:order}}).then(function(data){order.status="delivery",order.logistics_name=data.currentCompany,order.logistics_number=data.express_number,defer.resolve(data)}),defer.promise},revisePriceModal:function(order,id){var defer=$q.defer();return utils.mdDialog({controller:"RevisePriceModalCtrl",templateUrl:"ecshop/modal/revisePriceModal.html",locals:{order:order}}).then(function(data){order.total=data.total_price,order.express_fee=data.logistics_price,defer.resolve(data)}),defer.promise},initProductImg:function(orderlist){angular.forEach(orderlist,function(order){angular.forEach(order.items,function(val){val.image_url=utils.getImgUrl(val.image_url),order.is_virtual=val.is_virtual,val.is_virtual&&(vm.orderstates.delivery="待收货")})})},toggleContentReply:function(item){vm.currentShowReplay=item.id,console.log(vm.currentShowReplay,"item",item.id)}}),$scope.$on("checkApp",function(event,first_appinfo){var guid=first_appinfo.guid;vm.init(guid)})}])});