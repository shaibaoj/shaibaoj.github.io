"use strict";define(function(require){var app=require("app"),moment=require("moment");require("common/services/modelService"),require("common/directives/pager-redirect"),app.controller("CouponCtrl",["$scope","utils","navconfig","config","http","$state","$stateParams","$modal",function($scope,utils,navconfig,config,http,$state,$stateParams,$modal){var vm=$scope.vm={};angular.extend(vm,{currentState:0,init:function(guid){this.watchCurrentPage(),this.getecshopmarketlist()},getecshopmarketlist:function(){var _url=config.getAPI("activitylist").replace("{guid}",vm.guid).replace("{promo_type}","coupon"),params=vm.collectListParam();http(_url,{params:params}).then(function(data){vm.timestamp_trans(data.data),vm.currentlist=angular.copy(data.data),vm.statue_change(vm.currentState),vm.initPagination(data.meta.pagination),0==vm.activelist.length&&(vm.nodata=!0)})},collectListParam:function(status){var params={};return status&&(params.status=status),vm.mate&&vm.mate.currentPage&&(params.page=vm.mate.currentPage,params.count=vm.mate.pagecount),params},initPagination:function(options){vm.mate=vm.mate||{},angular.extend(vm.mate,{totalItems:options.total,numPages:options.total_pages,itemsPerPage:options.per_page,maxSize:options.total_pages,currentPage:options.current_page,countconfig:config.listcount,pagecount:options.per_page})},watchCurrentPage:function(){var _this=this;$scope.$watch("vm.mate.currentPage",function(currentpage,old){currentpage&&old&&(vm.mateLoading=!1,_this.getecshopmarketlist())}),$scope.$watch("vm.mate.pagecount",function(currentpagecount,old){currentpagecount&&old&&_this.getecshopmarketlist()})},creatActive:function(){$state.go("mainLayout.createcoupon")},editActive:function(id){$state.go("mainLayout.createcoupon",{product_id:id})},delete_active:function(index,id,statue){utils.confirm({headTitle:"删除提醒",msg:"确定删除选中的数据吗?"},function(sure){if(sure)if(1==statue){var _url=config.getAPI("activitydelete").replace("{guid}",vm.guid).replace("{promotion_id}",id);http(_url,{method:"delete"}).then(function(data){data.error?utils.error(data.error.message):(vm.mate.totalItems-=1,vm.activelist.splice(index,1),vm.getecshopmarketlist(),!vm.activelist.length&&(vm.nodata=!0),vm.loading="complete")})}else utils.error("只能删除未开始的活动")})},disable_active:function(item,index){utils.confirm({headTitle:"删除提醒",msg:"确定作废该优惠券吗?"},function(sure){if(sure)if(2==item.status){var _url=config.getAPI("activitydisable").replace("{guid}",vm.guid).replace("{promotion_id}",item.id);http(_url,{method:"patch"}).then(function(data){item.status=3})}else utils.error("只能作废进行中的活动")})},timestamp_trans:function(obj){angular.forEach(obj,function(value){value.from_time=moment(value.from_time).format("YYYY-MM-DD HH:mm:ss"),value.to_time=moment(value.to_time).format("YYYY-MM-DD HH:mm:ss"),value.create_time=moment(value.create_time).format("YYYY-MM-DD HH:mm:ss")})},statue_change:function(statue){var _obj=[];0==statue?_obj=vm.currentlist:angular.forEach(vm.currentlist,function(value){value.status==statue&&_obj.push(value)}),vm.activelist=_obj,0==vm.activelist.length&&(vm.nodata=!0),0!=vm.activelist.length&&(vm.nodata=!1),vm.currentState=statue}}),$scope.$on("checkApp",function(event,first_appinfo){var guid=first_appinfo.guid;vm.init(guid)})}])});