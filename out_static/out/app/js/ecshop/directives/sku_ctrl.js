"use strict";define(function(require){var app=require("app");require("common/directives/datetimepicker"),require("common/directives/angular.ueditor"),require("common/services/localStroge");require("moment");app.controller("SkuModelCtrl",["$scope","$state","http","config","utils","navconfig","localStorages","upload","$stateParams",function($scope,$state,http,config,utils,navconfig,localStorages,_upload,$stateParams){var vm=$scope.vm={};angular.extend(vm,{ueconfig:{initialFrameHeight:400,initialFrameWidth:"100%"},init:function(){vm.ecshopFields=$scope.skumodel.ecshopFields,vm.deliverProductLocal=$scope.skumodel.ecshopData,console.log($scope.skumodel,vm.ecshopFields,"vmvmvmvmvecshopFields",vm.deliverProductLocal,"vmvmvmvmvecshopdata"),vm.initData(),vm.getSkuK(),vm.watchsku(),vm._setStepVal()},checkField:function(){angular.forEach(vm.ecshopFields,function(_field){"num"==_field.key&&vm.deliverProductLocal.skus&&vm.deliverProductLocal.skus.length&&(_field.value=vm.deliverProductLocal.num),"sold_num"!=_field.key||_field.value||(_field.value=0)})},_setStepVal:function(){if($stateParams.id)vm.getEditProductInfo();else{vm.watchskuinfo();var obj={now:"",origin:""};vm.deliverProductLocal.unit_price=obj,vm.deliverProductLocal.num=0}},initData:function(){vm.addsku=0,vm.editskuinfo=!0},getEditProductInfo:function(){if(vm.deliverProductLocal&&vm.deliverProductLocal.skus&&vm.deliverProductLocal.skus.length){vm.editskuinfo=!1,vm.skuinfo=[];var properties=vm.deliverProductLocal.skus[0].properties_name_list,data=vm.deliverProductLocal.skus;properties&&properties[0]&&vm.initSkuInfo(data,0),properties&&properties[1]&&vm.initSkuInfo(data,1),properties&&properties[2]&&vm.initSkuInfo(data,2)}},getSkuK:function(){var url=config.getAPI("getconfigure");http(url).then(function(data){vm.skuk=data.configure.sku_child})},upload:function(file,flag,sku){"item-pic"===flag?vm.loading=!1:"sku-pic"===flag?vm.loading=!1:"update"===flag&&(sku.loading=!1);var url=config.getAPI("upload");_upload(url,file,100,100).then(function(resp){var obj=resp.material;"item-pic"===flag?(vm.loading="complete",vm.addProductPic(obj)):"sku-pic"===flag?(vm.loading="complete",vm.currentv?vm.checkPropertiesName(0)?utils.error("输入的规格属性名称重复！"):(vm.addStylePic(obj),vm.addPropertiesName(sku,1,0)):utils.error("请输入规格属性名称！")):"update"===flag&&angular.forEach(vm.skuinfo,function(val){angular.forEach(val.value,function(vv,index){return console.log(vv.v,sku.v),""==vv.v?(utils.error("请输入规格属性名称！"),void(sku.loading="complete")):void(vv.v==sku.v&&(vm.skuinfo[0].image||(vm.skuinfo[0].image=[]),vm.skuinfo[0].image[index]=obj,vv.img=utils.getImgUrl(obj),console.log("vv",vv,"vm.skuinfo 更新",vm.skuinfo),vm.initSaleSku(),sku.loading="complete"))})}),vm.loading="complete"},function(reason){utils.error("该图片上传失败!")})},watchskuinfo:function(){$scope.$watch("vm.skuinfo",function(newValue){var bool=!1;angular.forEach(vm.skuinfo,function(val){var arr=[];angular.forEach(val.value,function(v){arr.push(v.v)}),_.unique(arr).length!=arr.length&&(bool=!0)}),bool?utils.error("输入的规格属性名称重复！"):vm.initSaleSku()},!0)},checkValue:function(model,index){""==model&&(utils.error("请输入规格属性名称！"),vm.deliverProductLocal.unsave=!0,console.log(index))},watchsku:function(){$scope.$watch("vm.deliverProductLocal.skus",function(newValue){vm.lowPrice(newValue),vm.totleCount(newValue)},!0)},setProductPic:function(file){vm.upload(file,"item-pic")},setStylePic:function(file,sku){vm.upload(file,"sku-pic",sku)},addProductPic:function(obj){var productpic=vm.deliverProductLocal.item_imgs;productpic||(productpic=[]),productpic.push(obj),vm.deliverProductLocal.item_imgs=productpic,vm.currentProductImg=vm.initImgList(vm.deliverProductLocal.item_imgs)},initImgList:function(data){var arr=[];return data&&angular.forEach(data,function(val){arr.push(vm.handlePic(val))}),arr},addStylePic:function(obj){var skupic=vm.skuinfo[0].image;skupic||(skupic=[]),skupic.push(obj),vm.skuinfo[0].image=skupic,vm.currentSkuImg=vm.initImgList(vm.skuinfo[0].image),vm.skuinfo[0].v="",vm.initSaleSku()},updateStylePic:function(file,vv){vm.upload(file,"update",vv),console.log("vv",vv,"vm.currentSkuImg",vm.currentSkuImg,"vm.skuinfo",vm.skuinfo)},deleteStylePic:function(sku){angular.forEach(vm.skuinfo,function(val){angular.forEach(val.value,function(vv,index){sku.v==vv.v&&(vm.skuinfo[0].image[index]="",vv.img="")})})},handlePic:function(obj){return obj.host+obj.dir+obj.filepath+obj.filename},deleteSkuValue:function(sku,index,skukey){1==sku.value.length?(sku.value.splice(index,1),sku.image&&sku.image.splice(index,1)):(sku.value.splice(index,1),sku.image&&(sku.image.splice(index,1),vm.currentSkuImg=vm.initImgList(sku.image))),vm.initSaleSku()},deleteSku:function(key){vm.skuinfo.splice(key,1),vm.skuinfo.length||(vm.deliverProductLocal.skus=[],vm.editskuinfo=!0),vm.initSaleSku()},addSku:function(){vm.addsku++,vm.skuinfo||(vm.skuinfo=[]);var obj={kid:"",k:"",value:[]};vm.skuinfo.push(obj),vm.initSaleSku()},changeSku:function(k,sku){vm.editskuinfo&&(vm.checkSkuStyle(k)?utils.error("规格名不能相同！"):(sku.k=k.key,sku.kid=k.kid,vm.initSaleSku()))},showAddProperties:function(sku){sku.addproperties=!0},checkSkuStyle:function(k){var bool=!1;return vm.skuinfo.length>1&&angular.forEach(vm.skuinfo,function(val){k.key==val.k&&(bool=!0)}),bool},checkPropertiesName:function(index){var bool=!1;return angular.forEach(vm.deliverProductLocal.skus,function(val){val.properties_name_list[index].v==vm.currentv&&(bool=!0)}),bool},addPropertiesName:function(sku,index,key){if(vm.currentv)if(vm.checkPropertiesName(key))utils.error("输入的规格属性名称重复！");else{sku.addproperties=!1;var obj={v:vm.currentv,img:"",loading:!0};sku.value.push(obj),vm.currentv="",console.log(vm.skuinfo,"添加规格属性"),vm.initSaleSku()}else utils.error("请输入规格属性名称！"),vm.deliverProductLocal.unsave=!0},initSkuInfo:function(data,index){var addtype=!0,obj={},value=[],image=[];angular.forEach(data,function(sku){if(obj={k:sku.properties_name_list[index].k,kid:sku.properties_name_list[index].kid},angular.forEach(value,function(val){_.isMatch(val,{vid:sku.properties_name_list[index].vid})&&(addtype=!1)}),addtype){var obj1={v:sku.properties_name_list[index].v,vid:sku.properties_name_list[index].vid,img:utils.getImgUrl(sku.image)};image.push(sku.image),value.push(obj1)}addtype=!0}),obj.value=value,0==index&&(obj.image=image,vm.currentSkuImg=vm.initImgList(image)),vm.skuinfo.push(obj),console.log(vm.skuinfo)},batchFill:function(){vm.deliverProductLocal&&angular.forEach(vm.deliverProductLocal.skus,function(sku){vm.price&&(sku.price=parseFloat(vm.price)),vm.quantity&&(sku.quantity=parseInt(vm.quantity)),vm.outer_id&&(sku.outer_id=vm.outer_id)}),vm.price||vm.quantity||vm.outer_id?utils.success("批量填充成功！"):utils.error("请填值！"),vm.price="",vm.outer_id="",vm.quantity=""},checkCurrentSku:function(vid){vm.isoriginal=!1,vm.tempproperties={},vm.tempSkus&&angular.forEach(vm.tempSkus,function(val,key){if(val){var tempvid="";angular.forEach(val.properties_name_list,function(properties){tempvid+=properties.vid}),tempvid&&vid&&tempvid==vid&&(vm.isoriginal=!0,vm.tempproperties=val,vm.isoriginal=!0)}})},initSaleSku:function(){vm.deliverProductLocal.unsave=!1,vm.businesscodetotal=!1,vm.skuinfo?3==vm.skuinfo.length?vm.initSku():2==vm.skuinfo.length?vm.initSku2():1==vm.skuinfo.length&&vm.initSku3():vm.deliverProductLocal.skus=[]},initSku:function(){function init(v,key,v1,v2){var obj={};obj.k=vm.skuinfo[0].k,obj.kid=vm.skuinfo[0].kid,obj.v=v.v,obj.vid=v.vid?v.vid:"";var obj1={};obj1.k=vm.skuinfo[1].k,obj1.kid=vm.skuinfo[1].kid,obj1.v=v1.v,obj1.vid=v1.vid?v1.vid:"";var obj2={};obj2.k=vm.skuinfo[2].k,obj2.kid=vm.skuinfo[2].kid,obj2.v=v2.v,obj2.vid=v2.vid?v2.vid:"";var currentvid=obj.vid+obj1.vid+obj2.vid,sku={},list=[];list.push(obj),list.push(obj1),list.push(obj2),vm.skuinfo[0].image&&(sku.image=vm.skuinfo[0].image[key]),sku.sku_id=0,sku.with_hold_quantity="",sku.price=0,sku.quantity=0,sku.outer_id="",vm.checkCurrentSku(currentvid),vm.isoriginal&&(sku=vm.tempproperties),sku.properties_name_list=list,vm.deliverProductLocal.skus.push(sku)}if(vm.tempSkus=angular.copy(vm.deliverProductLocal.skus),vm.deliverProductLocal.skus=[],!vm.skuinfo[0].value.length&&vm.skuinfo[1].value.length&&vm.skuinfo[2].value.length){var v={v:""};angular.forEach(vm.skuinfo[1].value,function(v1){angular.forEach(vm.skuinfo[2].value,function(v2){init(v,0,v1,v2)})})}else if(!vm.skuinfo[1].value.length&&vm.skuinfo[0].value.length&&vm.skuinfo[2].value.length){var v1={v:""};angular.forEach(vm.skuinfo[0].value,function(v,key){angular.forEach(vm.skuinfo[2].value,function(v2){init(v,key,v1,v2)})})}else if(!vm.skuinfo[2].value.length&&vm.skuinfo[0].value.length&&vm.skuinfo[1].value.length){var v2={v:""};angular.forEach(vm.skuinfo[0].value,function(v,key){angular.forEach(vm.skuinfo[1].value,function(v1){init(v,key,v1,v2)})})}else if(vm.skuinfo[0].value.length||vm.skuinfo[1].value.length||!vm.skuinfo[2].value.length)if(vm.skuinfo[0].value.length||vm.skuinfo[2].value.length||!vm.skuinfo[1].value.length)if(vm.skuinfo[1].value.length||vm.skuinfo[2].value.length||!vm.skuinfo[0].value.length)if(vm.skuinfo[0].value.length||vm.skuinfo[1].value.length||vm.skuinfo[2].value.length)angular.forEach(vm.skuinfo[0].value,function(v,key){angular.forEach(vm.skuinfo[1].value,function(v1){angular.forEach(vm.skuinfo[2].value,function(v2){init(v,key,v1,v2)})})});else{var v={v:""},v1={v:""},v2={v:""};init(v,0,v1,v2)}else{var v1={v:""},v2={v:""};angular.forEach(vm.skuinfo[0].value,function(v,key){init(v,key,v1,v2)})}else{var v={v:""},v2={v:""};angular.forEach(vm.skuinfo[1].value,function(v1){init(v,0,v1,v2)})}else{var v={v:""},v1={v:""};angular.forEach(vm.skuinfo[2].value,function(v2){init(v,0,v1,v2)})}},initSku2:function(){function init(v,key,v1){var obj={};obj.k=vm.skuinfo[0].k,obj.kid=vm.skuinfo[0].kid,obj.v=v.v,obj.vid=v.vid?v.vid:"";var obj1={};obj1.k=vm.skuinfo[1].k,obj1.kid=vm.skuinfo[1].kid,obj1.v=v1.v,obj1.vid=v1.vid?v1.vid:"";var currentvid=obj.vid+obj1.vid,sku={},list=[];list.push(obj),list.push(obj1),vm.skuinfo[0].image&&(sku.image=vm.skuinfo[0].image[key]),sku.sku_id="",sku.with_hold_quantity="",sku.price=0,sku.quantity=0,sku.outer_id="",vm.checkCurrentSku(currentvid),vm.isoriginal&&(sku=vm.tempproperties),sku.properties_name_list=list,vm.deliverProductLocal.skus.push(sku)}if(vm.tempSkus=angular.copy(vm.deliverProductLocal.skus),vm.deliverProductLocal.skus=[],!vm.skuinfo[0].value.length&&vm.skuinfo[1].value.length){var v={v:""};angular.forEach(vm.skuinfo[1].value,function(v1){init(v,0,v1)})}else if(!vm.skuinfo[1].value.length&&vm.skuinfo[0].value.length){var v1={v:""};angular.forEach(vm.skuinfo[0].value,function(v,key){init(v,key,v1)})}else if(vm.skuinfo[1].value.length||vm.skuinfo[0].value.length)angular.forEach(vm.skuinfo[0].value,function(v,key){angular.forEach(vm.skuinfo[1].value,function(v1){init(v,key,v1)})});else{var v1={v:""},v={v:""};init(v,0,v1)}},initSku3:function(){function init(v,key){var obj={};obj.k=vm.skuinfo[0].k,obj.kid=vm.skuinfo[0].kid,obj.v=v.v,obj.vid=v.vid?v.vid:"";var currentvid=obj.vid,sku={},list=[];list.push(obj),vm.skuinfo[0].image&&(sku.image=vm.skuinfo[0].image[key]),sku.sku_id=0,sku.with_hold_quantity="",sku.price=0,sku.quantity=0,sku.outer_id="",vm.checkCurrentSku(currentvid),vm.isoriginal&&(sku=vm.tempproperties),sku.properties_name_list=list,vm.deliverProductLocal.skus.push(sku)}if(vm.tempSkus=angular.copy(vm.deliverProductLocal.skus),vm.deliverProductLocal.skus=[],0==vm.skuinfo[0].value.length){var v={v:""};init(v,0)}else angular.forEach(vm.skuinfo[0].value,function(v,key){init(v,key)})},lowPrice:function(skus){if(null!=skus&&(vm.deliverProductLocal.unit_price||(vm.deliverProductLocal.unit_price={now:0,origin:+vm.deliverProductLocal.origin}),skus.length)){var tmp=[];angular.forEach(skus,function(sku){sku&&sku.price?tmp.push(sku.price):tmp.push("")}),vm.deliverProductLocal.unit_price.now=Math.min.apply(null,tmp)}vm.checkField()},formatFloat:function(){vm.deliverProductLocal&&vm.deliverProductLocal.skus&&angular.forEach(vm.deliverProductLocal.skus,function(val){val.price=parseFloat(val.price)})},totleCount:function(skus){var totalcount=0;skus&&(angular.forEach(skus,function(sku){sku&&sku.quantity&&(totalcount+=parseInt(sku.quantity))}),vm.deliverProductLocal.num=parseInt(totalcount),vm.checkField())},changeMoneyType:function(moneytype){vm.baseinfo.currentmoneytype=moneytype,vm.local.baseinfo.moneytype=moneytype}}),vm.init()}])});
