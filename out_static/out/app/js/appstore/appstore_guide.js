"use strict";define(function(require){var server=require("common/services/server"),app=require("app");require("common/services/appstoreService"),app.controller("appstoreGuideCtrl",["$scope","$modal","$state","navconfig","utils","config","http","appStoreService",function($scope,$modal,$state,navconfig,utils,config,http,appStoreService){var vm=$scope.vm={};angular.extend(vm,{init:function(guid,user_id){this.guid=guid,this.user_id=user_id,vm.getBuyInfo(),vm.getRemain()},getRemain:function(){var androidurl=config.getAPI("getstoreinfo.appstoreremain").replace("{client_key}",1);http(androidurl).then(function(resp){resp.result instanceof Array&&!resp.result.length?vm.android_new=!0:vm.android_new=!1});var iosurl=config.getAPI("getstoreinfo.appstoreremain").replace("{client_key}",2);http(iosurl).then(function(resp){resp.result instanceof Array&&!resp.result.length?vm.ios_new=!0:vm.ios_new=!1})},getBuyInfo:function(){vm.loading=!1;var url=config.getAPI("template_system.appstorebuyinfo").replace("{product_type}","on_shelf");http(url).then(function(resp){resp&&!+resp.error_code&&angular.forEach(resp.result.data,function(product){product.name.indexOf("iOS")>-1&&product.name.indexOf("更新")>-1?vm.productCache.ios_update=product:product.name.indexOf("安卓")>-1&&product.name.indexOf("首次")>-1?vm.productCache.android_new=product:product.name.indexOf("安卓")>-1&&product.name.indexOf("更新")>-1?vm.productCache.android_update=product:product.name.indexOf("iOS")>-1&&(vm.productCache.ios_new=product)}),vm.loading="complete"})["catch"](function(e){vm.loading="complete"})},productCache:{},appStoreBuy:function(flag){var productId=void 0,productType=void 0;if("ios"==flag?(productId=vm.ios_new?vm.productCache.ios_new.id:vm.productCache.ios_update.id,productType=vm.ios_new?vm.productCache.ios_new.type:vm.productCache.ios_update.type):(productId=vm.android_new?vm.productCache.android_new.id:vm.productCache.android_update.id,productType=vm.android_new?vm.productCache.android_new.type:vm.productCache.android_update.type),productId){var host=server.host.split("http://")[1]+"storerecord",url=server.service_store_url+"/client/purchase?plat=dingdone&channel="+server.service_store_channel+"&product_type="+productType+"&product_id="+productId+"&user_id="+vm.user_id+"&appid="+vm.guid+"&backUrl="+host;console.log(url,"url"),location.href=url}}}),$scope.$on("checkApp",function(event,first_appinfo){vm.init(first_appinfo.guid,first_appinfo.user_id)})}])});