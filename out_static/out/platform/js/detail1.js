$(function(){function queryPids(){$(".setup-promote-box").html(""),$("tbody",$(".table-pid")).html(""),$.ajax({url:"/api/user/user/pid/list",type:"POST",data:{times:URLPrefix.times,url_sign:URLPrefix.url_sign,member_token:URLPrefix.token},dataType:"json",success:function(data){if(0==data.info.status){var html="",tableHtml="";data.data.items&&0<data.data.items.length&&($(".setup-promote-box").show(),data.data.item&&(html=html+'<p data-pid="'+data.data.item.pid+'" data-build="">'+data.data.item.pid_name+" | "+data.data.item.pid+'<i class="imageicon selected-down-icon"></i></p>'),html+="<ul>",$.each(data.data.items,function(i,item){html=html+'<li data-pid="'+item.pid+'" data-name="'+item.pid_name+'">'+item.pid_name+"</li>",tableHtml=tableHtml+"<tr><td>"+item.pid_name+"</td><td>"+item.pid+'</td><td><a data-id="'+item.user_pid_id+'" class="btn btn-outline-secondary btn-sm btn-del-pid">删除</a></td></tr>'}),html+="</ul>",$(".setup-promote-box").html(html),$("tbody",$(".table-pid")).html(tableHtml))}}})}function templateAll(){template(goods_info.qqTemplate,".QQ-template"),template(goods_info.wechatTemplate,".wechat-template"),template(goods_info.template,".choose-model")}function template(desc,dom){$(dom).find(".promote-content-left img").attr("src",goods_info.pic_url)}$(".copyBtn").on("click",function(o){$this=$(this);var clipboardBtn=new ClipboardJS(".copyBtn",{target:function(trigger){switch($(trigger).attr("data-type")){case"QQ":$copyContentDom=$(".QQ-template");break;case"wechat":$copyContentDom=$(".wechat-template");break;default:$copyContentDom=$(".choose-model")}return $copyContentDom.find(".promote-content-right p").attr("contenteditable",!1),$copyContentDom.find(".promote-muban")[0]}});clipboardBtn.on("success",function(e){e.clearSelection(),clipboardBtn.destroy(),layer.msg("复制成功",{time:2e3})}),clipboardBtn.on("error",function(e){})}),$.post(URLPrefix.api_url+"/api/common/goods/viewDetail",{num_iid:goods_info.item_id,times:URLPrefix.times,url_sign:URLPrefix.url_sign,member_token:URLPrefix.token},function(res){res.data.content&&$(".choose-model").find(".promote-content-right").find("p").html(res.data.content)}),$(".buildBtn").on("click",function(o){$this=$(this);var $p=$this.parent(".setup-promote").find(".setup-promote-box p");if($p.length<=0)return layer.confirm("请先设置推广位",{btn:["确认"]},function(){}),!1;var pid=$p.attr("data-pid");$.post(URLPrefix.api_url+"/api/common/goods/transform",{num_iid:goods_info.item_id,activity_id:goods_info.activity_id,d_title:goods_info.d_title,title:goods_info.title,comment:goods_info.desc,pic_url:goods_info.pic_url,pid:pid,template_type:$this.data("type"),times:URLPrefix.times,url_sign:URLPrefix.url_sign,member_token:URLPrefix.token},function(res){0==res.info.status&&res.data.content&&($this.closest(".promote-content").find(".promote-content-right").find("p").html(res.data.content),$this.closest(".promote-content").find(".promote-content-left").find("img").attr("src",res.data.pic_url),$this.prev(".copyBtn").show(),$this.hide(),layer.msg("文案生成成功",{time:2e3}))})}),queryPids(),$(".add_pid").click(function(e){$this=$(this),$this.attr("disabled","disabled"),$this.text("添加中...");var pid_name=$("#pid_name").val(),pid_pid=$("#pid_pid").val();"0"!=pid_pid&&""!=pid_pid&&null!=pid_pid?$.ajax({url:"/api/user/user/pid/update",type:"POST",data:{name:pid_name,pid:pid_pid,times:URLPrefix.times,url_sign:URLPrefix.url_sign,member_token:URLPrefix.token},dataType:"json",success:function(data){0==data.info.status?(queryPids(),$("#pid_name").val(""),$("#pid_pid").val(""),layer.msg("恭喜，生成已成功！",{icon:1})):layer.msg(data.info.status_err,{icon:2}),$this.removeAttr("disabled"),$this.text("添加")}}):(layer.msg("抱歉，pid不能为空！",{icon:2}),$this.removeAttr("disabled"),$$this.text("添加"))}),$(".setup-promote-box").click(function(event){var $this=$(this),$target=$(event.target);if($target.is("li")){var user_pid=$target.data("pid"),user_name=$target.data("name");$("p",$this).html(user_name+" | "+user_pid+'<i class="imageicon selected-down-icon"></i>'),$("p",$this).attr("data-pid",user_pid)}}),$(".table-pid").click(function(event){$(this);var $target=$(event.target);if($target.is(".btn-del-pid")){var user_pid_id=$target.data("id");"0"!=user_pid_id&&""!=user_pid_id&&null!=user_pid_id&&$.ajax({url:"/api/user/user/pid/delete",type:"POST",data:{id:user_pid_id,times:URLPrefix.times,url_sign:URLPrefix.url_sign,member_token:URLPrefix.token},dataType:"json",success:function(data){queryPids()}})}}),$(".choose-model-tit").click(function(event){$(this);var $target=$(event.target);if($target.is("p")){$("p",this).removeClass("choose-model-active"),$target.addClass("choose-model-active");var type=$target.data("type");$(".promote-box").hide(),1==type?$(".QQ-template,.wechat-template").show():$(".choose-model").show()}}),$("#qrcode_btn").on("click",function(o){$this=$(this);var $p=$this.parent(".setup-promote").find(".setup-promote-box p");if($p.length<=0)return layer.confirm("请先设置推广位",{btn:["确认"]},function(){}),!1;var pid=$p.attr("data-pid");$.post(URLPrefix.api_url+"/api/common/goods/transform",{num_iid:goods_info.item_id,activity_id:goods_info.activity_id,d_title:goods_info.d_title,title:goods_info.title,comment:goods_info.desc,pic_url:goods_info.pic_url,pid:pid,template_type:"weixin",times:URLPrefix.times,url_sign:URLPrefix.url_sign,member_token:URLPrefix.token},function(res){if(res.data.content){var img=new Image;img.src=goods_info.pic_url,img.onload=function(){var goods_title=res.data.goods.goods.d_title?res.data.goods.goods.d_title:res.data.goods.goods.title,type="B"==res.data.goods.user_type?"tianmao":"taobao",qcode_url="https://fdhdrhjy34265.kuaizhan.com/?word="+res.data.goods.click.tao_token.replace(new RegExp("￥","gm"),"")+"&image="+goods_info.pic_url+"&kl=(zSVb30Krk)";$(".qrcode-box .qrleft-bottom div img").attr("src","//code.youdanhui.com/?w=5&url="+encodeURIComponent(qcode_url)),$(".qrcode-box .qr-left-img").attr("src",goods_info.pic_url),$(".qrcode-box .qrleft-top p").html('<i class="imageicon '+type+'"></i>'+goods_title),$(".qrcode-box .qrleft-top li").eq(0).find("span").text(res.data.goods.price.buy_price),$(".qrcode-box .qrleft-top li").eq(1).find("span").text(res.data.goods.price.price),$(".qrcode-box .qrleft-top li").eq(2).find("span").text(res.data.goods.price.volume),$(".qrcode-box .qrleft-top li").eq(3).find("span em").text(parseInt(res.data.goods.coupon.coupon_money)),$(".qrcode-box .qrleft-bottom p span").eq(1).text(res.data.goods.goods.comment),$(".copy-qrleft").html(""),$(".copy-qrleft").append($(".qr-left").clone()),domtoimage.toJpeg($(".copy-qrleft .qr-left")[0],{bgcolor:"#fff",quality:.9}).then(function(base64){base64=base64.replace("data:image/jpeg;base64,",""),$.post(URLPrefix.api_url+"/api/uploadify/uploadImg",{base64:base64,times:URLPrefix.times,url_sign:URLPrefix.url_sign,member_token:URLPrefix.token},function(res){res.data.item.img&&($(".qrcode-build-img img").attr("src",res.data.item.img),$(".qr-right a").attr("href",res.data.item.img),$("#quanModalLong").modal("toggle"))})})},img.onerror=function(){layer.msg("图片加载失败，请稍后重试",{time:2e3})}}})}),$(".copyimg-btn").on("click",function(o){$this=$(this);var clipboardBtn=new ClipboardJS(".copyimg-btn",{target:function(trigger){return $(".qrcode-build-img")[0]}});clipboardBtn.on("success",function(e){e.clearSelection(),clipboardBtn.destroy(),layer.msg("复制成功",{time:2e3})}),clipboardBtn.on("error",function(e){})}),$("ul li",$(".choose-mainimg")).on("click",function(){if($this=$(this),!$this.hasClass("selected-active")){$("ul li",$(".choose-mainimg")).removeClass("selected-active"),$this.addClass("selected-active");var src=$.trim($this.children(".small-goodsimg").children("img").attr("data-src"));goods_info.pic_url=src,templateAll()}}),$(".changeIntro li").on("click",function(){if($this=$(this),!$this.hasClass("choose-copy-active")){$(".changeIntro li").removeClass("choose-copy-active"),$this.addClass("choose-copy-active");var text=$.trim($this.children("span").text());console.log(text),goods_info.desc=text,templateAll()}})});