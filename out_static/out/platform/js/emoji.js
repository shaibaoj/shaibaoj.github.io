var sdEditorEmoj={emojiconfig:{qq:{name:"QQ表情",path:"emoji/",imgName:["1.gif","2.gif"],alias:["微笑","伤心"],title:["[Smile]","[Grimace]"]}},emojiRealTimeData:[],Init:function(options){$(".faceDivBox");var faceDiv=$(".faceDiv"),div=$("#content"),isAnimate=!1,emojiContainer=faceDiv.find(".emoji-box"),emojiconfig=options;div=document.getElementById("content");if(0==$(".faceDiv span").length){var num=0,imgName="";for(var emojilist in emojiconfig){var maxNum=Object.keys(emojiconfig[emojilist].alias).length-1,emclassf="em"+ ++num+"-";emojiContainer.append('<section class="for-'+emojilist+'"></section>'),faceDiv.find(".emoji-tab").append('<a href="javascript:void(0);" data-target="for-'+emojilist+'">'+emojiconfig[emojilist].name+"</a>");for(var i=0;i<=maxNum;i++){switch(imgName=(imgName=emojiconfig[emojilist].imgName[i]).substring(0,imgName.length-4),emclassf){case"em1-":emclass="em1-"+imgName;break;case"em2-":emclass="em7-"+imgName;break;case"em3-":emclass="em8-"+imgName;break;case"em4-":emclass="em4-"+imgName;break;case"em5-":emclass="em3-"+imgName;break;case"em6-":emclass="em2-"+imgName;break;case"em7-":emclass="em6-"+imgName;break;case"em8-":emclass="em10-"+imgName;break;case"em9-":emclass="em12-"+imgName;break;case"em10-":emclass="em5-"+imgName;break;case"em11-":emclass="em9-"+imgName;break;case"em12-":emclass="em11-"+imgName}if(void 0!==emojiContainer.find(".for-"+emojilist)){var c='<a unselectable="on" href="javascript:void(0);" class="embox"><span data-src="'+emojiconfig[emojilist].path+emojiconfig[emojilist].imgName[i]+'" class="em '+emclass+'" data-alias="'+(null==emojiconfig[emojilist].alias[i]?"":emojiconfig[emojilist].alias[i])+'" title="'+(null==emojiconfig[emojilist].title[i]?emojiconfig[emojilist].empty:emojiconfig[emojilist].title[i])+'">'+emojiconfig[emojilist].alias[i]+"</span></a>";emojiContainer.find(".for-"+emojilist).append(c)}}}}$(".contentBox,.faceDiv").click(function(){return!1}),$(".faceDiv").click(function(){div.focus()}),$(".tab-pre").click(function(){if(isAnimate)return!1;isAnimate=!0;var tabBox=$(".emoji-tab"),aNum=tabBox.find("a").length,tabBoxMaxMTop=-352*parseInt(aNum/8),mtop=parseInt(tabBox.css("marginTop"));if(0!=mtop){var cTop=mtop+352+"px";tabBox.animate({marginTop:cTop},300,function(){isAnimate=!1})}else tabBoxMaxMTop+="px",tabBox.animate({marginTop:tabBoxMaxMTop},300,function(){isAnimate=!1});return!1}),$(".tab-next").click(function(){if(isAnimate)return!1;isAnimate=!0;var tabBox=$(".emoji-tab"),aNum=tabBox.find("a").length,tabBoxMaxMTop=-352*parseInt(aNum/8),mtop=parseInt(tabBox.css("marginTop"));if(tabBoxMaxMTop<mtop){var cTop=mtop-352+"px";tabBox.animate({marginTop:cTop},300,function(){isAnimate=!1})}else tabBox.animate({marginTop:"0px"},300,function(){isAnimate=!1});return!1})},insertEmoji:function(src,alias,title){if(window.getSelection){var sel=window.getSelection(),newImg=document.createElement("img");if(newImg.src=src,newImg.alt=alias,newImg.title=title,newImg.onload=function(){$(this).attr("data-alias",alias)},sel&&1===sel.rangeCount&&sel.isCollapsed)(range=sel.getRangeAt(0)).insertNode(newImg),range.collapse(!1),sel.removeAllRanges(),sel.addRange(range);else sel&&1===sel.rangeCount&&!sel.isCollapsed&&((sel=sel.getRangeAt(0)).deleteContents(),sel.insertNode(newImg),sel.collapse(!1))}else if(document.selection){var range;""!=(range=document.selection.createRange())&&range.pasteHTML('<img src="'+src+'" data-alias="'+alias+'" title="'+title+'"/>'),div.focus()}},bindClickImg:function(){var faceDiv=$(".faceDiv"),div=$("#content");faceDiv.find(".emoji-box section").css("display","none").eq(0).css("display","block"),faceDiv.find(".emoji-tab a").eq(0).addClass("active"),faceDiv.find(".emoji-box img,.emoji-box .embox").on("click",function(){div.focus(),function(el){if("IMG"==el.prop("tagName"))var imgThis=el;else imgThis=el.find("span").eq(0);var textAreaInfo=$("#content"),imgArea=imgThis.attr("data-src"),imgAlias=imgThis.attr("data-alias"),imgTitle=imgThis.attr("title");imgArea=imgArea||imgThis.attr("src"),"DIV"===textAreaInfo[0].nodeName?sdEditorEmoj.insertEmoji(imgArea,imgAlias,imgTitle):textAreaInfo.append("["+imgTitle+"]");for(var cu,rtDate=sdEditorEmoj.emojiRealTimeData,rtLength=rtDate.length,addNum=!0,i=0;i<rtLength;i++)if((cu=rtDate[i]).alias==imgAlias){cu.num=cu.num+1,addNum=!1;break}if(1==addNum){var objDate={};objDate.imgUrl=imgArea,objDate.title=imgTitle,objDate.alias=imgAlias,objDate.num=1,rtDate.push(objDate)}addNum=!0}($(this)),isPlace("content")}),faceDiv.find(".emoji-tab a").on("click",function(){$(this).parent().parent().prev().find("section").hide(),faceDiv.find(".emoji-box ."+$(this).attr("data-target")).show(),faceDiv.find(".emoji-tab a").removeClass("active"),this.className+=" active",$(this).parent().parent().parent();var faceDivHeight=faceDiv.height(),nowSectionClass="."+$(this).attr("data-target");return faceDivHeight<$(nowSectionClass).height()?faceDiv.addClass("isScrolly"):faceDiv.removeClass("isScrolly"),!1})},hotEmoji:function(){ajaxGet("/json/popular.json",{},function(res){if(0==res.error){for(var sectionBox,data=res.data,imgAll="",dataNum=data.length,i=0;i<dataNum;i++)imgAll+='<img src="'+data[i].Img+'" data-alias="'+(null==data[i].emoji?"":data[i].emoji)+'" title="'+(null==data[i].title?"":data[i].title)+'" />';sectionBox='<section class="for-hot">'+imgAll+"<section>",$(".emoji-tab").prepend('<a href="javascript:void(0);" data-target="for-hot">热门表情</a>'),$(".emoji-box").prepend(sectionBox),sdEditorEmoj.bindClickImg()}},function(){})}};function getCursortPosition(ctrl){var CaretPos=0;if(document.selection){ctrl.focus();var Sel=document.selection.createRange();Sel.moveStart("character",-ctrl.value.length),CaretPos=Sel.text.length}else!ctrl.selectionStart&&"0"!=ctrl.selectionStart||(CaretPos=ctrl.selectionStart);return CaretPos}function setCaretPosition(ctrl,pos){if(ctrl.setSelectionRange)ctrl.focus(),ctrl.setSelectionRange(pos,pos);else if(ctrl.createTextRange){var range=ctrl.createTextRange();range.collapse(!0),range.moveEnd("character",pos),range.moveStart("character",pos),range.select()}}function numLimit(){var content;if(divEmpty("content"),"0"==(content=$("#content")).text().trim().length)return $("#remark5").html(""),$("#remark5").val(""),!0;var div=content.find("div"),divnum=div.length;if(divnum<3)return layer.msg("朋友圈文案最少也写上3行嘛，这样内容才充实哦"),!1;if(7<divnum)return layer.msg("朋友圈文案最好保持在7行以内，才显的不那么繁琐呦"),!1;for(var msg="",i=0;i<divnum;i++){20<div.eq(i).text().length+div.eq(i).find("img").length&&(msg+="<p>第"+(i+1)+"行的字节超过20了呦，请您检查调整下</p>")}return""!=!msg||(msgon="<div class='wx_msg'><p>朋友圈文案编辑不规范提示<p>"+msg+"</div>",layer.msg(msgon),!1)}function divEmpty(id){for(var divc,div=$("#"+id).find("div"),divnum=div.length,i=0;i<divnum;i++)"0"==(divc=div.eq(i)).text().trim().length&&divc.remove()}function editEmpty(event){var t=$(".contentBox");if(t.text().length<1){t.html("<div><br></div>");var i=void 0,A=t.html().toLowerCase().trim();A&&"<br>"!==A||(i="<div><br></div>",t.html(""),t.append(i),setCaretPosition(conId,10))}else sortFormat("content")}function isPlace(id){var len,$this;len=($this=$("#"+id)).text().length,imglen=$this.find("img").length,0<len||0<imglen?$this.removeClass("place"):$this.addClass("place")}function sortFormat(id){var img,imglen,conId=document.getElementById(id),$con=$("#content"),imgAll=$con.find("img"),arrImg=[];imglen=imgAll.length;for(var i=0;i<imglen;i++)img=imgAll.eq(i),imgSrc=img.attr("src"),(-1<imgSrc.indexOf("www.fuhaodq.com")||-1<imgSrc.indexOf("img.xuandan.com/emoji/"))&&(img.after("[emoji16]"),img="<img src='"+imgSrc+"' alt='"+(null==img.attr("alt")?"":img.attr("alt"))+"'  title='"+(null==img.attr("title")?"":img.attr("title"))+"' data-alias='"+img.attr("data-alias")+"' />",arrImg.push(img));var str,arrnum,arrText,newdiv="";arrnum=(arrText=(str=(str=conId.innerText).replace(/^(\n+)/g,"").replace(/(\n)+/g,"\n").replace(/\n$/g,"")).split("\n")).length;for(i=0;i<arrnum;i++)newdiv+="<div>"+arrText[i]+"</div>";conId.innerHTML=newdiv,str=$con.html();for(var reg=/\[emoji16\]/g,arrEmoji=[],arrIndex=0;arrEmoji=reg.exec(str);)str=str.replace(arrEmoji[0],arrImg[arrIndex]),arrIndex++;$con.html(str),keepLastIndex(id)}function keepLastIndex(id){var obj=document.getElementById(id);if(window.getSelection)obj.focus(),(range=window.getSelection()).selectAllChildren(obj),range.collapseToEnd();else if(document.selection){var range;(range=document.selection.createRange()).moveToElementText(obj),range.collapse(!1),range.select()}}function fHandle(){var str,con=$("#content");str=(str=(str=(str=con.html()).replace(/\r\n/g,"<br>")).replace(/\n/g,"<br>")).replace(/(^\s+)|(\s+$)/g,""),con.html(str)}$(document).ready(function(){"0"==$(".imgBtnf").length?(sdEditorEmoj.Init(emojiconfig),sdEditorEmoj.hotEmoji()):$(".imgBtnf").one("click",function(){$(this).removeClass("imgBtnf"),sdEditorEmoj.Init(emojiconfig),sdEditorEmoj.hotEmoji()}),new ClipboardJS(".infoCopy").on("success",function(e){layer.msg("复制成功")}),$(".infoCopy").click(function(event){var contentVal,contentBoxV=$(".contentBox").html();contentVal=$("#contentVal");contentBoxV=(contentBoxV=(contentBoxV=contentBoxV.replace(/(<br>|<br\/>)(\s*)<\/div>/g,"</div>")).replace(/(<br>|<br\/>)(\s*)<\/p>/g,"</p>")).replace(/(<div>(\s+)<\/div>)|(<p>(\s*)<\/p>)/g,""),contentVal.html(contentBoxV),0==contentVal.find(".newLine").length&&contentVal.find("div").eq(0).before('<div class="newLine"></div>');for(var num=contentVal.find("img").length,i=0;i<num;i++){var imgC=contentVal.find("img").eq(i);imgC.after(imgC.attr("data-alias"))}contentVal.find("img").remove();var nowT=contentVal.html();contentVal.html(nowT)}),$(".contentBox").focus(function(){$(this).parent().addClass("clicked")}).blur(function(){$(this).parent().removeClass("clicked");var wxText="";wxText=(wxText=$(this).html()).replace(/(<br>|<br\/>)(\s*(<br>|<br\/>))+/g,"<br>"),$(".wxText").val(wxText),$("#remark5").val(wxText),$("#remark5").html(wxText)}),$(".contentBox").on("input propertychange",function(){isPlace("content")}),$(".em11-bqfh130,.em11-bqfh131").parent().remove()}),$("#content").on("keyup",function(event){var t=$(this),conId=document.getElementById("content");if(8===event.keyCode){var i=void 0,A=t.html().toLowerCase().trim();A&&"<br>"!==A||(i="<div><br></div>",t.html(""),t.append(i),setCaretPosition(conId,10))}}).on("keydown",function(event){var t=$(this);if(8===event.keyCode)return"<div><br></div>"===t.html().toLowerCase().trim()?void event.preventDefault():void 0}).on("mouseup",function(){var t=$(this),conId=document.getElementById("content");"<div><br></div>"==t.html()&&setCaretPosition(conId,6)}).on("paste",function(){setTimeout(function(){sortFormat("content")},100)});