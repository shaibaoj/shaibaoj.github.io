"use strict";
var url = function(a) {
	return (basepath || '/') + a
};
if (typeof dialog === 'undefined') {
	var dialog = function(d, f) {
		f = f || {};
		var g = f.close ? f.close : (f.close !== false ? '关闭' : false);
		var h = (f.feedback !== undefined && f.feedback === true) ? 'modal-opin'
				: false;
		var i = f.confirm ? f.confirm : (f.confirm !== false ? '确认' : false);
		var j = f.size || '';
		switch (j) {
		case 'lg':
			j = ' style="width:700px"';
			break;
		case 'sm':
			j = ' style="width:500px"';
			break;
		case 'xs':
			j = ' style="width:400px"';
			break;
		default:
			if (/^\d+(?:%|px)$/.test(j)) {
				j = ' style="width:' + j + '"'
			}
		}
		var k = [
				'<div class="modal fade ' + h
						+ '" tabindex="-1"><div class="modal-dialog"' + j
						+ '><div class="modal-content">',
				'<div class="modal-header">' ];
		if (f.logo) {
			k.push('<div class="logo"><img src="' + basepath + 'v2/img/'
					+ (h !== false ? 'opin-head.png' : 'dialog-logo.png')
					+ '" width="125" height="52"></img></div>')
		}
		if (g) {
			k
					.push('<div class="bclose"><a class="close" data-dismiss="modal">&times;</a></div>')
		}
		k.push([
				'<h4 class="modal-title">' + (f.title || '提示') + '</h4></div>',
				'<div class="modal-body text-center">' + d + '</div>',
				'<div class="modal-footer">' ].join(''));
		if (i) {
			k.push('<button type="button" class="btn btn-primary">' + i
					+ '</button>')
		}
		if (g) {
			k
					.push('<button type="button" class="btn btn-default" data-dismiss="modal">'
							+ g + '</button>')
		}
		k.push('</div></div></div></div>');
		var l = $(k.join('')), dContent = l
				.find('> div.modal-dialog > div.modal-content > div.modal-body');
		return new function() {
			this.open = function(a, b, c) {
				l
						.modal({
							backdrop : (typeof f.backdrop === 'undefined' || f.backdrop) ? true
									: 'static',
							keyboard : false,
							show : false
						});
				l
						.find(
								'> div.modal-dialog > div.modal-content > div.modal-footer > button.btn-primary')
						.click(function(e) {
							if (typeof a === 'function') {
								a.call(dContent)
							} else {
								l.modal('hide')
							}
						});
				if (typeof b === 'function') {
					l.on('shown.bs.modal', function() {
						b.call(dContent)
					})
				}
				l.on('hidden.bs.modal', function() {
					if (typeof c === 'function') {
						c.call(dContent)
					}
					l.remove()
				});
				l.modal('show')
			};
			this.close = function() {
				l.modal('hide')
			}
		}
	}
}
if (typeof preloader === 'undefined') {
	var preloader = function(a) {
		var b = [], i;
		for (i = 0; i < 5; ++i) {
			b.push('<span></span>')
		}
		a.empty().append(b.join('')).addClass('preloader');
		return new function() {
			this.remove = function() {
				a.empty().removeClass('preloader')
			}
		}
	}
}
if (typeof AddFavorite === 'undefined') {
	var AddFavorite = function(a, b) {
		try {
			window.external.addFavorite(b, a)
		} catch (e) {
			try {
				window.sidebar.addPanel(a, b, "")
			} catch (e1) {
				var d = dialog(
						'<div style="">抱歉，您所使用的浏览器无法完成此操作。<p>加入收藏失败，请进入新网站后使用 <i sytle="color: red;">Ctrl+D</i> 进行添加</p></div>',
						{
							size : 'xs',
							title : ' ',
							backdrop : false,
							logo : true
						});
				d.open(d.close)
			}
		}
	}
}
if (typeof Vue === 'function') {
	Vue.filter('item_price', function(a) {
		if (a === null) {
			return ''
		}
		a = a.toString();
		var b = a.indexOf('.'), int, dec;
		if (b == 0) {
			int = '0';
			dec = a
		} else if (b == -1) {
			int = a;
			dec = '.00'
		} else {
			int = a.substr(0, b);
			dec = a.substr(b)
		}
		return '<i>¥</i><span class="c">' + int + '<small>' + dec
				+ '</small></span>'
	});
	Vue.filter('item_commission', function(a) {
		a = a.toString();
		var b = a.indexOf('.'), int, dec;
		if (b == 0) {
			int = '0';
			dec = a
		} else if (b == -1) {
			int = a;
			dec = '.00'
		} else {
			int = a.substr(0, b);
			dec = a.substr(b)
		}
		return '<span class="c">' + int + '<small>' + dec
				+ '</small></span><i>%</i>'
	})
}
$(function() {
	if ($.fn.datepicker) {
		$.fn.datepicker.dates['en'] = {
			days : [ '星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六' ],
			daysShort : [ '周日', '周一', '周二', '周三', '周四', '周五', '周六' ],
			daysMin : [ '日', '一', '二', '三', '四', '五', '六' ],
			months : [ '一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月',
					'十月', '十一月', '十二月' ],
			monthsShort : [ '1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月',
					'9月', '10月', '11月', '12月' ],
			today : '今日',
			clear : '清除',
			format : 'yyyy-mm-dd',
			titleFormat : 'yyyy MM',
			weekStart : 0
		};
		$('input.input-datepicker, div.input-daterange').datepicker({
			maxViewMode : 2,
			todayHighlight : true,
			todayBtn : 'linked',
			templates : {
				leftArrow : '<i class="fa fa-chevron-left"></i>',
				rightArrow : '<i class="fa fa-chevron-right"></i>'
			}
		})
	}
	if ($.fn.select2) {
		$('select.input-select2').select2({
			minimumResultsForSearch : 20
		})
	}
	if (document.getElementById('header-top')) {
		new Vue({
			el : '#header-top',
			data : {
				count : 0
			},
			ready : function() {
				var b = this, f = function() {
//					$.getJSON(basepath + 'user/sync', function(a) {
//						b.count = a.result;
//						setTimeout(f, 20000)
//					})
				};
				f()
			}
		})
	}
	var g = function(a, b) {
		var c = false;
		function doHide() {
			if (c) {
				b.hide()
			}
		}
		a.hover(function() {
			b.show();
			c = false
		}, function() {
			c = true;
			window.clearTimeout(t);
			var t = window.setTimeout(doHide, 800)
		});
		b.hover(function() {
			c = false
		}, function() {
			c = true;
			window.clearTimeout(t);
			var t = window.setTimeout(doHide, 300)
		})
	};
	g($('.menu'), $('.menu-list'));
	$('.filter-item').hover(function() {
		$(this).addClass('filter-hover')
	}, function() {
		$(this).removeClass('filter-hover')
	});
	$('.top-bor').click(function() {
		$('html,body').animate({
			scrollTop : '0'
		}, 200)
	});
	$('.feed-icon')
			.click(
					function() {
						var f = [
								'<div class="feedback">',
								'<form action="/feedback/suggestion" method="post" enctype="multipart/form-data">',
								'<p class="text-primary text-center mb10">优买吧真诚欢迎您的反馈，以更好的为您服务！</p>',
								'<textarea name="body" rows="5" class="text-sm" placeholder="请简单描述您的意见或建议"></textarea>',
								'<div class="row mt10 mb20">',
								'<div class="col-xs-2 pr0"><div class="thumbnail pd10 mb0 bg-white"><a href="javascript:void(0)"><img src="/v2/img/file-pic.png" class="f-p"><span class="text-sm mt5">上传截图</span><input type="file" name="images[0]"></a></div></div>',
								'<div class="col-xs-2 pr0"><div class="thumbnail pd10 mb0 bg-white"><a href="javascript:void(0)"><img src="/v2/img/file-pic.png" class="f-p"><span class="text-sm mt5">上传截图</span><input type="file" name="images[1]"></a></div></div>',
								'<div class="col-xs-2 pr0"><div class="thumbnail pd10 mb0 bg-white"><a href="javascript:void(0)"><img src="/v2/img/file-pic.png" class="f-p"><span class="text-sm mt5">上传截图</span><input type="file" name="images[2]"></a></div></div>',
								'</div><input name="contact" type="text" class="text-sm" placeholder="为了方便我们进一步与您联系，请填写你的QQ号或邮箱"></form></div>' ];
						dialog(f.join(''), {
							size : 'lg',
							logo : true,
							backdrop : false,
							title : '用户反馈',
							feedback : true
						})
								.open(
										function() {
											var c = new FormData(), body = $(
													'[name="body"]').val(), contact = $(
													'[name="contact"]').val();
											if (body && contact) {
												c.append('body', body);
												c.append('contact', contact);
												var d = dialog(
														'<div id="preloader" style="margin:0 auto;height:50px"></div>',
														{
															size : 'xs',
															close : false,
															confirm : false,
															title : '正在加载'
														});
												d
														.open(
																null,
																function() {
																	preloader(this
																			.find('#preloader'))
																});
												Vue.http
														.post(
																basepath
																		+ 'feedback/suggestion',
																c)
														.then(
																function(a) {
																	var b = a
																			.json();
																	d.close();
																	if (b.code == 1) {
																		dialog(
																				b.message,
																				{
																					size : 'xs',
																					backdrop : false,
																					close : false
																				})
																				.open(
																						function() {
																							window.location
																									.reload()
																						})
																	} else {
																		dialog(
																				b.message,
																				{
																					size : 'xs',
																					backdrop : false,
																					close : false
																				})
																				.open()
																	}
																})
											} else {
												dialog('必填内容不能为空', {
													size : 'xs',
													backdrop : false,
													close : false
												}).open()
											}
										},
										function() {
											$('[type="file"]')
													.change(
															function(e) {
																var c = e.target.files, data = new FormData(), filename = e.target.name;
																data
																		.append(
																				filename,
																				c[0]);
																Vue.http
																		.post(
																				basepath
																						+ 'feedback/uploadify',
																				data)
																		.then(
																				function(
																						a) {
																					var b = a
																							.json();
																					if (b.code == 1) {
																						$(
																								'img.f-p')
																								.eq(
																										b.index)
																								.attr(
																										'src',
																										b.result)
																					} else {
																						dialog(
																								b.message,
																								{
																									size : 'xs',
																									backdrop : false,
																									close : false
																								})
																								.open()
																					}
																				})
															})
										})
					});
	if ($('#products').length > 0) {
		var h = $('#products'), rows = parseInt(h.attr('data-rows'), 10) || 0, count = parseInt(
				h.attr('data-count'), 10) || 0, current = parseInt(h
				.attr('data-page'), 10) || 0, waterfallCount = parseInt(h
				.attr('data-waterfall-count'), 10) || 0, url = h
				.attr('data-url')
				|| undefined, list = h.attr('data-list') || {}, componentsList = {};
		if (waterfallCount > 0) {
			componentsList = {
				'waterfall' : Waterfall.waterfall,
				'waterfall-slot' : Waterfall.waterfallSlot
			}
		}
		var i = new Vue({
			el : '#products',
			components : componentsList,
			data : {
				rows : rows,
				count : count,
				current : current,
				isBusy : false,
				loading : true,
				list : JSON.parse(list)
			},
			compiled : function() {
				this.loading = false
			},
			events : {
				pagechange : function(p) {
					if (url != undefined) {
						this.list = '';
						this.loading = true;
						$.ajax({
							url : url,
							data : {
								page : p
							},
							type : 'GET',
							dataType : 'json',
							success : function(a) {
								i.list = a;
								i.loading = false
							}
						})
					}
				},
				'wf-reflowed' : function() {
					this.isBusy = false
				}
			},
			methods : {
				drawHot : function(c, e) {
					var d = dialog('<p>该爆款任务需完成' + e + '单推广，确定要领取任务吗？</p>', {
						title : ' ',
						confirm : '领取任务',
						backdrop : false,
						logo : true
					});
					d.open(function() {
						$.post(basepath + 'ch/hot', {
							id : c
						}, function(a) {
							var b = a.message, code = a.code;
							d.close();
							if (code == 1) {
								dialog(
										'<p>领取成功！领取任务后的7天内需完成' + e
												+ '单的推广，请及时安排推广工作。</p>', {
											title : '领取成功',
											size : 'xs'
										}).open(function() {
									window.location.reload()
								})
							} else {
								dialog('<p>' + b + '</p>', {
									title : '领取失败',
									size : 'xs'
								}).open()
							}
						}, 'json')
					})
				},
				addItems : function() {
					if (!this.isBusy && this.list.length < waterfallCount) {
						this.isBusy = true;
						$.get(basepath + 'ch/hot?type=list&qty='
								+ this.list.length, function(a) {
							i.list.push.apply(i.list, JSON.parse(a))
						})
					}
				},
				shuffle : function() {
					this.list.sort(function() {
						return Math.random() - 0.5
					})
				}
			}
		});
		if (waterfallCount > 0) {
			window.addEventListener('scroll', function() {
				var a = document.documentElement.scrollTop
						|| document.body.scrollTop, footHeight = $('.footer')
						.height();
				if (a + window.innerHeight >= document.body.clientHeight
						- footHeight) {
					i.addItems()
				}
			})
		}
	}
});
